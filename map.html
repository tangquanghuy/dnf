```text

<head>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=Rajdhani:wght@500;600;700&display=swap');
    @import url('https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css');

    :root {
      --bg-color: #fdfbf7;
      --primary: #3B4259;
      --accent: #6C5CE7;
      --accent-light: #A29BFE;
      --gold: #D4AF37;
      --danger: #e94560;
      --text-main: #2D3436;
      --text-sub: #636E72;
      --font-serif: 'Libre Baskerville', serif;
      --font-tech: 'Rajdhani', sans-serif;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    .status-card {
      width: 100%;
      font-family: var(--font-tech);
      color: var(--text-main);
      background-color: var(--bg-color);
      display: flex;
      flex-direction: column;
      position: relative;
    }

    .status-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 300px;
      background-image: var(--class-bg-url, url('https://gitgud.io/Rown/dnf/-/raw/master/background/%E9%AC%BC%E5%89%91.webp'));
      background-repeat: no-repeat;
      background-position: center top;
      background-size: 100% auto;
      z-index: 0;
      pointer-events: none;
      -webkit-mask-image: linear-gradient(to bottom, rgba(0, 0, 0, 1) 0%, rgba(0, 0, 0, 0.5) 55%, transparent 100%);
      mask-image: linear-gradient(to bottom, rgba(0, 0, 0, 1) 0%, rgba(0, 0, 0, 0.5) 55%, transparent 100%);
    }

    .status-card>* {
      position: relative;
      z-index: 1;
    }

    .card-header {
      padding: 15px 15px 12px;
      position: relative;
    }

    .card-header>* {
      position: relative;
      z-index: 1;
    }

    .header-card-glass {
      position: relative;
      background: rgba(255, 255, 255, 0.75);
      padding: 10px 12px;
      border-radius: 16px;
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.5);
      box-shadow: 0 8px 32px rgba(31, 38, 135, 0.1);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .header-right-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2px;
    }

    .world-info-block {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .world-info-row {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 0.8rem;
      font-family: var(--font-tech);
      color: #2D3436;
      font-weight: 500;
      opacity: 0.85;
    }

    .world-info-row i {
      font-size: 0.9rem;
      opacity: 0.6;
    }

    /* 世界信息点击弹出全文 */
    .world-info-row {
      position: relative;
      cursor: pointer;
    }
    .world-info-row span {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .world-info-tip-fixed {
      position: fixed;
      background: rgba(45, 52, 54, 0.96);
      color: #fff;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 600;
      white-space: nowrap;
      z-index: 9999;
      pointer-events: none;
      opacity: 0;
      transform: translateY(-3px);
      transition: opacity 0.15s, transform 0.15s;
      box-shadow: 0 4px 12px rgba(0,0,0,0.25);
    }
    .world-info-tip-fixed.show {
      opacity: 1;
      transform: translateY(0);
    }
    .world-info-tip-fixed::before {
      content: '';
      position: absolute;
      bottom: 100%;
      left: var(--arrow-left, 12px);
      border: 5px solid transparent;
      border-bottom-color: rgba(45, 52, 54, 0.96);
    }

    .world-location {
      max-width: 100px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .quick-nav {
      display: flex;
      gap: 6px;
    }

    .nav-btn {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      border: none;
      background: rgba(255, 255, 255, 0.8);
      color: var(--text-sub);
      font-size: 1.1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
      position: relative;
      user-select: none;
    }

    .nav-btn:hover {
      background: #fff;
      color: var(--accent);
      box-shadow: 0 2px 8px rgba(108, 92, 231, 0.2);
    }

    .nav-btn:active {
      transform: scale(0.92);
    }

    .nav-btn .nav-tip {
      position: absolute;
      top: calc(100% + 8px);
      left: 50%;
      transform: translateX(-50%) translateY(-4px);
      background: rgba(45, 52, 54, 0.98);
      color: #fff;
      padding: 5px 10px;
      border-radius: 6px;
      font-size: 0.7rem;
      font-weight: 600;
      width: max-content;
      z-index: 100;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s, transform 0.2s;
      visibility: hidden;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      white-space: nowrap;
    }

    .nav-btn:hover .nav-tip {
      opacity: 1;
      visibility: visible;
      transform: translateX(-50%) translateY(0);
    }

    .nav-btn .nav-tip::after {
      content: '';
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      border-width: 5px;
      border-style: solid;
      border-color: transparent transparent rgba(45, 52, 54, 0.98) transparent;
    }

    .char-header {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .char-details {
      flex-shrink: 0;
      min-width: 0;
    }

    .avatar {
      width: 78px;
      height: 78px;
      background: linear-gradient(135deg, #f0f0f0, #e8e8e8);
      clip-path: polygon(15% 0, 100% 0, 100% 85%, 85% 100%, 0 100%, 0 15%);
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      position: relative;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1), 0 0 0 2px rgba(255, 255, 255, 0.6);
    }

    .avatar::before {
      content: '';
      position: absolute;
      inset: 2px;
      background: #fff;
      clip-path: polygon(15% 0, 100% 0, 100% 85%, 85% 100%, 0 100%, 0 15%);
    }

    .avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      position: relative;
      z-index: 1;
    }

    .char-details h1 {
      font-family: var(--font-serif);
      font-size: 1.55rem;
      margin: 0;
      color: var(--primary);
      font-style: italic;
      line-height: 1.2;
      text-shadow: 0 1px 6px rgba(255, 255, 255, 0.8);
    }

    .class-tag {
      display: inline-block;
      background: rgba(45, 52, 54, 0.8);
      color: #fff;
      padding: 3px 12px;
      font-size: 0.75rem;
      border-radius: 10px;
      margin-top: 3px;
      letter-spacing: 0.5px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(4px);
    }

    .class-tag span {
      display: block;
      font-weight: 600;
    }

    .hp-container {
      flex: 1;
      min-width: 0;
      max-width: 220px;
    }

    .hp-label {
      font-size: 0.58rem;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: #2d3436;
      margin-bottom: 3px;
      font-weight: 700;
      text-shadow: 0 0 2px rgba(255, 255, 255, 0.8);
    }

    .hp-bar-bg {
      height: 6px;
      background: #e0e0e0;
      border-radius: 3px;
      overflow: hidden;
    }

    .hp-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #ff6b6b, var(--danger));
      border-radius: 3px;
      transition: width 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .hp-text {
      display: flex;
      gap: 2px;
      align-items: baseline;
      margin-top: 2px;
    }

    .hp-current {
      font-family: var(--font-tech);
      font-weight: 700;
      font-size: 0.85rem;
      color: var(--danger);
    }

    .hp-max {
      font-size: 0.65rem;
      color: var(--text-sub);
    }

    .cp-container {
      margin-top: 4px;
    }

    .cp-label {
      font-size: 0.52rem;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: #b8860b;
      margin-bottom: 2px;
      font-weight: 700;
      text-shadow: 0 0 2px rgba(255, 255, 255, 0.8);
    }

    .cp-bar-bg {
      height: 5px;
      background: #e0e0e0;
      border-radius: 3px;
      overflow: hidden;
    }

    .cp-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #f39c12, #f1c40f);
      border-radius: 3px;
      transition: width 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28);
    }

    .cp-text {
      display: flex;
      gap: 2px;
      align-items: baseline;
      margin-top: 1px;
    }

    .cp-current {
      font-family: var(--font-tech);
      font-weight: 700;
      font-size: 0.68rem;
      color: #d4a017;
    }

    .cp-max {
      font-size: 0.55rem;
      color: var(--text-sub);
    }

    .armor-block {
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: pointer;
      position: relative;
      transition: transform 0.2s;
      flex-shrink: 0;
    }

    .armor-block:hover {
      transform: scale(1.05);
    }

    .shield-icon {
      width: 24px;
      height: 28px;
      background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%233B4259' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z'/%3E%3C/svg%3E") no-repeat center;
      background-size: contain;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: var(--font-tech);
      font-weight: bold;
      font-size: 0.7rem;
      color: var(--primary);
      padding-top: 1px;
    }

    .armor-label {
      font-size: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #2d3436;
      margin-top: 1px;
      font-weight: 700;
      text-shadow: 0 0 2px rgba(255, 255, 255, 0.8);
    }

    .bars-section {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-top: 2px;
    }

    .bar-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .bar-label {
      font-size: 0.65rem;
      font-weight: 700;
      color: #2d3436;
      text-shadow: 0 0 2px rgba(255, 255, 255, 0.8);
      min-width: 22px;
      flex-shrink: 0;
    }

    .bar-track {
      flex: 1;
      height: 6px;
      background: #e0e0e0;
      border-radius: 3px;
      overflow: hidden;
      position: relative;
    }

    .bar-track.exp-track {
      clip-path: polygon(0 0, 100% 0, 100% 20%, 97% 100%, 0 100%);
    }

    .bar-fill {
      height: 100%;
      position: absolute;
      top: 0;
      left: 0;
      border-radius: 3px;
      transition: width 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28);
    }

    .bar-fill.exp-fill {
      background: linear-gradient(90deg, #6C5CE7, #00CEC9);
    }

    .bar-value {
      font-size: 0.6rem;
      font-weight: 600;
      color: var(--text-sub);
      white-space: nowrap;
      flex-shrink: 0;
    }

    /* Buff 栏 */
    .buff-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 6px;
      padding-top: 6px;
      padding-left: 2px;
      min-height: 0;
    }

    .buff-icon-item {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      cursor: pointer;
      background: #f8f9fa;
      border: 1px solid #e0e0e0;
      transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
      user-select: none;
    }

    .buff-icon-item:active {
      transform: scale(0.92);
    }

    .buff-icon-item.is-buff {
      background: linear-gradient(135deg, #fffbeb 0%, #fff 100%);
      border: 1px solid #f1c40f;
      color: #f39c12;
      box-shadow: 0 2px 5px rgba(241, 196, 15, 0.15);
    }

    .buff-icon-item.is-debuff {
      background: linear-gradient(135deg, #fff5f5 0%, #fff 100%);
      border: 1px solid #e94560;
      color: #c0392b;
      box-shadow: 0 2px 5px rgba(233, 69, 96, 0.15);
    }

    .buff-icon-item i {
      font-size: 1.4rem;
    }

    .buff-duration-badge {
      position: absolute;
      bottom: -4px;
      right: -4px;
      background: #2D3436;
      color: #fff;
      font-size: 0.55rem;
      padding: 1px 4px;
      border-radius: 4px;
      font-family: var(--font-tech);
      font-weight: 700;
      line-height: 1;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
      z-index: 2;
    }

    .buff-icon-item.is-debuff .buff-duration-badge {
      background: #c0392b;
    }

    .buff-tooltip {
      position: absolute;
      bottom: 115%;
      left: 0;
      transform: translateY(5px);
      background: rgba(45, 52, 54, 0.98);
      color: #fff;
      padding: 8px 10px;
      border-radius: 6px;
      font-size: 0.75rem;
      width: max-content;
      max-width: 150px;
      z-index: 100;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s, transform 0.2s;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      text-align: left;
      visibility: hidden;
      white-space: normal;
      word-break: break-all;
    }

    .buff-icon-item:hover .buff-tooltip {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .buff-tooltip::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 15px;
      border-width: 5px;
      border-style: solid;
      border-color: rgba(45, 52, 54, 0.98) transparent transparent transparent;
    }

    .buff-tooltip-name {
      font-weight: 700;
      color: #ffeaa7;
      margin-bottom: 3px;
      font-size: 0.8rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      padding-bottom: 2px;
      display: block;
    }

    .buff-tooltip-desc {
      color: #dfe6e9;
      line-height: 1.3;
      display: block;
    }

    /* Tab 栏 */
    .tab-section {
      padding: 0 15px 12px;
      display: flex;
      flex-direction: column;
    }

    .tab-bar {
      display: flex;
      gap: 2px;
      padding: 6px 4px;
      margin: 4px 0 0;
      background: rgba(0, 0, 0, 0.03);
      border-radius: 10px;
    }

    .tab-item {
      flex: 1;
      padding: 5px 0;
      border: none;
      background: transparent;
      font-family: var(--font-tech);
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--text-sub);
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 3px;
      position: relative;
      user-select: none;
      letter-spacing: 0.3px;
    }

    .tab-item:hover {
      color: var(--text-main);
      background: rgba(255, 255, 255, 0.5);
    }

    .tab-item.active {
      color: var(--text-main);
      background: #fff;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
    }

    .tab-item i {
      font-size: 0.85rem;
    }

    .tab-content {
      min-height: 80px;
      padding-top: 6px;
    }

    .tab-pane {
      display: none;
      animation: tabFadeIn 0.2s ease;
    }

    .tab-pane.active {
      display: block;
    }

    @keyframes tabFadeIn {
      from {
        opacity: 0;
        transform: translateY(4px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .tab-placeholder {
      text-align: center;
      color: var(--text-sub);
      font-size: 0.75rem;
      padding: 25px 10px;
      opacity: 0.5;
    }

    .tab-placeholder i {
      font-size: 1.5rem;
      display: block;
      margin-bottom: 6px;
      opacity: 0.4;
    }

    /* 技能栏 */
    .skills-section {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .skill-slots-section {
      background: rgba(255, 255, 255, 0.3);
      border-radius: 16px;
      padding: 15px 15px 35px;
    }

    .slots-grid {
      display: flex;
      justify-content: center;
      gap: 12px;
      row-gap: 35px;
      flex-wrap: wrap;
      padding-bottom: 20px;
    }

    .skill-slot-wrapper {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .skill-slot {
      width: 48px;
      height: 48px;
      background: #f1f2f6;
      border: 2px solid #dfe6e9;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .skill-slot:hover {
      border-color: #74b9ff;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .skill-slot.active {
      background: #fff;
      border-color: #0984e3;
    }

    .skill-slot.empty {
      opacity: 0.4;
    }

    .skill-slot.awakening {
      border-color: #fab1a0;
      background: #fff0eb;
      width: 56px;
      height: 56px;
      clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
    }

    .skill-slot.awakening.active {
      border-color: #d63031;
      background: #fff;
    }

    /* 连携奥义技能槽 - 金色六边形 */
    .skill-slot.combo-ultimate {
      border-color: #f0c040;
      background: #fffbf0;
      width: 56px;
      height: 56px;
      clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
    }

    .skill-slot.combo-ultimate.active {
      border-color: #d4a017;
      background: #fff;
    }

    .skill-slot.combo-ultimate.empty {
      opacity: 0.4;
    }

    .skill-slot.combo-ultimate .combo-avatar-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
    }

    .skill-slot.combo-ultimate .combo-svg-icon {
      width: 1.3em;
      height: 1.3em;
    }

    .skill-slot.combo-ultimate .combo-svg-icon path[fill="#000"] {
      fill: transparent;
    }

    .skill-slot.combo-ultimate .combo-svg-icon path[fill="#fff"] {
      fill: #b8860b;
    }

    .skill-slot-name.combo-name {
      color: #b8860b;
    }

    /* 冷却进度遮罩 - 从下往上覆盖 */
    .skill-cooldown-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(180, 180, 180, 0.5);
      z-index: 2;
      clip-path: inherit;
      transition: height 0.3s ease;
      pointer-events: none;
    }

    /* 连携奥义 CP 充能进度 - 从下往上金色填充 */
    .combo-cp-fill {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(240, 192, 64, 0.35);
      z-index: 2;
      clip-path: inherit;
      transition: height 0.3s ease;
      pointer-events: none;
    }
    .combo-cp-fill.cp-full {
      background: rgba(240, 192, 64, 0.5);
    }

    /* 连携奥义选择器 */
    .combo-picker-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      z-index: 200;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .combo-picker-overlay.show { opacity: 1; }

    .combo-picker {
      background: #fff;
      border-radius: 16px;
      width: 280px;
      max-height: 360px;
      overflow: hidden;
      box-shadow: 0 12px 40px rgba(0,0,0,0.15);
      display: flex;
      flex-direction: column;
    }

    .combo-picker-title {
      padding: 12px 16px;
      font-size: 0.85rem;
      font-weight: 700;
      color: #b8860b;
      border-bottom: 1px solid #f0f0f0;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .combo-picker-list {
      overflow-y: auto;
      padding: 8px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .combo-picker-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.15s;
      border: 1px solid transparent;
    }
    .combo-picker-item:hover {
      background: #fffbf0;
      border-color: #f0c040;
    }
    .combo-picker-item.current {
      background: #fffbf0;
      border-color: #d4a017;
    }

    .combo-picker-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      object-fit: cover;
      flex-shrink: 0;
      background: #f1f2f6;
    }
    .combo-picker-avatar-placeholder {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #f1f2f6;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      color: #b2bec3;
      font-size: 1rem;
    }

    .combo-picker-info {
      flex: 1;
      min-width: 0;
    }
    .combo-picker-bond-name {
      font-size: 0.75rem;
      font-weight: 700;
      color: var(--text-main);
      line-height: 1.2;
    }
    .combo-picker-skill-name {
      font-size: 0.65rem;
      color: #b8860b;
      margin-top: 1px;
    }

    .skill-icon {
      font-size: 1.5rem;
      color: #2d3436;
    }

    .skill-icon-svg {
      width: 1.3em;
      height: 1.3em;
      display: inline-block;
      vertical-align: middle;
    }

    .skill-level-badge {
      position: absolute;
      bottom: -5px;
      right: -5px;
      background: #2d3436;
      color: #fff;
      font-size: 0.6rem;
      padding: 1px 4px;
      border-radius: 4px;
      font-weight: 700;
    }

    .skill-slot-name {
      position: absolute;
      top: 100%;
      margin-top: 3px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.6rem;
      color: #636e72;
      white-space: nowrap;
      font-weight: 600;
      max-width: 70px;
      overflow: hidden;
      text-overflow: ellipsis;
      text-align: center;
    }

    .skill-tooltip {
      position: absolute;
      bottom: 100%;
      margin-bottom: 8px;
      left: 50%;
      transform: translateX(-50%) translateY(5px);
      background: rgba(45, 52, 54, 0.98);
      color: #fff;
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 0.75rem;
      width: max-content;
      max-width: 150px;
      z-index: 100;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s, transform 0.2s;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      text-align: center;
      visibility: hidden;
      white-space: nowrap;
    }

    /* ==================== 羁绊列表 (Premium Design) ==================== */
    .bond-section-container {
      display: flex;
      gap: 16px;
      position: relative;
      transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .bond-section-container.mode-detail {
      gap: 8px;
      min-height: 400px;
      /* 详情模式下允许高度自适应 */
      height: auto !important;
    }

    /* 左侧列表：默认宽模式 */
    .bond-list-pane {
      flex: 1;
      overflow-y: overlay;
      /* 现代浏览器 overlay 滚动条 */
      padding-right: 4px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }

    /* 滚动条美化 */
    .bond-list-pane::-webkit-scrollbar {
      width: 4px;
    }

    .bond-list-pane::-webkit-scrollbar-track {
      background: transparent;
    }

    .bond-list-pane::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.1);
      border-radius: 4px;
    }

    .bond-list-pane::-webkit-scrollbar-thumb:hover {
      background: rgba(0, 0, 0, 0.2);
    }

    /* === 紧凑模式 (Compact Mode) === */
    /* 当容器上有 .mode-detail 类时，左侧变窄 */
    .bond-section-container.mode-detail .bond-list-pane {
      flex: 0 0 140px;
      padding: 8px;
      gap: 6px;
      overflow-y: auto;
      overflow-x: hidden;
    }

    /* 列表项卡片 */
    .bond-item {
      position: relative;
      display: flex;
      align-items: center;
      padding: 16px;
      background: white;
      border: 1px solid rgba(0, 0, 0, 0.06);
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
      overflow: hidden;
      min-height: 80px;
    }

    .bond-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.06);
      border-color: rgba(0, 0, 0, 0.1);
    }

    .bond-item.active {
      background: #f8f9fa;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--accent-light);
    }

    .bond-section-container.mode-detail .bond-item:hover {
      background: rgba(0, 0, 0, 0.04);
      transform: none;
    }

    .bond-section-container.mode-detail .bond-item.active {
      background: white;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      border: 1px solid var(--accent-light);
    }

    /* 卡片左侧：头像区域 */
    .bond-item-avatar-box {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      flex-shrink: 0;
      margin-right: 16px;
      position: relative;
      background: #f1f2f6;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    /* 无头像时隐藏头像框 */
    .bond-item-avatar-box.no-avatar {
      display: none;
    }

    .bond-item-avatar-img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .bond-item-avatar-placeholder {
      font-size: 1.2rem;
      color: #b2bec3;
    }

    /* 卡片中间：信息区域 */
    .bond-item-info {
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 100px;
      max-width: 140px;
      transition: opacity 0.2s;
    }

    /* 紧凑模式下隐藏信息区域 */
    .bond-section-container.mode-detail .bond-item-info {
      display: none;
    }

    .bond-item-name {
      font-size: 1rem;
      font-weight: 700;
      color: var(--text-main);
      line-height: 1.2;
    }

    .bond-item-meta {
      font-size: 0.75rem;
      color: var(--text-sub);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .bond-item-tag {
      background: rgba(0, 0, 0, 0.04);
      padding: 1px 6px;
      border-radius: 4px;
      font-size: 0.65rem;
      font-weight: 500;
    }

    /* 心里话区域 - 中间展示，从左边开始 */
    .bond-item-thought {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: flex-start;
      padding: 0;
      padding-right: 12px;
      min-width: 0;
      overflow: hidden;
    }

    .bond-item-thought-text {
      font-size: 0.75rem;
      color: var(--text-sub);
      font-style: italic;
      opacity: 0.7;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }

    .bond-item-thought-text::before {
      content: '"';
      color: rgba(108, 92, 231, 0.4);
      font-style: normal;
      margin-right: 2px;
    }

    .bond-item-thought-text::after {
      content: '"';
      color: rgba(108, 92, 231, 0.4);
      font-style: normal;
      margin-left: 2px;
    }

    /* 紧凑模式下隐藏心里话 */
    .bond-section-container.mode-detail .bond-item-thought {
      display: none;
    }

    /* 卡片右侧：好感度 */
    .bond-item-status {
      display: flex;
      align-items: center;
      gap: 8px;
      padding-left: 12px;
      flex-shrink: 0;
    }

    /* 紧凑模式下隐藏右侧状态 */
    .bond-section-container.mode-detail .bond-item-status {
      display: none;
    }

    /* 紧凑模式下的名称标签 */
    .bond-item-compact-name {
      display: none;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-main);
      text-align: left;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      line-height: 1.2;
    }

    .bond-section-container.mode-detail .bond-item-compact-name {
      display: block;
    }

    .bond-favor-badge {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      font-family: var(--font-tech);
    }

    .bond-favor-badge.positive {
      background: rgba(231, 76, 60, 0.1);
      color: #e74c3c;
    }

    .bond-favor-badge.neutral {
      background: rgba(0, 0, 0, 0.05);
      color: var(--text-sub);
    }

    .bond-favor-badge.negative {
      background: rgba(45, 52, 54, 0.1);
      color: #2d3436;
    }

    /* 紧凑模式下的列表项布局调整 */
    .bond-section-container.mode-detail .bond-item {
      padding: 10px 8px;
      justify-content: flex-start;
      min-height: auto;
      height: auto;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.6);
      border: 1px solid rgba(0, 0, 0, 0.04);
      box-shadow: none;
      flex-direction: row;
      align-items: center;
      gap: 8px;
      overflow: visible;
    }

    .bond-section-container.mode-detail .bond-item.active {
      background: white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      border: 1px solid rgba(108, 92, 231, 0.3);
    }

    /* 紧凑模式下头像尺寸 */
    .bond-section-container.mode-detail .bond-item-avatar-box {
      margin-right: 0;
      width: 40px;
      height: 40px;
      border-radius: 10px;
      flex-shrink: 0;
    }

    /* ==================== 详情面板 (Premium Bento Detail) ==================== */
    .bond-detail-pane {
      flex: 0 0 0;
      /* 默认隐藏 */
      width: 0;
      opacity: 0;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 24px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      border: 1px solid rgba(0, 0, 0, 0.06);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
      pointer-events: none;
    }

    .bond-section-container.mode-detail .bond-detail-pane {
      flex: 1;
      width: auto;
      opacity: 1;
      pointer-events: auto;
      margin-left: 0;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06), 0 0 0 1px rgba(0, 0, 0, 0.02);
      min-height: 380px;
      max-height: 500px;
    }

    /* 详情页布局：Grid */
    .bd-layout {
      height: 100%;
      min-height: 380px;
      display: grid;
      grid-template-rows: auto 1fr;
      overflow: hidden;
    }

    /* 头部 Banner */
    .bd-banner {
      padding: 16px 20px;
      background: linear-gradient(135deg, #fdfbf7 0%, #fff 100%);
      border-bottom: 1px solid rgba(0, 0, 0, 0.04);
      display: flex;
      align-items: center;
      gap: 16px;
      position: relative;
    }

    .bd-close-abs {
      position: absolute;
      top: 16px;
      right: 16px;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: rgba(0, 0, 0, 0.03);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      color: var(--text-main);
    }

    .bd-close-abs:hover {
      background: rgba(0, 0, 0, 0.08);
      transform: rotate(90deg);
    }

    /* 大头像容器 */
    .bd-hero-avatar-container {
      width: 72px;
      height: 72px;
      border-radius: 16px;
      background: #dfe6e9;
      /* 默认灰底 */
      position: relative;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
      flex-shrink: 0;
      overflow: hidden;
      /* group: avatar-group; removed */
    }

    .bd-hero-img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.5s;
    }

    .bd-hero-avatar-container:hover .bd-hero-img {
      transform: scale(1.05);
    }

    .bd-hero-placeholder {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #b2bec3;
      font-size: 2rem;
      background: linear-gradient(135deg, #f5f6fa, #dfe6e9);
    }

    /* 上传遮罩 */
    .bd-upload-mask {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.5rem;
      opacity: 0;
      transition: opacity 0.2s;
      cursor: pointer;
      backdrop-filter: blur(2px);
    }

    .bd-hero-avatar-container:hover .bd-upload-mask {
      opacity: 1;
    }

    /* 角色基础信息 */
    .bd-hero-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 6px;
    }

    .bd-hero-name {
      font-size: 1.5rem;
      font-weight: 800;
      color: var(--text-main);
      font-family: var(--font-serif);
      letter-spacing: -0.5px;
      line-height: 1.1;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .bd-hero-badges {
      display: flex;
      gap: 8px;
      margin-top: 4px;
    }

    .bd-badge {
      font-size: 0.75rem;
      padding: 3px 8px;
      border-radius: 6px;
      font-weight: 600;
      letter-spacing: 0.3px;
      background: rgba(0, 0, 0, 0.04);
      color: var(--text-sub);
    }

    .bd-badge.race {
      background: rgba(108, 92, 231, 0.08);
      color: var(--accent);
    }

    /* 好感度条 Premium */
    .bd-favor-bar-container {
      margin-top: 12px;
      width: 100%;
      max-width: 300px;
    }

    .bd-favor-label {
      display: flex;
      justify-content: space-between;
      font-size: 0.75rem;
      font-weight: 700;
      margin-bottom: 4px;
      color: #e84393;
    }

    .bd-favor-track {
      height: 6px;
      background: rgba(0, 0, 0, 0.05);
      border-radius: 3px;
      overflow: hidden;
    }

    .bd-favor-fill {
      height: 100%;
      background: linear-gradient(90deg, #e74c3c, #c0392b);
      border-radius: 3px;
      transition: width 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    /* 滚动内容区 */
    .bd-scroll-content {
      overflow-y: auto;
      padding: 16px 20px;
    }

    .bd-scroll-content::-webkit-scrollbar {
      width: 4px;
    }

    .bd-scroll-content::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.1);
      border-radius: 3px;
    }

    .bd-bento-grid {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .bd-card {
      background: #fff;
      border-radius: 12px;
      padding: 12px;
      border: 1px solid rgba(0, 0, 0, 0.04);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.02);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .bd-card-title {
      font-size: 0.65rem;
      font-weight: 700;
      color: var(--text-sub);
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 5px;
      margin-bottom: 2px;
    }

    .bd-card-title i {
      font-size: 0.8rem;
      opacity: 0.7;
    }

    .bd-attr-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 5px;
    }

    .bd-attr-card {
      background: #fff;
      border-radius: 8px;
      padding: 8px 2px;
      text-align: center;
      border: 1px solid #eee;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.02);
    }

    .bd-attr-name {
      font-size: 0.55rem;
      color: #666;
      font-weight: 700;
      margin-bottom: 2px;
    }

    .bd-attr-val {
      font-size: 0.9rem;
      font-weight: 700;
      color: var(--primary);
      font-family: var(--font-tech);
    }

    .bd-attr-sub {
      font-size: 0.5rem;
      color: #888;
      margin-top: 2px;
      background: rgba(0, 0, 0, 0.06);
      border-radius: 3px;
      display: inline-block;
      padding: 0 4px;
    }

    .bd-thought-quote {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.8), rgba(255, 255, 255, 0.4));
      border: 1px solid rgba(108, 92, 231, 0.1);
      font-style: italic;
      color: var(--primary);
      text-align: center;
      padding: 14px 20px;
      font-family: var(--font-serif);
      font-size: 0.95rem;
      position: relative;
      border-radius: 12px;
    }

    .bd-thought-quote::before {
      content: '\201C';
      font-size: 2.5rem;
      color: rgba(108, 92, 231, 0.12);
      position: absolute;
      top: -2px;
      left: 8px;
    }

    .bd-thought-quote::after {
      content: '\201D';
      font-size: 2.5rem;
      color: rgba(108, 92, 231, 0.12);
      position: absolute;
      bottom: -16px;
      right: 8px;
    }

    .bd-info-row {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .bd-info-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
      padding: 10px 12px;
      border-radius: 8px;
      background: #f8f9fa;
      font-size: 0.78rem;
    }

    .bd-info-item span:first-child {
      font-weight: 600;
      color: var(--text-sub);
      font-size: 0.68rem;
    }

    .bd-info-item span:last-child {
      font-weight: 500;
      color: var(--text-main);
      line-height: 1.5;
    }

    .bd-list-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .bd-combat-list {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .bd-combat-wrapper {
      width: calc(50% - 3px);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .bd-combat-section {
      margin-bottom: 8px;
    }

    .bd-combat-section:last-child {
      margin-bottom: 0;
    }

    .bd-combat-label {
      font-size: 0.65rem;
      color: var(--text-sub);
      font-weight: 600;
      margin-bottom: 6px;
      padding-left: 2px;
    }

    .bd-combat-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 10px;
      border-radius: 6px;
      background: #f8f9fa;
      font-size: 0.72rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .bd-combat-item:hover {
      background: #f0f1f3;
    }

    .bd-combat-item.expanded {
      background: #eef0f2;
    }

    .bd-combat-item span:first-child {
      font-weight: 600;
      color: var(--text-main);
    }

    .bd-combat-item span:last-child {
      font-weight: 500;
      color: var(--text-sub);
      font-size: 0.65rem;
    }

    .bd-combo-skill {
      background: linear-gradient(135deg, rgba(243, 156, 18, 0.08), rgba(241, 196, 15, 0.04));
      border: 1px solid rgba(243, 156, 18, 0.3);
    }

    .bd-combo-skill:hover {
      background: linear-gradient(135deg, rgba(243, 156, 18, 0.15), rgba(241, 196, 15, 0.08));
    }

    .bd-combo-skill.expanded {
      background: linear-gradient(135deg, rgba(243, 156, 18, 0.18), rgba(241, 196, 15, 0.1));
    }

    .bd-combat-detail {
      background: linear-gradient(135deg, #f8f9fa, #fff);
      border-radius: 8px;
      padding: 10px 12px;
      font-size: 0.7rem;
      border: 1px solid #eee;
      animation: slideDown 0.2s ease;
    }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-5px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .bd-combat-detail-row {
      display: flex;
      padding: 5px 0;
      border-bottom: 1px dashed #eee;
      gap: 8px;
    }

    .bd-combat-detail-row:last-child {
      border-bottom: none;
    }

    .bd-combat-detail-row .label {
      color: var(--text-sub);
      font-weight: 500;
      flex-shrink: 0;
      min-width: 32px;
    }

    .bd-combat-detail-row .value {
      color: var(--text-main);
      font-weight: 600;
      flex: 1;
      line-height: 1.5;
      word-break: break-word;
    }

    /* 效果行特殊处理 - 垂直布局 */
    .bd-combat-detail-row.effect-row {
      flex-direction: column;
      gap: 4px;
    }

    .bd-combat-detail-row.effect-row .value {
      background: rgba(0, 0, 0, 0.02);
      padding: 8px 10px;
      border-radius: 6px;
      font-size: 0.72rem;
      font-weight: 500;
      line-height: 1.6;
    }

    .bd-combat-detail-desc {
      margin-top: 8px;
      padding: 10px 12px;
      background: rgba(0, 0, 0, 0.02);
      border-radius: 8px;
      color: #555;
      font-size: 0.72rem;
      line-height: 1.65;
    }

    .bd-list-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 10px;
      border-radius: 8px;
      background: #f8f9fa;
      font-size: 0.78rem;
    }

    .bd-list-row span:first-child {
      font-weight: 600;
      color: var(--text-sub);
    }

    .bd-list-row span:last-child {
      font-weight: 500;
      color: var(--text-main);
    }

    /* 右侧：详情面板 */

    /* 关闭按钮 (绝对定位) */
    .bd-close-btn {
      position: absolute;
      top: 14px;
      right: 14px;
      width: 28px;
      height: 28px;
      border-radius: 8px;
      background: rgba(0, 0, 0, 0.04);
      border: 1px solid rgba(0, 0, 0, 0.04);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-sub);
      transition: all 0.2s;
      z-index: 5;
    }

    .bd-close-btn:hover {
      background: rgba(233, 69, 96, 0.1);
      border-color: rgba(233, 69, 96, 0.15);
      color: var(--danger);
      transform: rotate(90deg);
    }

    .skill-slot-wrapper:hover .skill-tooltip {
      opacity: 1;
      visibility: visible;
      transform: translateX(-50%) translateY(0);
    }

    .skill-tooltip::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border-width: 5px;
      border-style: solid;
      border-color: rgba(45, 52, 54, 0.98) transparent transparent transparent;
    }

    .no-data-hint {
      text-align: center;
      color: var(--text-sub);
      font-size: 0.75rem;
      padding: 20px 0;
      opacity: 0.6;
    }

    /* ===== 传闻 Tab ===== */
    .rumors-section {
      display: flex;
      flex-direction: column;
      gap: 0;
    }

    .rumor-sub-tabs {
      display: flex;
      gap: 2px;
      padding: 3px;
      margin-bottom: 10px;
      background: rgba(0, 0, 0, 0.03);
      border-radius: 10px;
    }

    .rumor-sub-tab {
      flex: 1;
      padding: 6px 0;
      border: none;
      background: transparent;
      font-family: var(--font-tech);
      font-size: 0.68rem;
      font-weight: 600;
      color: var(--text-sub);
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      user-select: none;
      letter-spacing: 0.3px;
    }

    .rumor-sub-tab:hover {
      color: var(--text-main);
      background: rgba(255, 255, 255, 0.5);
    }

    .rumor-sub-tab.active {
      color: var(--text-main);
      background: #fff;
      box-shadow: 0 1px 6px rgba(0, 0, 0, 0.06);
    }

    .rumor-sub-tab i {
      font-size: 0.8rem;
    }

    .rumor-sub-tab .rumor-count {
      font-size: 0.55rem;
      background: rgba(0, 0, 0, 0.06);
      padding: 1px 6px;
      border-radius: 6px;
      font-weight: 700;
      line-height: 1.3;
    }

    .rumor-sub-tab.active .rumor-count {
      background: rgba(108, 92, 231, 0.1);
      color: var(--accent);
    }

    .rumor-pane {
      display: none;
      animation: tabFadeIn 0.2s ease;
    }

    .rumor-pane.active {
      display: block;
    }

    .rumor-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    /* ---- 街头巷议卡片 ---- */
    .rumor-gossip-card {
      background: rgba(255, 255, 255, 0.82);
      border-radius: 12px;
      padding: 14px 16px 12px;
      border: 1px solid rgba(0, 0, 0, 0.06);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
      transition: all 0.2s;
      cursor: default;
      position: relative;
    }

    .rumor-gossip-card:hover {
      box-shadow: 0 4px 14px rgba(0, 0, 0, 0.06);
      transform: translateY(-1px);
    }

    .rumor-gossip-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 8px;
    }

    .rumor-gossip-title {
      font-size: 0.85rem;
      font-weight: 700;
      color: var(--text-main);
      font-family: var(--font-serif);
      line-height: 1.3;
      flex: 1;
      min-width: 0;
    }

    .rumor-credibility {
      font-size: 0.58rem;
      font-weight: 700;
      padding: 2px 8px;
      border-radius: 10px;
      flex-shrink: 0;
      letter-spacing: 0.5px;
      white-space: nowrap;
      line-height: 1.5;
    }

    .rumor-credibility.cred-low {
      background: rgba(233, 69, 96, 0.1);
      color: #e94560;
      border: 1px solid rgba(233, 69, 96, 0.15);
    }

    .rumor-credibility.cred-mid {
      background: rgba(243, 156, 18, 0.1);
      color: #e67e22;
      border: 1px solid rgba(243, 156, 18, 0.15);
    }

    .rumor-credibility.cred-high {
      background: rgba(0, 184, 148, 0.1);
      color: #00a381;
      border: 1px solid rgba(0, 184, 148, 0.15);
    }

    .rumor-gossip-speaker {
      font-size: 0.7rem;
      color: var(--accent);
      font-weight: 600;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 5px;
      opacity: 0.85;
    }

    .rumor-gossip-speaker i {
      font-size: 0.78rem;
    }

    .rumor-gossip-content {
      font-size: 0.78rem;
      color: var(--text-sub);
      line-height: 1.65;
      font-style: italic;
      padding: 8px 10px;
      background: rgba(0, 0, 0, 0.02);
      border-radius: 8px;
      border-left: 2px solid rgba(108, 92, 231, 0.15);
    }

    /* ---- 情报交易卡片 ---- */
    .rumor-intel-card {
      background: rgba(255, 255, 255, 0.82);
      border-radius: 12px;
      padding: 14px 16px 12px;
      border: 1px solid rgba(0, 0, 0, 0.06);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
      transition: all 0.2s;
      cursor: default;
      position: relative;
    }

    .rumor-intel-card:hover {
      box-shadow: 0 4px 14px rgba(0, 0, 0, 0.06);
      border-color: rgba(0, 0, 0, 0.1);
      transform: translateY(-1px);
    }

    .rumor-intel-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 8px;
    }

    .rumor-intel-title {
      font-size: 0.85rem;
      font-weight: 700;
      color: var(--text-main);
      font-family: var(--font-serif);
      line-height: 1.3;
      flex: 1;
      min-width: 0;
    }

    .rumor-intel-price {
      font-size: 0.72rem;
      font-weight: 700;
      color: #b8860b;
      font-family: var(--font-tech);
      display: flex;
      align-items: center;
      gap: 3px;
      flex-shrink: 0;
      background: rgba(212, 175, 55, 0.12);
      padding: 2px 10px;
      border-radius: 10px;
      border: 1px solid rgba(212, 175, 55, 0.2);
      white-space: nowrap;
    }

    .rumor-intel-price i {
      font-size: 0.82rem;
      color: var(--gold);
    }

    .rumor-intel-seller {
      font-size: 0.7rem;
      color: var(--text-sub);
      font-weight: 600;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .rumor-intel-seller i {
      font-size: 0.78rem;
      opacity: 0.6;
    }

    .rumor-intel-summary {
      font-size: 0.78rem;
      color: var(--text-sub);
      line-height: 1.65;
      padding: 8px 10px;
      background: rgba(0, 0, 0, 0.02);
      border-radius: 8px;
      border-left: 2px solid rgba(0, 0, 0, 0.06);
    }

    .rumor-intel-footer {
      display: flex;
      justify-content: flex-end;
      margin-top: 8px;
    }

    .rumor-intel-buy {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 12px;
      border: 1px solid rgba(212, 175, 55, 0.3);
      border-radius: 8px;
      background: rgba(212, 175, 55, 0.08);
      color: #b8860b;
      font-size: 0.68rem;
      font-weight: 700;
      font-family: var(--font-tech);
      cursor: pointer;
      transition: all 0.2s;
      letter-spacing: 0.3px;
    }

    .rumor-intel-buy:hover {
      background: rgba(212, 175, 55, 0.18);
      border-color: rgba(212, 175, 55, 0.5);
      box-shadow: 0 2px 8px rgba(212, 175, 55, 0.15);
    }

    .rumor-intel-buy:active {
      transform: scale(0.96);
    }

    .rumor-intel-buy i {
      font-size: 0.76rem;
    }

    /* ---- 布告与檄文卡片 ---- */
    .rumor-notice-card {
      background: rgba(255, 255, 255, 0.82);
      border-radius: 12px;
      padding: 14px 16px 12px;
      border: 1px solid rgba(59, 66, 89, 0.1);
      border-left: 3px solid var(--primary);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
      transition: all 0.2s;
    }

    .rumor-notice-card:hover {
      box-shadow: 0 4px 14px rgba(0, 0, 0, 0.06);
      transform: translateY(-1px);
    }

    .rumor-notice-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 6px;
    }

    .rumor-notice-title {
      font-size: 0.85rem;
      font-weight: 700;
      color: var(--text-main);
      font-family: var(--font-serif);
      line-height: 1.3;
      flex: 1;
      min-width: 0;
    }

    .rumor-notice-issuer {
      font-size: 0.6rem;
      font-weight: 700;
      padding: 2px 8px;
      border-radius: 10px;
      background: rgba(59, 66, 89, 0.08);
      color: var(--primary);
      flex-shrink: 0;
      letter-spacing: 0.3px;
      white-space: nowrap;
      border: 1px solid rgba(59, 66, 89, 0.08);
    }

    .rumor-notice-location {
      font-size: 0.66rem;
      color: var(--text-sub);
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 4px;
      opacity: 0.65;
      font-style: italic;
    }

    .rumor-notice-location i {
      font-size: 0.72rem;
    }

    .rumor-notice-content {
      font-size: 0.78rem;
      color: var(--text-main);
      line-height: 1.65;
      opacity: 0.88;
      padding: 8px 10px;
      background: rgba(59, 66, 89, 0.02);
      border-radius: 8px;
    }

    /* ===== 附近的人 Tab ===== */
    .nearby-section {
      display: flex;
      gap: 16px;
      position: relative;
      transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .nearby-section.mode-detail {
      gap: 8px;
    }

    .nearby-list-pane {
      flex: 1;
      overflow-y: overlay;
      padding-right: 4px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .nearby-list-pane::-webkit-scrollbar { width: 4px; }
    .nearby-list-pane::-webkit-scrollbar-track { background: transparent; }
    .nearby-list-pane::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); border-radius: 4px; }

    .nearby-section.mode-detail .nearby-list-pane {
      flex: 0 0 140px;
      padding: 8px;
      gap: 6px;
      overflow-y: auto;
      overflow-x: hidden;
    }

    /* 列表卡片 */
    .nearby-card {
      position: relative;
      display: flex;
      align-items: center;
      padding: 16px;
      background: white;
      border: 1px solid rgba(0, 0, 0, 0.06);
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
      overflow: hidden;
      min-height: 70px;
    }

    .nearby-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.06);
      border-color: rgba(0, 0, 0, 0.1);
    }

    .nearby-card.active {
      background: #f8f9fa;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--accent-light);
    }

    .nearby-card-info {
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 100px;
      max-width: 140px;
    }

    .nearby-card-name {
      font-size: 1rem;
      font-weight: 700;
      color: var(--text-main);
      line-height: 1.2;
    }

    .nearby-card-meta {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .nearby-card-tag {
      background: rgba(0, 0, 0, 0.04);
      padding: 1px 6px;
      border-radius: 4px;
      font-size: 0.65rem;
      font-weight: 500;
    }

    .nearby-card-tag.race {
      background: rgba(0, 0, 0, 0.04);
      color: var(--text-sub);
    }

    .nearby-card-desc {
      flex: 1;
      display: flex;
      align-items: center;
      padding: 0 12px;
      min-width: 0;
      overflow: hidden;
    }

    .nearby-card-desc-text {
      font-size: 0.75rem;
      color: var(--text-sub);
      font-style: italic;
      opacity: 0.7;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }

    /* 紧凑名称（仅 mode-detail 显示） */
    .nearby-card-compact-name {
      display: none;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-main);
      text-align: left;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      line-height: 1.2;
    }

    /* 紧凑模式 */
    .nearby-section.mode-detail .nearby-card {
      padding: 10px 8px;
      justify-content: flex-start;
      min-height: auto;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.6);
      border: 1px solid rgba(0, 0, 0, 0.04);
      box-shadow: none;
      gap: 8px;
    }

    .nearby-section.mode-detail .nearby-card:hover {
      background: rgba(0, 0, 0, 0.04);
      transform: none;
    }

    .nearby-section.mode-detail .nearby-card.active {
      background: white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      border: 1px solid rgba(108, 92, 231, 0.3);
    }

    .nearby-section.mode-detail .nearby-card-info {
      display: none;
    }

    .nearby-section.mode-detail .nearby-card-desc {
      display: none;
    }

    .nearby-section.mode-detail .nearby-card-compact-name {
      display: block;
    }

    /* 详情面板 */
    .nearby-detail-pane {
      flex: 0 0 0;
      width: 0;
      opacity: 0;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 24px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      border: 1px solid rgba(0, 0, 0, 0.06);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
      pointer-events: none;
    }

    .nearby-section.mode-detail .nearby-detail-pane {
      flex: 1;
      width: auto;
      opacity: 1;
      pointer-events: auto;
      margin-left: 0;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06), 0 0 0 1px rgba(0, 0, 0, 0.02);
    }

    .nd-layout {
      height: 100%;
      display: grid;
      grid-template-rows: auto 1fr;
      overflow: hidden;
    }

    .nd-banner {
      padding: 16px 20px;
      background: linear-gradient(135deg, #fdfbf7 0%, #fff 100%);
      border-bottom: 1px solid rgba(0, 0, 0, 0.04);
      display: flex;
      align-items: center;
      gap: 16px;
      position: relative;
    }

    .nd-close {
      position: absolute;
      top: 16px;
      right: 16px;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: rgba(0, 0, 0, 0.03);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      color: var(--text-main);
    }

    .nd-close:hover {
      background: rgba(0, 0, 0, 0.08);
      transform: rotate(90deg);
    }

    .nd-avatar {
      width: 72px;
      height: 72px;
      border-radius: 16px;
      background: linear-gradient(135deg, #f5f6fa, #dfe6e9);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #b2bec3;
      font-size: 2rem;
      flex-shrink: 0;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
    }

    .nd-hero-info { flex: 1; min-width: 0; }

    .nd-name {
      font-size: 1.5rem;
      font-weight: 800;
      color: var(--text-main);
      font-family: var(--font-serif);
      line-height: 1.1;
      margin-bottom: 6px;
      letter-spacing: -0.5px;
    }

    .nd-badges { display: flex; gap: 5px; flex-wrap: wrap; }

    .nd-badge {
      font-size: 0.6rem;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 6px;
      background: rgba(0, 0, 0, 0.04);
      color: var(--text-sub);
      letter-spacing: 0.3px;
    }

    .nd-badge.race {
      background: rgba(108, 92, 231, 0.08);
      color: var(--accent);
    }

    .nd-scroll {
      overflow-y: auto;
      padding: 12px 16px 16px;
    }

    .nd-scroll::-webkit-scrollbar { width: 3px; }
    .nd-scroll::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.08); border-radius: 3px; }

    .nd-grid {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .nd-card {
      background: rgba(0, 0, 0, 0.015);
      border-radius: 12px;
      padding: 12px 14px;
      border: 1px solid rgba(0, 0, 0, 0.04);
    }

    .nd-card-title {
      font-size: 0.65rem;
      font-weight: 700;
      color: var(--text-sub);
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 5px;
      margin-bottom: 8px;
      text-transform: uppercase;
    }

    .nd-card-title i { font-size: 0.75rem; opacity: 0.6; }

    .nd-attr-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
    }

    .nd-attr-item {
      text-align: center;
      padding: 6px 4px;
      background: rgba(255, 255, 255, 0.8);
      border-radius: 8px;
      border: 1px solid rgba(0, 0, 0, 0.04);
    }

    .nd-attr-name {
      font-size: 0.58rem;
      color: var(--text-sub);
      font-weight: 600;
      margin-bottom: 2px;
    }

    .nd-attr-val {
      font-size: 0.9rem;
      font-weight: 700;
      color: var(--primary);
      font-family: var(--font-tech);
    }

    .nd-info-row { display: flex; flex-direction: column; gap: 6px; }

    .nd-info-item { display: flex; gap: 8px; font-size: 0.75rem; line-height: 1.5; }
    .nd-info-item span:first-child { font-weight: 600; color: var(--text-sub); font-size: 0.68rem; flex-shrink: 0; min-width: 32px; }
    .nd-info-item span:last-child { color: var(--text-main); font-weight: 500; }

    .nd-equip-list { display: flex; flex-direction: column; gap: 4px; }

    .nd-equip-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 10px;
      background: rgba(255, 255, 255, 0.8);
      border-radius: 8px;
      border: 1px solid rgba(0, 0, 0, 0.04);
      font-size: 0.72rem;
    }

    .nd-equip-name { font-weight: 600; }
    .nd-equip-slot { font-size: 0.62rem; color: var(--text-sub); }

    /* ===== 关系 Tab - 羁绊 & 声望 ===== */
    .relations-section {
      display: flex;
      flex-direction: column;
      gap: 0;
    }

    .rel-sub-tabs {
      display: flex;
      gap: 2px;
      padding: 3px;
      margin-bottom: 10px;
      background: rgba(0, 0, 0, 0.03);
      border-radius: 10px;
    }

    .rel-sub-tab {
      flex: 1;
      padding: 6px 0;
      border: none;
      background: transparent;
      font-family: var(--font-tech);
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--text-sub);
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
      user-select: none;
      letter-spacing: 0.3px;
    }

    .rel-sub-tab:hover {
      color: var(--text-main);
      background: rgba(255, 255, 255, 0.5);
    }

    .rel-sub-tab.active {
      color: var(--text-main);
      background: #fff;
      box-shadow: 0 1px 6px rgba(0, 0, 0, 0.06);
    }

    .rel-sub-tab i {
      font-size: 0.85rem;
    }

    .rel-sub-tab .rel-count {
      font-size: 0.55rem;
      background: rgba(0, 0, 0, 0.06);
      padding: 1px 6px;
      border-radius: 6px;
      font-weight: 700;
      line-height: 1.3;
    }

    .rel-sub-tab.active .rel-count {
      background: rgba(108, 92, 231, 0.1);
      color: var(--accent);
    }

    .rel-pane {
      display: none;
      animation: tabFadeIn 0.2s ease;
    }

    .rel-pane.active {
      display: block;
    }

    /* 羁绊卡片 - 网格极简风格 (继承主样式，无需重复) */
    .bond-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
      gap: 10px;
      padding: 4px;
    }

    /* Tooltip (继承主样式) */
    .bond-card .bond-tooltip {
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%) translateY(5px);
      background: rgba(45, 52, 54, 0.96);
      color: #fff;
      padding: 6px 10px;
      border-radius: 8px;
      font-size: 0.72rem;
      width: max-content;
      max-width: 150px;
      z-index: 100;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s, transform 0.2s;
      pointer-events: none;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      text-align: center;
      white-space: normal;
      line-height: 1.35;
      backdrop-filter: blur(8px);
    }

    .bond-card:hover .bond-tooltip {
      opacity: 1;
      visibility: visible;
      transform: translateX(-50%) translateY(-5px);
    }

    .bond-tooltip-thought {
      font-style: italic;
      color: #dfe6e9;
      line-height: 1.4;
      display: block;
    }

    .bond-tooltip::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border-width: 5px;
      border-style: solid;
      border-color: rgba(45, 52, 54, 0.96) transparent transparent transparent;
    }

    /* 声望列表 */
    .rep-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .rep-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: rgba(255, 255, 255, 0.75);
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.5);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      transition: all 0.2s;
    }

    .rep-item:hover {
      box-shadow: 0 4px 14px rgba(0, 0, 0, 0.06);
      transform: translateY(-1px);
      background: rgba(255, 255, 255, 0.9);
    }

    .rep-icon {
      width: 32px;
      height: 32px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.85rem;
      flex-shrink: 0;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
    }

    .rep-icon.rep-positive {
      background: linear-gradient(135deg, #ffeaa7, #fdcb6e);
      color: #d4a017;
    }

    .rep-icon.rep-negative {
      background: linear-gradient(135deg, #dfe6e9, #b2bec3);
      color: #636e72;
    }

    .rep-info {
      flex: 1;
      min-width: 0;
    }

    .rep-name {
      font-size: 0.78rem;
      font-weight: 700;
      color: var(--text-main);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .rep-desc {
      font-size: 0.58rem;
      color: var(--text-sub);
      margin-top: 1px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      line-height: 1.3;
    }

    .rep-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 1px;
      flex-shrink: 0;
    }

    .rep-rank {
      font-size: 0.7rem;
      font-weight: 700;
    }

    .rep-rank.rank-positive {
      color: var(--gold);
    }

    .rep-rank.rank-negative {
      color: #636e72;
    }

    .rep-val {
      font-size: 0.6rem;
      color: var(--text-sub);
      font-family: var(--font-tech);
      font-weight: 600;
    }

    /* ===== Fusion Card 弹窗样式 ===== */
    .fusion-popup-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      animation: popupFadeIn 0.2s ease;
    }

    @keyframes popupFadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    .fusion-card {
      width: 300px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 15px 40px rgba(59, 66, 89, 0.15);
      overflow: hidden;
      border: 1px solid rgba(0, 0, 0, 0.03);
      position: relative;
      animation: slideUp 0.5s ease;
      max-height: 85vh;
      overflow-y: auto;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .fusion-card .popup-close {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 24px;
      height: 24px;
      border: none;
      background: rgba(0, 0, 0, 0.05);
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #636E72;
      transition: all 0.2s;
      z-index: 10;
    }

    .fusion-card .popup-close:hover {
      background: rgba(0, 0, 0, 0.1);
      color: #e94560;
      transform: rotate(90deg);
    }

    .fusion-card .popup-close i {
      font-size: 1rem;
    }

    .fusion-card .f-header {
      padding: 16px 20px 8px;
      position: relative;
      background: linear-gradient(to bottom, #fff, #fafafa);
    }

    .fusion-card .f-meta-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
      font-family: var(--font-tech);
      font-weight: 700;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .fusion-card .f-quality {
      background: var(--quality-color);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      font-weight: 800;
    }

    .fusion-card .f-type {
      color: #636E72;
      opacity: 0.8;
    }

    .fusion-card .f-title-row {
      display: flex;
      align-items: baseline;
      gap: 6px;
      margin-top: 2px;
      line-height: 1.1;
    }

    .fusion-card .f-name {
      font-family: 'Songti SC', 'SimSun', 'Libre Baskerville', serif;
      font-size: 1.25rem;
      font-weight: 700;
      background: var(--quality-color);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .fusion-card .f-stat-bar {
      background: rgba(253, 251, 247, 0.6);
      border-top: 1px solid #eee;
      border-bottom: 1px solid #eee;
      padding: 8px 20px;
      display: flex;
      gap: 30px;
      margin-top: 10px;
    }

    .fusion-card .f-mini-stat {
      display: flex;
      flex-direction: column;
    }

    .fusion-card .f-ms-label {
      font-size: 0.65rem;
      font-weight: 700;
      color: #999;
      letter-spacing: 0.5px;
    }

    .fusion-card .f-ms-val {
      font-size: 1rem;
      font-weight: 700;
      color: #3B4259;
      line-height: 1.2;
    }

    .fusion-card .f-content {
      padding: 15px 20px;
    }

    .fusion-card .f-data-group {
      margin-bottom: 15px;
    }

    .fusion-card .f-data-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 0;
      border-bottom: 1px dashed rgba(0, 0, 0, 0.05);
    }

    .fusion-card .f-data-row:last-child {
      border-bottom: none;
    }

    .fusion-card .f-data-label {
      font-size: 0.8rem;
      color: #636E72;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .fusion-card .f-data-label i {
      font-size: 0.9rem;
    }

    .fusion-card .f-data-val {
      font-family: var(--font-tech);
      font-weight: 700;
      color: #3B4259;
      font-size: 0.95rem;
    }

    .fusion-card .f-data-val.val-positive {
      color: #27ae60;
    }

    .fusion-card .f-data-val.val-negative {
      color: #e74c3c;
    }

    .fusion-card .f-section-title {
      font-size: 0.7rem;
      color: #636E72;
      font-weight: 700;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .fusion-card .f-section-title i {
      color: #6C5CE7;
      font-size: 0.8rem;
    }

    .fusion-card .f-effect-box {
      background: rgba(248, 249, 250, 0.5);
      border: 1px solid rgba(0, 0, 0, 0.05);
      border-radius: 6px;
      padding: 8px 10px;
      margin-bottom: 15px;
      font-size: 0.8rem;
      color: #2D3436;
      line-height: 1.5;
    }

    .skill-actions-new {
      padding: 15px;
      border-top: 1px solid #f0f0f0;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .skill-level-control {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: #f8f9fa;
      border-radius: 12px;
    }

    .skill-level-control.locked {
      justify-content: center;
      color: #b2bec3;
      gap: 8px;
    }

    .skill-level-control.special {
      justify-content: center;
    }

    .skill-level-control.special.learned {
      color: #27ae60;
      gap: 6px;
    }

    .level-display {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .level-label {
      font-size: 0.7rem;
      color: #999;
    }

    .level-value {
      font-size: 1.1rem;
      font-weight: 700;
      color: #2d3436;
      font-family: var(--font-tech);
    }

    .level-buttons {
      display: flex;
      gap: 6px;
    }

    .level-btn {
      width: 36px;
      height: 36px;
      border: 1px solid #e0e0e0;
      background: #fff;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      color: #636e72;
    }

    .level-btn:hover:not(.disabled) {
      background: #f0f0f0;
      border-color: #ccc;
    }

    .level-btn.disabled {
      opacity: 0.35;
      cursor: not-allowed;
    }

    .level-btn.level-up {
      background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);
      border-color: transparent;
      color: #fff;
    }

    .level-btn.level-down {
      background: #fff0f0;
      border-color: #ffcccc;
      color: #e74c3c;
    }

    .level-btn.level-min,
    .level-btn.level-max {
      width: 32px;
      font-size: 0.85rem;
    }

    .level-cap-hint {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 8px 12px;
      background: #fff8e6;
      border-radius: 8px;
      color: #e67e22;
      font-size: 0.75rem;
      margin-top: -4px;
    }

    .skill-equip-btn {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .skill-equip-btn.equip {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
    }

    .skill-equip-btn.equip:hover {
      opacity: 0.9;
    }

    .skill-equip-btn.unequip {
      background: #f5f5f5;
      color: #666;
      border: 1px solid #e0e0e0;
    }

    .skill-equip-btn.unequip:hover {
      background: #ffebee;
      border-color: #e57373;
      color: #e74c3c;
    }

    .skill-learn-special {
      padding: 10px 28px;
      border: none;
      background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);
      color: #fff;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 600;
    }

    /* ==================== 移动端响应式布局 ==================== */

    /* 中等屏幕 (平板竖屏 / 大手机) */
    @media (max-width: 480px) {

      .header-card-glass {
        padding: 8px 10px;
        gap: 5px;
      }

      .header-right-info {
        flex-wrap: nowrap;
        gap: 6px;
      }

      .world-info-block {
        flex: 1;
        min-width: 0;
        gap: 6px;
      }

      .world-info-row {
        font-size: 0.72rem;
        min-width: 0;
      }

      .world-info-row span {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .world-location {
        max-width: 80px;
      }

      .quick-nav {
        flex-shrink: 0;
      }

      .nav-btn {
        width: 32px;
        height: 32px;
        font-size: 0.95rem;
        border-radius: 8px;
      }

      /* 导航栏行不加额外padding，保持原样 */

      /* 盾牌：窄屏下用 CSS order 移到 char-header 第一行右上角 */
      .char-header {
        display: grid;
        grid-template-columns: auto 1fr auto;
        grid-template-rows: auto auto;
        gap: 6px 10px;
        align-items: center;
      }

      .avatar {
        grid-row: 1;
        grid-column: 1;
        width: 56px;
        height: 56px;
      }

      .char-details {
        grid-row: 1;
        grid-column: 2;
        min-width: 0;
      }

      /* 盾牌放到头像/名字那一行的右侧 */
      .armor-block {
        grid-row: 1;
        grid-column: 3;
        margin: 0;
      }

      /* HP/CP 条占第二行全宽 */
      .hp-container {
        grid-row: 2;
        grid-column: 1 / -1;
        max-width: none;
        min-width: 0;
      }

      .bar-value {
        font-size: 0.55rem;
      }

      .buff-bar {
        gap: 6px;
      }

      .buff-icon-item {
        width: 32px;
        height: 32px;
        border-radius: 6px;
      }

      .buff-icon-item i {
        font-size: 1.2rem;
      }

      .tab-section {
        padding: 0 10px 10px;
      }

      .tab-bar {
        gap: 1px;
        padding: 4px 2px;
      }

      .tab-item {
        padding: 5px 2px;
        font-size: 0.62rem;
        gap: 2px;
        letter-spacing: 0;
      }

      .tab-item i {
        font-size: 0.78rem;
      }

      .skill-slots-section {
        padding: 10px 8px 28px;
      }

      .slots-grid {
        gap: 10px;
        row-gap: 30px;
      }

      .skill-slot {
        width: 44px;
        height: 44px;
      }

      .skill-slot.awakening,
      .skill-slot.combo-ultimate {
        width: 52px;
        height: 52px;
      }

      .skill-slot-name {
        font-size: 0.55rem;
        max-width: 56px;
      }
    }

    /* 小屏手机 */
    @media (max-width: 380px) {

      .card-header {
        padding: 10px 10px 8px;
      }

      .header-card-glass {
        padding: 7px 8px;
        border-radius: 12px;
        gap: 4px;
      }

      .avatar {
        width: 50px;
        height: 50px;
      }

      .char-details h1 {
        font-size: 1.05rem;
      }

      .class-tag {
        font-size: 0.65rem;
      }

      .nav-btn {
        width: 30px;
        height: 30px;
        font-size: 0.9rem;
      }

      .world-info-row {
        font-size: 0.68rem;
      }

      .world-info-block {
        gap: 4px;
      }

      .world-location {
        max-width: 55px;
      }

      /* Tab 栏：隐藏文字只显示图标 */
      .tab-item {
        font-size: 0;
        padding: 6px 0;
      }

      .tab-item i {
        font-size: 0.95rem;
      }

      .slots-grid {
        gap: 8px;
        row-gap: 28px;
      }

      .skill-slot {
        width: 40px;
        height: 40px;
      }

      .skill-slot.awakening,
      .skill-slot.combo-ultimate {
        width: 48px;
        height: 48px;
      }

      .skill-icon {
        font-size: 1.3rem;
      }

      .skill-slot-name {
        font-size: 0.5rem;
        max-width: 50px;
      }

      .bar-label {
        font-size: 0.58rem;
        min-width: 20px;
      }

      .bar-value {
        font-size: 0.5rem;
      }

      .buff-icon-item {
        width: 30px;
        height: 30px;
      }

      .buff-icon-item i {
        font-size: 1.1rem;
      }

      .buff-duration-badge {
        font-size: 0.5rem;
        padding: 0px 3px;
      }
    }

    /* 超小屏 (iPhone SE 等 320px 设备) */
    @media (max-width: 320px) {

      .card-header {
        padding: 8px 8px 6px;
      }

      .header-card-glass {
        padding: 6px 7px;
        gap: 3px;
      }

      .quick-nav {
        gap: 3px;
      }

      .world-info-block {
        gap: 3px;
      }

      .world-info-row {
        font-size: 0.62rem;
      }

      .world-location {
        max-width: 45px;
      }

      .nav-btn {
        width: 28px;
        height: 28px;
        font-size: 0.85rem;
        border-radius: 6px;
      }

      .avatar {
        width: 44px;
        height: 44px;
      }

      .char-details h1 {
        font-size: 0.95rem;
      }

      .class-tag {
        font-size: 0.6rem;
        padding: 2px 6px;
      }

      .hp-label {
        font-size: 0.5rem;
      }

      .hp-current {
        font-size: 0.75rem;
      }

      .hp-max {
        font-size: 0.55rem;
      }

      .cp-label {
        font-size: 0.45rem;
      }

      .cp-current {
        font-size: 0.6rem;
      }

      .shield-icon {
        width: 20px;
        height: 24px;
        font-size: 0.6rem;
      }

      .armor-label {
        font-size: 0.45rem;
      }

      .skill-slot {
        width: 36px;
        height: 36px;
      }

      .skill-slot.awakening,
      .skill-slot.combo-ultimate {
        width: 44px;
        height: 44px;
      }

      .skill-icon {
        font-size: 1.1rem;
      }

      .slots-grid {
        gap: 6px;
        row-gap: 24px;
      }

      .skill-slot-name {
        font-size: 0.48rem;
        max-width: 44px;
      }

      .skill-level-badge {
        font-size: 0.5rem;
        padding: 0px 3px;
      }

      .tab-section {
        padding: 0 8px 8px;
      }

      .tab-item i {
        font-size: 0.85rem;
      }

      .bar-row {
        gap: 5px;
      }

      .bar-label {
        font-size: 0.55rem;
        min-width: 18px;
      }

      .bar-value {
        font-size: 0.48rem;
      }

      .bar-track {
        height: 5px;
      }

      .buff-bar {
        gap: 5px;
      }

      .buff-icon-item {
        width: 28px;
        height: 28px;
      }

      .buff-icon-item i {
        font-size: 1rem;
      }
    }

    /* ==================== 02/07 Redesign Styles ==================== */
    .bond-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 10px 14px;
      background: rgba(255, 255, 255, 0.6);
      border-radius: 12px;
      flex-shrink: 0;
      border: 1px solid rgba(255, 255, 255, 0.5);
      transition: all 0.2s cubic-bezier(0.2, 0.8, 0.2, 1);
      cursor: pointer;
      user-select: none;
      position: relative;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    .bond-section-container.has-selection .bond-item {
      padding: 10px 12px;
      gap: 8px;
    }

    .bond-item:hover {
      background: rgba(255, 255, 255, 0.85);
      transform: translateX(3px);
      box-shadow: 0 4px 12px rgba(108, 92, 231, 0.08);
      border-color: rgba(108, 92, 231, 0.1);
      z-index: 2;
    }

    .bond-item.active {
      background: #fff;
      border-color: var(--accent);
      box-shadow: 0 4px 16px rgba(108, 92, 231, 0.15);
      transform: translateX(5px);
      z-index: 5;
    }

    .bond-item-left {
      display: flex;
      align-items: center;
      gap: 10px;
      flex: 1;
      min-width: 0;
    }

    .bond-avatar-mini {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      object-fit: cover;
      background: linear-gradient(135deg, #dfe6e9 0%, #b2bec3 100%);
      /* Default placeholder */
      flex-shrink: 0;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      border: 1px solid rgba(0, 0, 0, 0.05);
      display: none;
      /* Hidden by default */
    }

    .bond-avatar-mini.has-img {
      display: block;
      background: transparent;
    }

    .bond-info-compact {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
      flex: 1;
    }

    /* Override bond-meta for compatibility */
    .bond-section-container.has-selection .bond-meta,
    .bond-section-container.has-selection .bond-favor-pill span {
      display: none;
    }

    .bond-section-container.has-selection .bond-favor-pill {
      padding: 4px;
      background: transparent;
    }

    .bond-section-container.has-selection .bond-favor-pill i {
      font-size: 1rem;
    }

    .bond-oath-marker {
      color: #e84393;
      font-size: 0.8rem;
      margin-left: 4px;
      text-shadow: 0 0 5px rgba(232, 67, 147, 0.3);
    }

    /* Upload & New Avatar Styles */
    .bd-avatar-group {
      position: relative;
      width: 72px;
      height: 72px;
      flex-shrink: 0;
      margin-right: 4px;
    }

    .bd-avatar-img {
      width: 100%;
      height: 100%;
      border-radius: 18px;
      object-fit: cover;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      border: 2px solid #fff;
      background: #ecf0f1;
      transition: all 0.3s;
    }

    .bd-avatar-placeholder {
      width: 100%;
      height: 100%;
      border-radius: 18px;
      background: linear-gradient(135deg, #dfe6e9 0%, #b2bec3 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem;
      color: #fff;
      text-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      font-family: var(--font-serif);
      font-style: italic;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      border: 2px solid #fff;
    }

    .bd-upload-btn {
      position: absolute;
      bottom: -6px;
      right: -6px;
      width: 26px;
      height: 26px;
      border-radius: 50%;
      background: var(--primary);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid #fff;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      font-size: 0.85rem;
      transition: all 0.2s;
      z-index: 2;
    }

    .bd-upload-btn:hover {
      background: var(--accent);
      transform: scale(1.1);
    }

    /* ==================== End Redesign Styles ==================== */
  </style>
</head>

<body>
  <div id="app"></div>
  <script>
    (function () {
      // ==================== MVU 接入层 (同 状态栏.js) ====================
      const getCore = () => {
        try {
          const win = window.parent || window;
          const $ = window.jQuery || win.jQuery;
          return { window: win, $, getDB: () => win.AutoCardUpdaterAPI || window.AutoCardUpdaterAPI };
        } catch (e) {
          return { window: window, $: window.jQuery, getDB: () => window.AutoCardUpdaterAPI };
        }
      };

      // ==================== 职业背景图片映射 ====================
      const CLASS_BACKGROUND_BASE_URL = 'https://gitgud.io/Rown/dnf/-/raw/master/background/';
      const CLASS_BACKGROUND_MAP = {
        '鬼剑士(男)': '鬼剑.webp', '鬼剑士(女)': '女鬼剑.webp',
        '格斗家(男)': '男格斗.webp', '格斗家(女)': '女格斗.webp',
        '神枪手(男)': '神枪手.webp', '神枪手(女)': '女神枪手.webp',
        '魔法师(男)': '男法.webp', '魔法师(女)': '女法.webp',
        '圣职者(男)': '男圣职者.webp', '圣职者(女)': '女圣职者.webp',
        '魔枪士': '魔枪.webp', '枪剑士': '枪剑士.webp', '黑暗武士': '黑暗武士.webp',
        '暗夜使者': '暗夜使者.webp', '守护者': '守护者.webp', '弓箭手': '弓箭手.webp',
        // 鬼剑士进阶
        '剑魂': '鬼剑.webp', '鬼泣': '鬼剑.webp', '狂战士': '鬼剑.webp', '阿修罗': '鬼剑.webp', '剑影': '鬼剑.webp',
        '驭剑士': '女鬼剑.webp', '暗帝': '女鬼剑.webp', '契魔者': '女鬼剑.webp', '流浪武士': '女鬼剑.webp', '刃影': '女鬼剑.webp',
        // 格斗家进阶
        '气功师': '女格斗.webp', '散打': '女格斗.webp', '街霸': '女格斗.webp', '柔道家': '女格斗.webp',
        '气功师(男)': '男格斗.webp', '散打(男)': '男格斗.webp', '街霸(男)': '男格斗.webp', '柔道家(男)': '男格斗.webp', '男街霸': '男格斗.webp',
        // 神枪手进阶
        '漫游枪手': '女神枪手.webp', '枪炮师': '女神枪手.webp', '机械师': '女神枪手.webp', '弹药专家': '女神枪手.webp',
        '漫游枪手(男)': '神枪手.webp', '枪炮师(男)': '神枪手.webp', '机械师(男)': '神枪手.webp', '弹药专家(男)': '神枪手.webp', '合金战士': '神枪手.webp',
        // 魔法师进阶
        '元素师': '女法.webp', '召唤师': '女法.webp', '战斗法师': '女法.webp', '魔道学者': '女法.webp', '小魔女': '女法.webp', '冰结师': '女法.webp',
        '元素爆破师': '男法.webp', '冰结师(男)': '男法.webp', '血法师': '男法.webp', '逐风者': '男法.webp', '次元行者': '男法.webp',
        // 圣职者进阶
        '圣骑士': '女圣职者.webp', '异端审判者': '女圣职者.webp', '巫女': '女圣职者.webp', '诱魔者': '女圣职者.webp',
        '圣骑士(男)': '男圣职者.webp', '蓝拳圣使': '男圣职者.webp', '驱魔师': '男圣职者.webp', '复仇者': '男圣职者.webp',
        // 其他职业进阶
        '征战者': '魔枪.webp', '决战者': '魔枪.webp', '狩猎者': '魔枪.webp', '暗枪士': '魔枪.webp',
        '特工': '枪剑士.webp', '战线佣兵': '枪剑士.webp', '暗刃': '枪剑士.webp', '源能专家': '枪剑士.webp',
        '刺客': '暗夜使者.webp', '死灵术士': '暗夜使者.webp', '忍者': '暗夜使者.webp', '影舞者': '暗夜使者.webp',
        '精灵骑士': '守护者.webp', '混沌魔灵': '守护者.webp', '帕拉丁': '守护者.webp', '龙骑士': '守护者.webp',
        '缪斯': '弓箭手.webp', '旅人': '弓箭手.webp', '猎人': '弓箭手.webp', '妖护使': '弓箭手.webp'
      };
      const DEFAULT_CLASS_BACKGROUND = '鬼剑.webp';
      let _cachedClassName = null;
      const getClassBackgroundUrl = (className) => {
        const bgFile = CLASS_BACKGROUND_MAP[className] || DEFAULT_CLASS_BACKGROUND;
        return CLASS_BACKGROUND_BASE_URL + encodeURIComponent(bgFile);
      };

      const mvuState = {
        ready: false, mvu: null,
        check: () => {
          const win = getCore().window;
          if (typeof win.Mvu === 'undefined' || typeof win.Mvu.getMvuData !== 'function' || typeof win.Mvu.replaceMvuData !== 'function') {
            mvuState.ready = false; mvuState.mvu = null; return false;
          }
          mvuState.ready = true; mvuState.mvu = win.Mvu; return true;
        }
      };

      const fetchLatestMvuData = () => {
        let finalData = {};
        try {
          if (mvuState.ready || mvuState.check()) {
            const mvuData = mvuState.mvu.getMvuData({ type: 'message', message_id: 'latest' });
            if (mvuData?.stat_data && Object.keys(mvuData.stat_data).length > 0) {
              finalData = mvuData.stat_data;
            } else {
              const chatData = mvuState.mvu.getMvuData({ type: 'chat' });
              if (chatData?.stat_data && Object.keys(chatData.stat_data).length > 0) finalData = chatData.stat_data;
            }
          }
        } catch (e) { console.warn('[底部状态栏] MVU:', e); }
        return finalData;
      };

      const applyMvuPatches = (patches) => {
        try {
          if (!mvuState.ready && !mvuState.check()) return false;
          const mvuData = mvuState.mvu.getMvuData({ type: 'message', message_id: 'latest' });
          if (!mvuData?.stat_data) return false;
          patches.forEach(patch => {
            const parts = patch.path.split('/').filter(Boolean);
            if (patch.op === 'replace' || patch.op === 'add') {
              let obj = mvuData.stat_data;
              for (let i = 0; i < parts.length - 1; i++) { if (!obj[parts[i]]) obj[parts[i]] = {}; obj = obj[parts[i]]; }
              obj[parts[parts.length - 1]] = patch.value;
            } else if (patch.op === 'remove') {
              let obj = mvuData.stat_data;
              for (let i = 0; i < parts.length - 1; i++) { if (!obj[parts[i]]) return; obj = obj[parts[i]]; }
              delete obj[parts[parts.length - 1]];
            }
          });
          mvuState.mvu.replaceMvuData(mvuData, { type: 'message', message_id: 'latest' });
          return true;
        } catch (e) { return false; }
      };
      // ==================== 技能阶位配置 ====================
      const TIER_CONFIG = {
        基础: { 习得等级: 1, 等级上限: 15, SP消耗: 10, 冷却: 0, 伤害: { 基础: 220, 成长: 20 }, 召唤: { 基础: 160, 成长: 15 } },
        转职: { 习得等级: 15, 等级上限: 15, SP消耗: 20, 冷却: 0, 伤害: { 基础: 300, 成长: 50 }, 召唤: { 基础: 220, 成长: 35 } },
        进阶: { 习得等级: 30, 等级上限: 10, SP消耗: 30, 冷却: 1, 伤害: { 基础: 600, 成长: 100 }, 召唤: { 基础: 300, 成长: 50 } },
        必杀: { 习得等级: 45, 等级上限: 7, SP消耗: 50, 冷却: 2, 伤害: { 基础: 1400, 成长: 130 }, 召唤: { 基础: 500, 成长: 45 } },
        奥义: { 习得等级: 75, 等级上限: 5, SP消耗: 80, 冷却: 3, 伤害: { 基础: 2400, 成长: 200 }, 召唤: { 基础: 600, 成长: 65 } },
        觉醒一: { 习得等级: 50, 等级上限: 3, SP消耗: 0, 冷却: 3, 伤害: { 基础: 4500, 成长: 500 } },
        觉醒二: { 习得等级: 85, 等级上限: 2, SP消耗: 0, 冷却: 4, 伤害: { 基础: 6000, 成长: 1000 } },
        觉醒三: { 习得等级: 100, 等级上限: 1, SP消耗: 0, 冷却: 5, 伤害: { 基础: 8000, 成长: 0 } }
      };
      const calcSkillDamage = (skill) => {
        const tier = TIER_CONFIG[skill.阶位];
        if (!tier) return 0;
        if (skill.类型 === '特殊' || skill.类型 === '职业特殊') return 0;
        const level = skill.当前等级 || 0;
        if (level === 0) return 0;
        let base;
        if (skill.类型 === '召唤' && tier.召唤) {
          base = tier.召唤.基础 + tier.召唤.成长 * (level - 1);
        } else {
          base = tier.伤害.基础 + tier.伤害.成长 * (level - 1);
        }
        // 向下浮动 0~25%，凑整到10的倍数
        const floatRatio = 1 - Math.random() * 0.25;
        return Math.round(base * floatRatio / 10) * 10;
      };
      const getSpecialEffect = (skill) => {
        if (!skill.特殊效果 || (skill.当前等级 || 0) === 0) return null;
        // 职业特殊技能：特殊效果是字符串，直接返回
        if (typeof skill.特殊效果 === 'string') return skill.特殊效果;
        // 普通特殊技能：特殊效果是对象，按等级获取
        const currentLv = skill.当前等级 || 1;
        // 先尝试精确匹配
        if (skill.特殊效果[String(currentLv)]) {
          return skill.特殊效果[String(currentLv)];
        }
        // 找不到精确匹配时，找不超过当前等级的最大等级
        const validKeys = Object.keys(skill.特殊效果)
          .map(k => parseInt(k))
          .filter(k => !isNaN(k) && k <= currentLv)
          .sort((a, b) => b - a);
        if (validKeys.length > 0) {
          return skill.特殊效果[String(validKeys[0])];
        }
        return null;
      };
      /**
       * 获取特殊技能当前等级效果对象（写入技能槽用）
       * 职业特殊技能：返回字符串
       * 普通特殊技能：返回 { "当前等级": "效果文本" } 对象
       */
      const getSpecialEffectObj = (skill) => {
        const lv = String(skill.当前等级 || 1);
        if (!skill.特殊效果 || (skill.当前等级 || 0) === 0) return { [lv]: '无' };
        if (typeof skill.特殊效果 === 'string') return skill.特殊效果;
        if (skill.特殊效果[lv]) {
          return { [lv]: skill.特殊效果[lv] };
        }
        const validKeys = Object.keys(skill.特殊效果)
          .map(k => parseInt(k))
          .filter(k => !isNaN(k) && k <= parseInt(lv))
          .sort((a, b) => b - a);
        if (validKeys.length > 0) {
          const key = String(validKeys[0]);
          return { [key]: skill.特殊效果[key] };
        }
        return { [lv]: '无' };
      };

      // ==================== 自动学习已解锁技能并装备到空槽位 ====================
      const autoLearnAndEquipSkills = (data) => {
        const skillTree = data?.人物?.技能树;
        if (!skillTree || !skillTree.技能列表) return false;
        const charLevel = data?.人物?.等级 || 1;
        const skillList = skillTree.技能列表;
        if (!skillTree.技能槽) skillTree.技能槽 = { 主动技能槽: {}, 觉醒技能槽: {} };
        const patches = [];
        const raceData = data?.人物?.种族 || '';
        const isElf = raceData === '森精种';

        Object.entries(skillList).forEach(([skillName, skill]) => {
          const tier = TIER_CONFIG[skill.阶位];
          if (!tier) return;
          const isUnlocked = charLevel >= tier.习得等级;
          const currentLevel = skill.当前等级 || 0;
          if (isUnlocked && currentLevel === 0) {
            // 自动学习：设为1级
            patches.push({ op: 'add', path: `/人物/技能树/技能列表/${skillName}/当前等级`, value: 1 });
            // 尝试自动装备到空槽位
            const isAwk = skill.阶位?.includes('觉醒');
            const slotKey = isAwk ? '觉醒技能槽' : '主动技能槽';
            const maxSlots = isAwk ? (isElf ? 3 : 2) : (isElf ? 7 : 6);
            if (!skillTree.技能槽[slotKey]?.[skillName]) {
              const equippedCount = Object.keys(skillTree.技能槽[slotKey] || {}).length;
              if (equippedCount < maxSlots) {
                patches.push({
                  op: 'add',
                  path: `/人物/技能树/技能槽/${slotKey}/${skillName}`,
                  value: {
                    名称: skillName,
                    类型: skill.类型 || '主动',
                    技能等级: 1,
                    冷却中: false,
                    伤害倍率: calcSkillDamage({ ...skill, 当前等级: 1 }),
                    阶位: skill.阶位,
                    特殊效果: getSpecialEffectObj({ ...skill, 当前等级: 1 }),
                    描述: skill.描述 || ''
                  }
                });
              }
            }
          }
        });
        if (patches.length > 0) {
          applyMvuPatches(patches);
          return true;
        }
        return false;
      };
      // ==================== SVG 图标系统 (内嵌完整数据) ====================
      const DEFAULT_SVG = 'M64 64h384v384H64z';
      const SKILL_SVG_PATHS = {
        // ========== 主动技能 (Active) ==========
        // 主动技能图标风格：攻击性、动态感、武器相关
        主动: {
          基础: 'M43.53 15.75c-15.73 0-28.31 12.583-28.31 28.313 0 14.086 10.092 25.644 23.5 27.906L42.687 68 68.81 41.906l2.626-2.625C69.188 25.86 57.63 15.75 43.53 15.75zm33.72 44.125-17 17c15.885 39.37 43.45 66.684 78.75 87.406a512.629 512.629 0 0 1 25.438-24.936c-22.488-35.103-51.535-62.294-87.188-79.47zM322.594 79.03l-51.25 4.314c-79.356 48.134-143.878 108.1-186.72 186.53l-4.31 51.47 44.155-18.656-2.94-34.094-.25-3.063 1.626-2.624c35.94-58.47 79.93-109.41 141.5-141.25l2.406-1.25 2.688.25 34.125 2.906 18.97-44.53zm-62.438 66.376c-10.008 5.886-19.5 12.338-28.562 19.313 46.688 47.93 87.208 108.588 114.72 166.5l11.248 23.717-23.718-11.28c-57.995-27.554-117.918-67.57-165.688-113.907a497.06 497.06 0 0 0-20.625 29.28c101.918 94.91 227.05 177.304 347.845 234.69-57.063-120.125-140.038-246.18-235.22-348.314zm-43.03 31.22c-13.37 11.703-25.72 24.58-37.282 38.436 39.36 38.452 88.085 72.83 136.687 98.844-26.054-48.633-60.754-97.847-99.405-137.28z',   // 基础攻击 - 匕首
          转职: 'm491.844 22.533-83.42 14.865L196.572 249.25c3.262 4.815 5.37 10.72 5.37 16.932 0 5.863-1.71 11.35-4.643 15.996a52.936 52.936 0 0 0-16.027-2.477c-15.724 0-29.904 6.89-39.69 17.796l-9.112-9.113 17.237-17.237a545.915 545.915 0 0 1-13.19-17.6l-19.443 19.44-13.215-13.215 21.828-21.827a548.134 548.134 0 0 1-12.792-20.068L72.093 258.68l58.314 58.314a52.94 52.94 0 0 0-2.49 16.063 52.86 52.86 0 0 0 4.592 21.564l-72.14 72.14-14.56-14.56L21.013 437l14.558 14.56-8.607 8.608 27.246 27.246 8.606-8.61 14.56 14.56 24.798-24.8-14.557-14.556 72.158-72.16a52.885 52.885 0 0 0 21.498 4.562 52.94 52.94 0 0 0 16.063-2.49l58.363 58.363L296.5 401.48a548.745 548.745 0 0 1-20.068-12.793l-21.83 21.83L241.39 397.3l19.442-19.44a550.258 550.258 0 0 1-17.603-13.194l-17.238 17.238-9.16-9.16c10.905-9.785 17.795-23.965 17.795-39.69 0-5.346-.806-10.51-2.285-15.39 4.703-3.04 10.288-4.817 16.265-4.816 6.21 0 11.776 1.77 16.52 4.955L476.98 105.95l14.864-83.417zm-66.227 53.012 13.215 13.215-191.684 191.68-13.214-13.213L425.617 75.545zM181.273 298.39c19.257 0 34.665 15.41 34.665 34.665 0 19.256-15.408 34.666-34.665 34.666-19.256 0-34.666-15.41-34.666-34.665s15.41-34.666 34.666-34.666z',   // 进阶战斗 - 阔剑
          进阶: 'm311.313 25.625-23 10.656-29.532 123.032 60.814-111.968-8.28-21.72zM59.625 50.03c11.448 76.937 48.43 141.423 100.188 195.75a3267.323 3267.323 0 0 0 42.718-29.405c-22.156-27.314-37.85-56.204-43.593-86.28-34.214-26.492-67.613-53.376-99.312-80.064zm390.47.032C419.178 76.1 386.64 102.33 353.31 128.22c-10.333 58.234-58.087 112.074-118.218 158.624-65.433 50.654-146.56 92.934-215.28 121.406l-.002 32.78c93.65-34.132 195.55-81.378 276.875-146.592 79.035-63.378 138.329-143.063 153.41-244.375zm-236.158 9.344-8.5 27.813 40.688 73.06-6.875-85.31-25.313-15.564zm114.688 87.813C223.39 227.47 112.257 302.862 19.812 355.905V388c65.917-27.914 142.58-68.51 203.844-115.938 49.83-38.574 88.822-81.513 104.97-124.843zm-144.563 2.155c7.35 18.89 19.03 37.68 34 56.063 7.03-4.98 14.056-10.03 21.094-15.094-18.444-13.456-36.863-27.12-55.094-40.97zM352.656 269.72c-9.573 9.472-19.58 18.588-29.906 27.405 54.914 37.294 117.228 69.156 171.906 92.156V358.19c-43.86-24.988-92.103-55.13-142-88.47zm-44.906 39.81c-11.65 9.32-23.696 18.253-36.03 26.845 70.326 45.135 149.33 79.775 222.935 106.375v-33.22c-58.858-24.223-127.1-58.727-186.906-100zm-58.625 52.033-46.188 78.25 7.813 23.593 27.75-11.344 10.625-90.5zm15.844.812L316.343 467l36.47 10.28-3.533-31.967-84.31-82.938z',   // 属性打击 - 剑击
          必杀: 'M386.97 17.688c-.678 24.347-8.144 49.282-22.19 71.843-37.465 60.192-112.748 86.84-181.874 69.907 5.208-2.31 10.233-4.83 15.03-7.593 39.057-22.5 57.284-55.454 54.314-91.688-7.388 21.814-24.62 41.314-50.22 56.063-48.047 27.68-118.01 31.687-187.468 16.936v37.375c41.04 8.176 82.086 9.6 118.563 3.47.365.25.726.503 1.094.75l.093-.03 3.28 2.124c32.687 21.385 79.955 25.336 123.75 16.28 43.797-9.054 83.514-31.274 101.126-57.343l4-5.905 6.75 2.28c39.1 13.354 75.938 17.096 119.06 14.94.718-.056 1.442-.098 2.158-.157v-39.125c-36.865 3.595-75.212.762-111.407-9.032 9.5-26.66 10.5-54.67 3.94-81.093zM323.75 191.28c-17.796 9.052-37.843 15.86-58.625 20.157-31.336 6.48-64.594 7.087-94.688-.53L251.28 305l-93.06 20.375L457.874 495.97 348.53 319.936l58.064-14.968-82.844-113.69z',   // 强力处决 - 闪电风暴
          奥义: 'M222.25 51.813c-59.778.797-102.472 36.19-97.47 91.593-175.105 173.99-42.24 388.292 82.72 301.281 234.398 24.897 320.07-138.203 253.688-215.875-68.157-127.71-166.197-177.97-238.938-177zm35.28 54c59.782-.537 138.234 35.254 194.314 113.593-32.668-28.783-91.096-41.137-175.594-17.906 233.673-4.713 159.012 242.056-65.813 241.094 23.605-17.352 46.84-45.562 67.563-86.97-141.047 157.87-264.124-48.664-152.094-203.78 6.14 35.83 31.486 79.165 83.5 126.5-75.762-109.73-29.625-171.834 48.125-172.53zm20.314 112.03c-28.427-.322-54.126 19.32-60.375 48.188-7.143 32.992 13.82 65.547 46.81 72.69 32.992 7.14 65.516-13.823 72.658-46.814 7.14-32.99-13.822-65.545-46.813-72.687a61.062 61.062 0 0 0-12.28-1.376z',   // 终极爆发 - 原子斩击
          觉醒一: 'M107.5 18c40.728 58.21-63.708 25.914-88.03 2.47 1.058 40.082 100.03 99.633 147.374 72.124C195.904 75.71 136.984 22.936 107.5 18zm97.75 57.28.875 1.47c120.364 99-4.023 175.247-64.97 48.78 15.823 82.506-78.425 44.2-89.655-30.655C-13.17 230.463 172.715 231.293 178.438 324c3.23 52.3-77.82 19.908-113.875-48.844C308.49 797.09 814.024 262.64 205.25 75.28zm134.97 136.376c44.577 0 85.52 18.708 109.56 52.5 43.656 75.614-63.777 27.4-70.717-8.844-21.45 58.675 101.883 114.72 16 170.375 25.962-34.188 2.345-113.552-87.875-109.125 116.512 72.473 42.326 206.9-19.688 93.157 1.306 35.083 11.99 54.83 27.156 64.436-60.89-11.955-107.03-65.528-107.03-129.906 0-39.06 16.94-74.22 43.874-98.5 1.674 61.897 83.61 37.656 115.97 62.344-11.544-60.34-56.022-59.933-82.72-84.28 16.883-7.803 35.67-12.158 55.47-12.158zM234.72 309a44.022 44.022 0 0 0-4.064.25c26.032 6.737 74.684 83.827 33.875 61.75 3.41 14.6 43.038 41.75 57.5 21.156 18.816-26.79-44.374-83.634-87.31-83.156z',   // 觉醒之力 - 燃烧流星
          觉醒二: 'M320.063 19.72c-72.258 14.575-19.248 71.693-74.344 108.81 4.846-.49 9.746-.702 14.655-.624 16.288.26 32.785 3.72 48.594 10.72a126.431 126.431 0 0 1 14.25 7.405c12.107-47.476-37.103-96.38-3.158-126.31zM136.75 44.47c-40.76 61.357 36.984 64.33 24.406 129.405 17.407-21.255 41.17-35.9 67.156-42.313-25.006-42.138-94.4-41.924-91.562-87.093zm297.313 75.405c-32.547.872-45.475 46.314-96.594 36.22 21.35 17.42 36.034 41.25 42.467 67.31 42.306-24.92 42.053-94.466 87.282-91.624-13.43-8.92-24.06-12.15-33.158-11.905zm-177.97 26.656c-23.656.46-46.53 8.82-64.906 23.626l18.657 36.156L170 193.156a107.628 107.628 0 0 0-9.406 16.938c-8.726 19.708-11.002 40.59-7.78 60.344l44.78 2.125-34 30.312c10.798 20.622 28.414 37.852 51.406 48.03a107.842 107.842 0 0 0 9.313 3.626l24.53-38.25 9.095 43.814c27.3.075 53.737-10.387 73.593-29.188l-19.186-37.125 38.406 12.658a108.49 108.49 0 0 0 5.03-9.938c9.746-22.01 11.457-45.498 6.44-67.22l-37.626-1.75 27.687-24.718c-10.83-20.194-28.236-37.07-50.874-47.093a107.405 107.405 0 0 0-4.125-1.72l-25.874 40.313-9.906-47.75c-.5-.016-1-.023-1.5-.032-1.3-.02-2.61-.024-3.906 0zM133.407 186.5c-41.652.725-82.483 34.847-108.72 5.094 14.573 72.234 71.664 19.3 108.783 74.312-2.154-20.972.934-42.758 10.06-63.375a126.36 126.36 0 0 1 7.345-14.093c-5.822-1.47-11.642-2.038-17.47-1.937zm249.5 53.97a124.649 124.649 0 0 1-10.03 63.624l-.188.375a126.38 126.38 0 0 1-7.22 13.78c47.524 12.244 96.507-37.137 126.47-3.156-14.603-72.388-71.92-19.04-109.032-74.625zM136.53 283.405c-42.123 25.014-41.928 94.37-87.093 91.53 61.422 40.803 64.322-37.123 129.594-24.342-21.344-17.385-36.03-41.167-42.5-67.188zm219.064 48.906c-17.406 21.46-41.236 36.24-67.344 42.72 24.944 42.263 94.497 42.004 91.656 87.218 40.867-61.52-37.402-64.358-24.312-129.938zM193.406 360.72c-12.047 47.456 37.087 96.33 3.156 126.25 72.305-14.587 19.195-71.79 74.47-108.908-21.04 2.204-42.898-.9-63.594-10.062a126.43 126.43 0 0 1-14.032-7.28z',   // 核心爆发 - 太阳
          觉醒三: 'M393.5 19.53a57.415 57.415 0 0 0-8.656.626c-31.08 4.62-52.53 33.582-47.906 64.688 4.623 31.106 33.576 52.588 64.656 47.97a58.336 58.336 0 0 0 6.03-1.25c9.68 23.89 14.992 46.253 16.657 66.967-12.318 4.327-20.24 16.91-18.25 30.314 1.366 9.18 7.072 16.623 14.72 20.594-3.375 14.428-8.705 27.7-15.594 39.75-9.627 16.838-22.426 31.345-37.375 43.187 13.33-22.265 19.333-49.11 15.22-76.78-4.372-29.416-19.408-54.588-40.594-72.22-33.633-35.776-80.33-58.405-130.312-58.22-45.336.17-92.873 19.486-134.625 63.376a39.68 39.68 0 0 0-24.75-4.343c-21.767 3.236-36.77 23.528-33.532 45.313 3.238 21.785 23.483 36.83 45.25 33.594 21.766-3.236 36.8-23.528 33.562-45.313a39.775 39.775 0 0 0-6.656-16.843c38.472-40.475 80.822-56.944 120.844-57.093 21.038-.08 41.558 4.455 60.562 12.687-1.344-.05-2.678-.087-4.03-.093a117.003 117.003 0 0 0-17.69 1.282c-16.537 2.457-31.73 8.308-45 16.718-38.298 20.656-69.638 53.2-86.686 93.312-14.32 33.692-18.302 72.74-8 113.813-16.41 6.933-28.73 22.277-30.906 41.25-3.215 28.02 16.88 53.32 44.874 56.53 27.996 3.213 53.317-16.886 56.532-44.906 3.215-28.017-16.88-53.35-44.875-56.562-2.508-.288-4.99-.357-7.44-.28-9.626-37.47-5.866-72.288 7-102.564 5.206-12.245 11.944-23.753 19.94-34.342-4.43 15.467-5.71 32.107-3.19 49.062a119.7 119.7 0 0 0 1.282 7.03c7.884 58.165 40.39 112.06 91.97 141.658 45.803 26.28 106.342 32.7 175.75 6.75 8.357 11.38 22.54 17.875 37.468 15.656 21.484-3.194 36.32-23.216 33.125-44.72-3.196-21.5-23.203-36.35-44.688-33.155-21.484 3.192-36.32 23.215-33.125 44.717.015.096.048.187.063.282-64.737 24.18-118.595 17.612-159.313-5.75-23.945-13.74-43.422-33.523-57.625-56.783 23.992 18.134 54.95 26.988 87.032 22.22a116.553 116.553 0 0 0 23.686-6.126c46.562-11.748 88.206-40.568 112.5-83.06 8.058-14.095 14.142-29.657 17.844-46.5 14.273-3.006 23.925-16.652 21.75-31.282-1.56-10.494-8.8-18.77-18.125-22.125-1.686-23.377-7.498-48.395-18.156-74.657 17.774-11.842 28.13-33.24 24.78-55.78-4.19-28.19-28.373-48.48-56-48.595zM268.437 185.47l12.063 54 46.625-29.564-29.375 46.313 53.594 12.03-53.875 12.063 29.686 46.75-46.687-29.625-12.033 53.75-12-53.594-46.468 29.5 29.655-46.78-54-12.064 53.72-12.03-29.376-46.314 46.436 29.438 12.03-53.875zm-.156 71.28c-6.89 0-12.25 5.39-12.25 12.28 0 6.894 5.36 12.283 12.25 12.283 6.892 0 12.283-5.39 12.283-12.282 0-6.89-5.39-12.28-12.282-12.28z'    // 宇宙毁灭 - 黑洞
        },

        // ========== 召唤技能 (Summon) ==========
        // 召唤技能图标风格：生物、魔法阵、召唤物
        召唤: {
          基础: 'M255.875 19.47c-33.142 0-59.844 26.822-59.844 60.186 0 33.364 26.703 60.156 59.845 60.156 33.142 0 59.875-26.792 59.875-60.156S289.017 19.47 255.875 19.47zm-50.688 120.343c-2.908 1.23-5.658 2.53-8.187 3.937-14.467 8.046-21.47 17.86-21.47 27.094 0 9.234 7.003 19.08 21.47 27.125 14.467 8.044 35.51 13.436 58.875 13.436 23.365 0 44.408-5.392 58.875-13.437 14.467-8.047 21.47-17.892 21.47-27.126 0-9.234-7.003-19.048-21.47-27.094-2.53-1.406-5.28-2.708-8.188-3.938-13.696 11.647-31.392 18.688-50.687 18.688-19.3 0-36.996-7.034-50.688-18.688zm78.875 87.906c-8.948 1.54-18.394 2.374-28.187 2.374A166.87 166.87 0 0 1 229 227.937a74.718 74.718 0 0 1 4.906 21.656c2.456 33.554-17.04 69.573-58.47 93.594l-.155.093-.155.095c-20.062 10.653-30.28 24.056-30.28 36.97 0 12.9 10.28 26.46 30.343 37.217 20.062 10.76 48.86 17.844 80.75 17.844s60.687-7.085 80.75-17.844c20.062-10.758 30.343-24.318 30.343-37.218 0-13.127-10.773-26.656-31.655-37.406l-.22-.125-.186-.094c-40.344-23.394-58.705-59.676-55.908-93.22a78.538 78.538 0 0 1 5-21.78zM128.845 395.655c-5.592 3.72-10.256 7.61-13.875 11.53-6.9 7.48-9.94 14.64-9.94 21.845 0 7.206 3.04 14.397 9.94 21.876 6.898 7.48 17.6 14.852 31.28 21.125 27.36 12.547 66.42 20.69 109.625 20.69 43.206 0 82.295-8.143 109.656-20.69 13.682-6.27 24.352-13.644 31.25-21.124 6.9-7.48 9.97-14.67 9.97-21.875 0-7.204-3.07-14.363-9.97-21.842-3.597-3.902-8.238-7.767-13.78-11.47-5.638 15.6-19.584 28.706-37.5 38.313-23.533 12.62-54.947 20.095-89.563 20.095-34.615 0-66.06-7.474-89.593-20.094-17.94-9.62-31.887-22.747-37.5-38.374z',   // 小型生物 - 棋子
          转职: 'M179.3 38.94C154.7 77.7 142.7 139.7 168.4 185.9l-16.3 9.2c-6.7-11.9-11.2-24.4-13.9-37.2-34.5-6.3-69.42-7.5-104.98-2.1 34.07 10.1 52.77 23.7 76.68 46.7-26.82 9.7-60.25 30.2-92.93 70.2 35.47-8.8 64.83-11.5 89.43-6.3-36.94 22.5-64.06 56.1-88.34 114.1 35.9-17.2 64.89-18.8 102.94-18.8-23.07 32.7-35.27 77.2-36.31 112.8 24.51-26 57.61-60.2 87.21-79 3 29.9 15 58.3 35.9 85.3-.2-43.9 10.3-88.3 31.6-133.4-18.8 9-32.4 18.1-49.9 29.3 6.2-27.9 12.4-55.8 18.7-83.7-23.3 2.4-39 10-60.5 18.5 16.3-33.1 32.7-66.1 49.1-99.2l16.8 8.3-28.4 57.4c18.4-4.4 28.7-4.1 45.7-1.3-4.5 20.4-9 40.7-13.6 61 65.3-36.2 148.3-45.9 226.7-50 7.6-12.9 13.8-24.2 18.8-34.8l-6.3-24.4-24.4 30.8-7.8-27.5-22.5 29.2-7.5-26.1-23.9 31.5-7.7-28.2-23.8 31.4 1.2-41.1 22.6-42.7 7.6 28.3 23.9-31.5 7.6 28.2 23.5-30 6.5 26.9 24.5-30.8 7.8 27.5 24.6-32c2.3-10.8 4.6-22.4 7.4-35.7-55.5-3.7-106.3 4.8-154 9.8-38-20.8-80.8-26.8-121.9-18.5-13.6-29.69-27.2-59.38-40.9-89.06zM325.5 158.3c-4.5 14.2-13 18.3-24.7 20.6-16.1-4.4-28.3-15.5-34.4-30.2 20.4-3.8 42.4 3.4 59.1 9.6z',   // 猛兽 - 狼头
          进阶: 'M142.026 16.89C94.242 38.888 62.71 74.257 62.71 113.927c0 26.11 13.42 50.288 36.22 70.04-11.664 25.398-18.99 53.91-20.81 84.212 17.194.562 33.53 4.205 48.192 11.7 41.566 21.25 61.083 66.944 57.787 121.093a286.662 286.662 0 0 0 23.122 4.58c.894-16.76.83-33.468-.496-50.122l18.63-1.485c1.438 18.035 1.466 36.014.458 53.938 8.022.76 16.14 1.21 24.322 1.382V353.03h18.687v56.13c7.83-.25 15.693-.755 23.565-1.514-.995-17.845-.96-35.745.47-53.7l18.63 1.485c-1.323 16.597-1.39 33.247-.504 49.95 7.307-1.07 14.6-2.355 21.863-3.843-3.467-54.395 16.04-100.333 57.748-121.656 14.66-7.497 30.998-11.142 48.19-11.702-1.843-30.716-9.343-59.594-21.284-85.252 22.08-19.56 35.044-43.346 35.044-69 0-39.67-31.532-75.04-79.316-97.035C386.283 33.46 394.32 53.31 394.32 74.27c0 42.688-31.51 79.614-77.026 97.146l-6.14-14.3c11.148-4.44 21.233-10.197 29.876-16.964 10.1-7.905 18.202-17.087 23.91-27.154-29.85-25.333-66.642-40.283-106.488-40.283-40.34 0-77.554 15.314-107.6 41.223 5.674 9.7 13.588 18.555 23.372 26.214 9.67 7.57 21.145 13.877 33.894 18.49l-6.125 14.264c-47.677-16.863-81.06-54.696-81.06-98.636 0-20.96 8.038-40.81 21.093-57.377zm10.286 183.128c.054-.004.1.004.127.037 18.414 23.35 51.93 39.697 91.086 43.162-5.892 19.698-26.99 34.53-52.67 34.53-30.21 0-55.148-20.584-55.148-45.517.002-12.465 6.205-23.997 16.11-32.173.083.094.33-.027.494-.04zm211.668.002c.053-.003.1.006.138.04 9.907 8.175 16.112 19.707 16.112 32.173 0 24.93-24.937 45.515-55.15 45.515-25.68 0-46.776-14.83-52.67-34.53 39.156-3.466 72.673-19.813 91.087-43.16.112.085.322-.03.483-.038zM258.4 244.174c5.625 27.42 13.928 54.84 32.91 82.26-20.274 5.432-44.818 5.627-65.82 0 17.968-27.42 26.834-54.84 32.91-82.26zm-76.31 175.54c-2.34 15.4-6.413 31.3-12.25 47.372a168.84 168.84 0 0 0 27.663 14.637c3.627-19.225 6.537-38.376 8.33-57.455a309.037 309.037 0 0 1-23.744-4.553zm152.802.48a409.42 409.42 0 0 1-22.526 3.888c1.777 18.972 4.655 38.015 8.248 57.13a169.154 169.154 0 0 0 26.452-14.126c-5.776-15.906-9.824-31.644-12.174-46.893zm-41.094 6.115c-8.335.8-16.668 1.323-24.975 1.58v65.694a157.874 157.874 0 0 0 33.973-6.01c-3.898-20.343-7.058-40.766-8.998-61.265zm-69.402.237c-1.953 20.54-5.13 41.002-9.043 61.385a157.903 157.903 0 0 0 34.783 5.773v-65.713a349.206 349.206 0 0 1-25.74-1.445z',   // 怪物 - 恶魔头骨
          必杀: 'M345.594 20.28c-11.443.087-23.37 1.194-36.094 3.845 33.485 7.004 54.532 21.844 65.844 39.22-15.476-2.647-30.64-4.472-45.47-5.532L311 40.374l-19.28 16.438c-7.537.167-14.98.55-22.314 1.156L239.97 41.78l-14.907 22.814a308.27 308.27 0 0 0-23.844 6.22l-29.47-14.97-11.313 30.75c-8.783 4.197-17.31 8.868-25.593 13.937l-32.688-5.31-.47 29.03a293.382 293.382 0 0 0-18.374 16.656H48l3.563 36.656c-4.38 5.908-8.603 12.045-12.688 18.375L18.47 192.25v39.5c-.012.02-.022.042-.032.063V493.28h18.5c23.523-92.965 94.565-130.4 168.968-85.25 42.127 25.566 93.783 62.296 149.063 41.158a64.325 64.325 0 0 1-6.908 22.562l95.344 19.188c2.99-7.75 5.584-15.712 7.625-23.563-3.557 2.29-10.352 4.79-19.78 3.313-41.302-6.47-33.15-54.034-.53-58.407 10.915-1.456 21.15 3.22 27.56 11.25l18.283-38.874c-68.1 6.078-129.61-30.834-197.47-16.687 35.468 7.415 56.983 23.64 67.75 42.342a150.88 150.88 0 0 1-21.28.157l-10.813-10.25-13.625 6.436a127.746 127.746 0 0 1-17.313-5.75l-7.718-15.47-10.906 5.97c-7.152-4.38-13.924-9.414-20.344-15.062l-1.813-26.75-19.436 5.03c-7.508-7.63-15.15-13.68-22.875-18.343l-1.282-19.75-23.875 9.408c-11.712-2.7-23.455-2.622-35.063-.25 44.223-90.392 134.06-92.4 180.813-64.563-5.227 5.68-11.388 10.355-18.125 13.78l66.562 70.908c6.928-4.58 13.63-9.564 19.844-14.782-4.228-.204-14.15-5.01-17.47-8.06-34.53-31.74 7.1-63.854 32.876-48.626 9.484 5.603 15.366 14.898 15.938 25.156l34.75-23.875c-59.015-34.522-85.098-97.445-148.594-125.25 23.092 24.968 31.707 49.115 30.97 69.75-8.93-6.752-18.606-12.1-28.845-16.188l-13.845-21.25-18.188 12.75a163.521 163.521 0 0 0-15.78-1.5l-19.094-18.093-15.25 19.687a223.404 223.404 0 0 0-23.844 4.564l-15.75-13-9.75 20.812a268.108 268.108 0 0 0-20.782 8.594l-23.594-8.28-8.625 25.874c-12.263 7.768-23.966 16.49-34.876 26.062C124.307 122.443 296.518 88.99 384.938 108.562a64.378 64.378 0 0 1-6.47 19.344l95.344 19.188c2.99-7.75 5.585-15.71 7.625-23.563-3.558 2.29-7.502 5.33-11.968 4.72-46.308-6.31-43.81-54.725-8.345-59.813 10.903-1.57 21.15 3.193 27.563 11.22 1-10.184 1.808-35.654 2.187-45.907-55.332 4.938-95.695-13.84-145.28-13.47z',   // 巨型生物 - 九头蛇
          奥义: 'M200.947 18.686c-6.98.087-14.64.774-22.85 1.9 27.57 20.468 51.098 45.25 67.594 70.527 1.66 0 3.312.012 4.958.047 18.066.39 35.487 2.906 53.217 7.2-15.695-28.457-29.935-50.19-47.45-63.22-13.817-10.278-30.063-16.168-52.52-16.454-.967-.013-1.95-.013-2.948 0zm-91.66 22.96c-.73-.002-1.46.006-2.195.022-14.045.31-29.36 3.92-46.86 11.13 56.18 18.807 106.985 50.468 133.907 83.585 18.377-5.13 29.44-14.72 36.454-28.817C195.84 78.18 168.118 56.19 140.65 46.96c-10.168-3.418-20.433-5.306-31.363-5.315zm-.203 52.786c-39.42 6.758-74.73 31.854-87.822 74.19v322.345h212.73C100.352 442.58 61.19 206.49 187.115 230.104c5.838-14.164 9.92-28.027 11.018-41.465l18.627 1.522c-1.684 20.592-8.828 40.49-18.033 59.943-.732 2.035-1.472 4.12-2.186 6.063 32.842 85.24 113.77 160.69 169.495 168.197.915.033 1.905-.002 2.953-.09 17.016 1.035 35.86-4.222 52.21-22.304l7.984-8.83-10.473-5.658c-6.507-3.515-14.29-7.094-18.167-10.925-1.938-1.916-2.793-3.47-3.074-5.194-.282-1.725-.13-4.227 2.23-8.578l10.673-19.656-21.484 6.222c-6.304 1.825-17.305-3.032-23.224-10.71-2.96-3.84-4.408-7.907-4.387-10.843.02-2.938.72-5.125 4.747-8.05l19.453-14.125-23.884-2.72c-9.974-1.137-16.37-6.658-19.17-12.294-2.802-5.634-2.312-10.084 1.375-13.31l12.204-10.677-15.358-5.205c-6.717-2.276-10.296-7.555-10.357-10.633-.028-1.373.238-2.666 1.843-4.476 10.93-2.39 21.258-.45 28.088 6.374 6.154 6.146 8.35 15.128 6.977 24.832 8.55-2.254 16.985-1.616 24.112 2.494 9.34 5.387 14.647 15.692 15.67 27.965 15.212-10.132 32.152-12.725 45.262-5.164 15.467 8.92 21.36 29.513 16.805 51.75 23.992-33.355 34.588-75.717 5.617-120.43-46.726-4.442-81.693-30.676-93.293-67.64-5.026-16.016-21.284-28.67-42-37.904l-.08.217c-29.74-10.823-55.575-17.35-82.604-18.733l.08.155c-2.294-.093-4.56-.16-6.762-.172-9.537 22.874-28.662 39.9-57.436 46.054l-5.906 1.262-3.576-4.864c-14.216-19.33-41.23-40.452-74.002-58.074zm156.215 65.26c27.927-.073 44.874 11.617 42.09 44.45-35.844 3.39-51.933-16.683-63.074-42.632 7.507-1.155 14.538-1.8 20.983-1.817zm48.407 66.363c3.708.07 7.14.994 10.014 2.812a35.171 35.171 0 0 0-4.16 3.543c-5.246 5.24-8.087 12.122-7.956 18.742.183 9.322 5.27 17.184 12.68 22.56-3.14 8.103-2.452 17.455 1.407 25.22 3.813 7.668 10.54 14.273 19.302 18.398-1.445 3.366-2.375 6.862-2.4 10.33-.062 8.407 3.38 16.042 8.273 22.39 6.792 8.81 16.862 15.936 28.026 17.91-.183 2.18-.204 4.333.133 6.407 1.05 6.444 4.515 11.66 8.38 15.48 3.41 3.37 7.19 5.892 10.798 7.993-6.345 4.792-12.414 7.056-18.618 7.79-6.515-7.937-9.71-19.084-9.41-31.454-11.767 6.177-24.21 7.156-34.12 1.44-14.668-8.46-19.393-29.036-13.187-50.33-11.336 2.77-22.13.92-29.187-6.132-8.875-8.865-9.535-23.626-3.094-37.95-3.676-.615-6.963-2.166-9.525-4.725-8.808-8.798-5.773-26.09 6.776-38.626 7.843-7.835 17.546-11.957 25.87-11.8z',   // 龙类 - 龙头
          觉醒一: 'm88.418 17.17-66.12 475.242h18.866l66.12-475.242H88.42zm315.7 0 66.023 475.242h18.87L422.988 17.17h-18.87zm-56.26.24-132.422.37c-59.343 41.506-78.325 97.982-61.596 168.03-22.324-31.34-32.747-63.248-33.59-98.234l-26.684 191.78c1.05-3.64 2.25-7.31 3.653-11.012l-3.843 12.385-4.934 35.454c.41 37.954 18.614 69.416 40.91 87.406-18.52-6.774-35.355-15.287-49.25-27.445l-9.207 66.152c43.032 20.635 88.614 24.346 120.56 17.78-33.542 18.813-71.344 29.428-125.382 16.886l-2.13 15.3h217.568c73.664-14.515 117.318-55.617 129.045-89.216 3.54 30.568-2.754 60.093-37.473 89.215h73.242l-41.553-299.11c-15.226-35.307-51.106-59.122-74.695-59.718 10.876-3.615 21.615-5.918 32.305-5.78 11.61.15 23.16 3.2 34.76 10.56l-4.207-30.278c-21.365-18.958-46.472-31.023-68.92-35.954 6.54-.477 13.043-.73 19.513-.685 15.23.104 30.273 1.868 45.18 6.21l-4.224-30.398C331.8 45.105 287.813 60.384 263.44 79.407c13.68-23.55 44.533-47.68 84.417-61.998zm-81.323 33.065c-68.785 37.085-71.87 82.26-36.1 122.146-7.626-69.52 80.94-110.016 118.96-59.032-40.867-20.17-77.79 7.84-76.21 47.723 23.234-23.997 98.678-13.267 79.795 36.19-11.3-33.297-56.74-30.094-63.648-13.77-14.75 34.866 64.34 14.582 98.117 66.284-18.85-10.875-47.74.482-39.22 14.59 32.28 53.45 84.53 113.185 13.3 147.025 23.57-38.677 10.786-65.734-21.85-81.43 25.644 66.744-5.1 163.717-103.81 133.19 62.83-11.442 78.355-62.576 57.263-83.425-23.617 60.37-122.14 97.174-181.444 38.453 58.693 22.535 99.285 7.31 120.644-26.39-35.89 21.435-95.375 6.933-113.994-42.977 28.694 29.187 67.102 37.963 91.195 20.356 13.217-9.658 8.303-25.06-8.55-29.402-24.53-6.32-61.988-12.852-76.563-36.588 21.722 6.003 43.444 10.698 65.166-3.375-33.985-22.07-81.546-50.75-50.348-100.278 1.008 35.15 17.23 56.557 53.197 48.254 9.285-2.142 16.8-15.472 8.55-23.373-61.138-58.54-47.58-160.406 65.548-174.168z',   // 召唤法阵 - 魔法传送门
          觉醒二: 'M324.97 17.54c.03.034.057.07.087.106l-34.924 32.428 36.904-3.752-15.396 30.12 38.048-16.075c26.147 69.965.623 154.277-52.555 166.262-6.554-25.37-34.13-37.945-36.055-57.382.303.093.604.187.912.27a27.113 27.113 0 0 0 14.274-.07l25.138 22.89 20.653-16.377c-7.363 2.836-28.588-1.402-33.25-13.923a27.114 27.114 0 0 0 6.793-11.922c.485-1.813.757-3.635.86-5.445l11.524 22.777 5.22-16.94c7.625 5.575 12.474 13.605 11.49 21.136l16.673-29.4-72.14-29.56-58.057-48.03 17.1 31.25-48.206-19.753 35.14 31.237c-40.602 28.158-22.085 85.04-1.796 119.29-57.5-9.685-103.128-77.435-95.763-145.03l49.21-21.366-31.08-5.14 29.207-33.417-32.015 11.54c.037-.067.07-.135.107-.202-168.36 66.33-116.413 367-63.728 417.99-.19-1.317-.364-2.58-.54-3.855-14.922-56.244-20.375-125.624-17.5-190.53 3.02-68.237 14.834-131.16 36.794-169.522l16.22 9.283c-18.894 33.008-31.4 94.563-34.345 161.064-1.942 43.86.106 90.022 6.275 132.082 6.124 1.892 15.046 9.615 27.295 23.24-4.818-13.35-6.78-26.5-6.482-38.28 20.286 41.665 67.34 69.234 104.633 62.308 22.444-4.17 41.803-12.73 57.81-24.475l7.31 15.418c-20.068 5.036-22.807 32.635-14.737 55.112 1.748-19.882 11.36-29.794 21.73-32.303-6.598 15.867-4.698 30.623-3.117 44.158 10.15-12.147 21.47-23.793 23.628-39.354 8.738 7.332 12.317 21.49 1.194 39.057 26.32-15.473 31.565-41.994 7.978-57.685l-32.07-34.297c5.918-5.55 11.24-11.6 15.947-18.066l39.28 15.776c-3.942 13.69 5.833 31.512 19.77 43.31-8.055-17.288-4.826-30.08 2.562-37.103 1.63 17.39 10.64 29.193 18.733 40.064 2.73-15.665 6.79-31.493-.213-45.987 11.016 1.56 21.2 11.568 20.338 31.877 14.362-25.313 6.11-49.702-20.742-51.52l-71.135-9.892c12.757-22.982 18.676-49.823 17.015-77.475 14.188-34.708 50.058-11.816 54.523 49.16C394.924 262.27 434.58 304 426.324 367.13c11.808-23.38 21.835-35.013 29.862-36.247-10.772-91.925-40.458-191.57-77.637-250.748l15.823-9.942c50.328 80.106 85.112 220.65 84.88 331.547 42.403-115.912-2.347-356.61-154.282-384.2zm-29.458 476.913-.026.016-.015.05c.015-.02.027-.044.042-.067zm26.543-318.492h.01v-.007l-.01.008zm-53.348-41.716a9.127 9.127 0 0 1 2.652.313c4.774 1.28 7.467 5.945 6.187 10.72-1.28 4.776-5.943 7.47-10.72 6.19-4.775-1.28-7.468-5.943-6.188-10.72.96-3.584 3.823-5.993 7.21-6.435a8.66 8.66 0 0 1 .857-.068zM204.904 297.13c11.878-.2 22.637 6.756 26.172 22.487-.008 35.88-9.557 68.823-42.137 77.412-27.624 7.283-69.725-11.398-84.12-53.663 12.28-21.078 37.362-21.986 62.838 22.592-12.583-41.596 14.386-68.444 37.246-68.83z',   // 飞龙 - 翼龙
          觉醒三: 'M254.885 21.08c-31.185 0-58.496 32.517-58.496 75.092 0 42.575 27.31 75.09 58.495 75.09 31.186 0 58.498-32.515 58.498-75.09S286.07 21.08 254.885 21.08zm-32.262 52.078h18.69v45.723h-18.69V73.16zm43.803 0h18.69v45.723h-18.69V73.16zm43.943 88.28c-13.86 17.468-33.346 28.51-55.485 28.51-21.33 0-40.192-10.257-53.938-26.626-11.126 4.16-20.024 11.688-27.67 22.285-9.668 13.403-16.88 31.75-21.923 52.71-4.735 19.677-7.546 41.513-9.202 63.61 7.876 4.015 14.466 9.84 19.61 16.782 6.746 9.102 11.316 19.966 14.56 31.75 3.395-11.403 7.95-21.896 14.324-30.75 5.08-7.054 11.502-13.04 19.155-17.183-4.61-9.605-7.21-20.688-7.21-32.29 0-34.46 22.86-64.393 53.572-64.393 30.713 0 53.572 29.934 53.572 64.392 0 10.913-2.3 21.368-6.408 30.565 8.922 4.012 16.312 10.29 21.96 17.91 6.942 9.368 11.577 20.603 14.837 32.784 3.426-11.803 8.064-22.662 14.633-31.785 4.46-6.194 9.956-11.564 16.41-15.587-1.083-23.328-3.275-46.454-7.752-67.144-4.568-21.113-11.505-39.48-21.326-52.777-8.29-11.223-18.313-18.974-31.72-22.764zM89.95 224.532c-16.32 0-31.497 15.67-34.386 37.99H79.81v18.687H56.083c3.874 20.57 18.353 34.73 33.867 34.73 15.513 0 29.992-14.16 33.866-34.73H98.5V262.52h25.834c-2.888-22.32-18.066-37.99-34.385-37.99zm166.212 0c-16.32 0-31.496 15.67-34.385 37.99h24.16v18.687h-23.642c2.92 15.51 11.873 27.37 22.75 32.27-6.347.482-12.23 1.242-17.117 2.2l-.028.007-.027.005c-9.335 1.772-16.13 6.7-22.06 14.937-5.93 8.236-10.528 19.833-13.745 33.25-5.746 23.972-7.066 53.275-7.297 79.29h23.503V392.12h18.69v103.025h61.906V392.12h18.687v51.048h21.91c-.044-26.343-.5-56.035-5.776-80.164-2.947-13.486-7.4-25.042-13.42-33.166-6.02-8.124-13.142-13.033-23.68-14.682l-.194-.03-.19-.038c-5.24-1.045-11.492-1.713-18.09-2.01 10.496-5.12 19.068-16.76 21.913-31.87h-25.403V262.52h25.92c-2.888-22.32-18.066-37.99-34.385-37.99zm165.992 0c-16.32 0-31.496 15.67-34.384 37.99h24.296v18.687h-23.78c3.875 20.57 18.354 34.73 33.868 34.73 15.514 0 29.993-14.16 33.867-34.73h-25.266V262.52h25.785c-2.89-22.32-18.066-37.99-34.386-37.99zm-294.564 91.6c-9.507 11.333-22.63 18.493-37.64 18.493-13.795 0-25.996-6.05-35.263-15.824-4.983 2.6-9.165 6.523-12.984 11.827-5.93 8.236-10.528 19.833-13.744 33.25-5.747 23.972-7.067 53.275-7.298 79.29h23.252V392.12h18.688v103.025h61.906V392.12h18.69v51.048h22.745c-.043-26.342-.5-56.035-5.775-80.164-2.948-13.486-7.4-25.042-13.422-33.166-5.115-6.902-11.032-11.474-19.156-13.707zm331.344 1.013c-9.432 10.746-22.22 17.48-36.78 17.48-14.395 0-27.065-6.574-36.465-17.11-6.246 2.505-11.26 6.852-15.768 13.114-5.93 8.236-10.528 19.833-13.744 33.25-5.747 23.972-7.066 53.275-7.297 79.29h22.927V392.12h18.69v103.025H452.4V392.12h18.688v51.048h22.498c-.018-26.37-.353-56.076-5.504-80.21-2.88-13.486-7.266-25.037-13.23-33.147-4.393-5.972-9.388-10.195-15.92-12.667z'    // 亡灵君主 - 仆从
        },

        // ========== 特殊技能 (Special) ==========
        // 特殊技能图标风格：被动、Buff、辅助、知识
        特殊: {
          基础: 'm102.53 26.063 90 345.75 289.22 23.25-90.03-345.72-289.19-23.28zm-18.968 1.406c-30.44 11.894-55.62 53.07-49.687 75.28l3.25 11.813c.654-1.722 1.345-3.44 2.063-5.157C49.102 85.688 65.734 62.636 89.56 50.5l-6-23.03zM94.44 69.187c-16.66 10.016-29.916 28.1-38 47.437-5.2 12.44-8 25.417-8.75 36.25v.03L112.56 388.5c.305-.572.593-1.148.907-1.72 10.585-19.223 27.804-37.623 51.06-48.405L94.438 69.187zM154 107.968l239.78 16.188-1.28 18.625-239.75-16.155L154 107.97zm46.03 34.407 5.657 8.875 14.188 22.313 39.03-15.25 7.595-2.938 3.97 7.094 16.28 29.124 4.313 7.72-7.438 4.717c-10.267 6.524-17.392 12.284-21.75 16.782-3.03 3.13-4.247 5.232-4.906 6.594 1.38.303 3.433.577 6.624.28 18.268-1.69 56.285-19.964 79-61.592l5.47-10.03 8.748 7.374 46 38.812 11.532 9.72-13.844 6-33.28 14.374c5.447 4.925 11.436 5.916 18.436 5.406 9.95-.724 21.427-6.07 29.125-11.063l10.158 15.657c-9.41 6.1-22.867 12.934-37.938 14.03-15.07 1.098-32.27-5.296-42.594-23.155l-5.25-9.095 9.625-4.156 30.44-13.157-26.033-22c-25.716 40.294-62.68 59.168-87.843 61.5-6.78.628-12.945.26-18.594-2.688-5.65-2.95-9.984-10.6-9-17.406.984-6.806 4.838-12.4 10.688-18.44 4.385-4.526 10.612-9.367 17.875-14.436l-8.188-14.656L219.5 193.75l-7.156 2.78-4.125-6.468L196 170.875c-6.308 7.158-9.485 14.528-9 21.406.654 9.28 7.854 21.054 30.594 33.69l-9.094 16.343c-25.688-14.273-38.877-31.016-40.125-48.72-1.248-17.703 9.393-33.013 23.5-44.562l8.156-6.655zm-5.968 118.188 239.782 16.156-1.25 18.655-239.78-16.188 1.25-18.625zm-24.75 96.25c-17.637 9.072-31.065 23.708-39.468 38.968-4.49 8.153-7.307 16.452-8.72 23.876l11.626 42.156 1.688.157c-3.824-27.514 11.358-60.383 41.187-80.97l-6.313-24.188zm26.22 34c-32.403 17.28-46.273 52.303-41.657 72.78l289.78 24.532c-5.298-7.743-8.625-17.827-8.592-28.313l-22.47-9.03 46.626-7.313-13.69-13.064c5.552-6.838 13.54-12.915 24.47-17.53l-274.47-22.063z',   // 基础知识 - 书本
          转职: 'm251.828 15.982-29.2 136.08-56.74-75.652 7.78 90.4-49.154-24.68 22.19 49.643-67.16-13.433 57.817 70.668-55.48-10.514 35.634 26.608c29.894.77 62.017-2.565 90.597 4.35 18.697 4.522 36.167 14.302 48.255 32.74.414.632.82 1.274 1.22 1.923.402-.65.806-1.29 1.22-1.922 12.088-18.44 29.558-28.22 48.254-32.742 27.64-6.685 58.596-3.782 87.643-4.28l35.25-26.676-42.05 8.178 41.468-80.596-59.507 19.852 19.092-77.352-57.234 59.867 6.055-109.607-46.232 97.31-39.715-140.164zM92.236 281.787 50.27 311.02l207.343 72.68 207.337-73.03-40.99-28.88c-42.595 7.18-92.04-5.54-126.02 10.345l-.116.05-.013.008c-5.226 2.37-9.962 5.418-14.255 9.382-7.564 6.774-13.817 16.048-18.36 28.694l-7.777 13.763-7.158-12.67c-5.434-15.833-13.453-26.5-23.324-33.637-.157-.114-.316-.22-.473-.332a57.992 57.992 0 0 0-1.912-1.302c-33.565-21.772-86.63-6.6-132.314-14.3zm-64.26 41.3L21.81 340.73l190.67 66.674v17.817h91.55v-18.687h-.055L492.15 340.73l-6.168-17.642-205.658 71.918 4.03 11.527h-54.75l4.03-11.527-205.657-71.918z',   // 进阶秘籍 - 启蒙
          进阶: 'M320.938 13.28c-16.646 34.584-38.466 60.157-63.094 60.157-24.522 0-47.035-25.275-63.656-59.593.366 39.358-9.71 90.884-30.938 105.125-21.228 14.24-49.64-12.002-78.844-32.126 17.455 34.04 42.095 67.5 29.78 92.28-12.21 24.576-59.172 35.96-92.874 35.626 29.338 19.29 78.842 45.803 78.844 74.188.002 28.384-49.504 53.71-78.844 73 33.702-.333 80.663 11.612 92.876 36.187 12.227 24.61-9.03 56.31-33.75 85.563 44.826-15.413 65.142-5.735 85.374 10.812h31.75c-42.74-35.413-72.062-107.828-72.062-191.563-.002-118.62 58.92-214.906 131.406-214.906 72.488 0 131.406 96.29 131.406 214.907 0 83.74-29.317 156.153-72.062 191.563h27.313c19.847-14.62 39.796-25.65 89.687-9.28-26.233-30.264-42.2-62.484-29.97-87.095 12.257-24.665 56.658-36.612 90.533-36.188-29.4-19.297-75.344-44.584-75.344-73 0-28.415 45.943-54.89 75.342-74.187-33.874.424-78.273-10.962-90.53-35.625-12.315-24.78 9.982-58.24 27.437-92.28-29.202 20.12-57.583 46.385-78.845 32.124-21.262-14.263-31.382-66.13-30.938-105.69zm-68.97 93.75c-19.56 2.543-37.343 25.564-37.343 55.407 0 16.447 5.67 30.986 14 41.032l10.156 12.218-15.593 2.937c-10.815 2.035-18.743 7.737-25.53 17.063-6.79 9.325-11.984 22.344-15.626 37.343-6.585 27.128-8.078 60.24-8.31 89.47h36.093l.656 8.656 9.124 122.563h76.187l8.095-122.5.563-8.72h34.375c-.026-29.592-.44-63.166-6.407-90.5-3.295-15.095-8.287-28.096-15.156-37.313-6.87-9.216-15.133-14.897-27.28-16.78l-15.94-2.47 10.064-12.593c7.97-9.996 13.375-24.36 13.375-40.406-.002-31.817-19.884-55.313-41.44-55.313-2.54 0-3.96-.103-4.03-.094h-.03z',   // 领域光环 - 光环
          必杀: 'M163.5 17.75c-125.028 2.135-223.03 231.994-9.188 461.625-197.34-240.608 9.41-548.496 174.157-289.03C287.353 66.332 222.42 16.744 163.5 17.75zm201.78 4.656c197.34 240.608-9.41 548.528-174.155 289.063C319.482 698.622 679.9 360.254 365.28 22.405zm-98.31 155.75c-42.422 0-76.814 34.392-76.814 76.813 0 42.42 34.392 76.81 76.813 76.81 42.42 0 76.81-34.39 76.81-76.81 0-42.422-34.39-76.814-76.81-76.814z',   // 预言/魔法 - 专注宝珠
          奥义: 'M57.78 23.135c-1.517 29.085-2.193 55.608-2.266 80.316 6.56-2.716 13.703-4.333 21.228-4.333 31.245 0 56.883 25.64 56.883 56.887 0 31.246-25.777 56.3-56.883 56.3-6.068 0-11.95-1.003-17.488-2.77C71.906 332.82 108.064 376.35 147.668 401.9c20.677 13.34 42.986 21.7 64.268 33.245 17.444 9.463 34.177 21.525 47.42 40.127 13.23-18.597 29.925-30.658 47.324-40.122 21.226-11.545 43.46-19.904 64.064-33.242 39.46-25.543 75.488-69.07 88.135-192.324-5.32 1.708-10.974 2.723-16.907 2.723-31.107 0-56.88-25.058-56.88-56.3 0-31.244 25.634-56.888 56.88-56.888 7.63 0 14.745 1.697 21.23 4.508-.07-24.757-.745-51.334-2.265-80.49-59.488 13-130.78 19.266-201.5 19.888h-.163c-70.718-.62-142.008-6.888-201.496-19.888zm304.124 39.32-27.117 93.18-17.945-5.22 11.504-39.532-85.116 63.646-11.19-14.97 129.864-97.105zm-205.394 1.01 81.732 59.512-11 15.107-34.338-25.004 34.79 103.514-17.714 5.955-53.47-159.085zm140.486 99.652 129.383 97.95-98.25-.48.09-18.69 42.15.208-84.653-64.087 11.28-14.9zm-122.357 37.71 10.83 15.228-36.206 25.754 104.898-.17.03 18.69-163.577.262 84.024-59.766zm117.79 21 17.806 5.675-49.39 155.008-31.248-96.46 17.777-5.76 13.324 41.124 31.73-99.586z',   // 核心力量 - 魔法盾
          觉醒一: 'm173.625 15.72 16.156 53.81-94.374-48.905L158.47 98.25 45.187 117.406l113.28 19.625-59.718 75.19 65.03-33.407-1.78 58.843 19.844-37.344v-64.218l.75-1.75 31.906-74.75-40.875-43.875zm146.25 0L282.97 55.343l33.342 79.03.75 1.75v69.723l15.5 29.187-1.625-54.436 65.532 34.062-63.064-77.625 113.28-19.624-113.28-19.156 63.063-77.625-92.44 47.906 15.845-52.81zm-70.595 7.84-49.186 114.5v153.5l34.936 34.94c2.916-65.435 7.976-128.936 15.25-187.72 7.606 61.433 12.744 128.775 15.532 198l32.625-32.624V138.062l-49.156-114.5zM33.126 206.845l37.344 94.062 193.905 193.938h30.813c-66.34-68.503-128.483-139.002-180.625-205.875 74.705 58.246 155.104 130.333 231.312 205.874h31.063L126.813 244.688l-93.688-37.844zm444.844 0-93.626 37.812L268.75 360.25l18.156 18.125c36.278-32.102 72.315-62.265 107.125-89.406-27.302 35.015-57.36 71.02-89.31 107.217L325.06 416.5l115.532-115.53 37.375-94.126zM186.06 442.938l-51.906 51.906h28.594a3170.977 3170.977 0 0 1 38.094-37.125l-14.78-14.783zm39.375 39.406c-3.995 4.173-8.003 8.34-12.03 12.5h24.53l-12.5-12.5z',   // 觉醒洞察 - 全力一击
          觉醒二: 'M420.402 19.873c37.886 49.484 19.76 88.205-39.797 90.787 15.374-23.54 18.565-50.758-1.503-72.215 15.56 37.318-14.397 62.848-50.137 67.096-4.39-.934-8.887-1.99-13.508-3.19-60.132-15.624-114.527 22.936-137.37 78.923-.43-34.33 9.72-68.377 29.83-102.152-50.37 35.038-75.926 89.323-72.616 166.003l-59.41-65.365L89.55 374.43l164.6 119.595L392.703 389.54l52.584-196.853-93.224 72.415c-23.56-25.652-13.02-55.2 33.736-50.293-38.077-22.19-64.97-2.473-75.952 24.356-5.608-27.825 18.206-63.122 50.218-58.686 76.728 10.638 151.882-107.834 60.336-160.607zM119.838 272.05l94.777 73.214-103.095-21.22 29.263-3.05-20.945-48.943zm255.48 12.237-10.623 25.262 27.8-.28-12.095 23.437-96.25 14.438 91.168-62.858zM204.305 360.13l42.256 62.552 11.247-44.094 17.84 32.598 56.574-48.54-7.23 24.368 51.71-21.274-54.485 61.82 9.654-29.966-76.21 71.62-47.574-55.136 3.176 27.483-74.627-77.593 61.166 29.998 6.505-33.834z',   // 深渊凝视 - 火花精灵
          觉醒三: 'M115.063 21.97v9.343c0 101.953 38.158 189.648 96.343 222.093v6.094c-58.186 32.445-96.344 120.14-96.344 222.094v9.344H401.81v-9.344c0-102.552-38.804-190.274-97.53-222.188V253.5c58.722-31.917 97.53-119.64 97.53-222.188V21.97H115.06zM134 40.655h248.875c-2.477 96.445-42.742 175.523-91.938 198.906l-5.343 2.532v28.751l5.344 2.53c49.193 23.383 89.456 102.438 91.937 198.876H134c2.456-95.898 42.125-175.078 90.875-198.938l5.25-2.562v-28.594l-5.25-2.562c-48.748-23.86-88.42-103.04-90.875-198.938zm213.656 86.125c-57.607 27.81-124.526 27.84-177.562 4.095C184.748 181.78 213.91 218.012 248.22 224a12.178 12.178 0 0 0-2.47 7.344c0 6.76 5.488 12.25 12.25 12.25s12.25-5.49 12.25-12.25c0-2.72-.907-5.218-2.406-7.25 35.426-5.88 65.488-44.07 79.812-97.313zM258 258.626c-6.762 0-12.25 5.488-12.25 12.25s5.488 12.25 12.25 12.25 12.25-5.488 12.25-12.25-5.488-12.25-12.25-12.25zm0 39.28c-6.762 0-12.25 5.49-12.25 12.25 0 6.763 5.488 12.25 12.25 12.25s12.25-5.487 12.25-12.25c0-6.76-5.488-12.25-12.25-12.25zm0 39.533c-6.762 0-12.25 5.488-12.25 12.25 0 6.76 5.488 12.25 12.25 12.25s12.25-5.49 12.25-12.25c0-6.762-5.488-12.25-12.25-12.25zm.125 39.906c-23.21.28-46.19 25.77-75.813 75.656h153c-30.523-51.003-53.977-75.936-77.187-75.656z'    // 终焉 - 时间之沙
        },

        // ========== 职业特殊 ==========
        职业特殊: 'M259.738 20.38c-40.36-.244-81.305 9.895-118.744 31.51C28.566 116.8-10.03 260.837 54.88 373.265c64.91 112.427 208.947 151.024 321.376 86.113 77.686-44.852 120.106-127.485 117.498-211.363-3.575 65.865-35.942 128.62-91.082 169.41a217.975 217.975 0 0 1-35.762 25.767C263.228 503.053 130.926 467.6 71.066 363.92 11.206 260.238 46.66 127.936 150.34 68.076 185.98 47.5 225 38.183 263.3 39.03c73.12 1.62 143.6 40.28 182.883 108.32.648 1.122 1.277 2.25 1.9 3.38a20.217 20.217 0 0 1 1.258 6.997c0 11.29-9.152 20.44-20.442 20.44-6.85 0-12.894-3.38-16.6-8.556a172.05 172.05 0 0 0-2.355-4.276c-.014-.035-.03-.068-.045-.104l-.01.004c-.15-.263-.293-.53-.445-.793-31.91-55.27-89.762-86.377-149.363-86.835-1.923-.014-3.848.002-5.773.05-28.007.718-56.228 8.227-82.162 23.2-82.99 47.914-111.498 154.31-63.584 237.3 2.93 5.072 6.08 9.936 9.426 14.597L95.65 365.648l9.344 16.184 24.848-14.348c53.686 59.734 143.727 75.99 216.017 34.254 51.455-29.707 81.957-81.898 86.294-137.05-12.315 44.767-41.423 85.652-83.564 113.128a157.831 157.831 0 0 1-12.076 7.737C273.02 422.21 194.6 408.96 146.41 357.92l45.278-26.143 19.99 34.625 16.185-9.343-16.707-28.937c24.072-21.104 54.165-23.015 62.973-5.96 93.825-32.597 231.378-110.21 190.755-180.57l-.4.173a200.266 200.266 0 0 0-2.118-3.764c-42.597-73.78-119.27-115.764-198.724-117.565-1.3-.03-2.603-.048-3.905-.056zm.283 75.823c53.167.368 104.69 28.135 133.238 77.582.19.33.37.66.556.99-48.784 49.337-134.526 98.727-200.175 123.002l-15.1-26.148-16.183 9.343 19.987 34.62-48.08 27.76a157.102 157.102 0 0 1-9.518-14.544c-42.864-74.244-17.5-168.905 56.744-211.77 23.2-13.394 48.396-20.127 73.38-20.786 1.72-.045 3.436-.063 5.15-.05z'   // 旋转之剑
      };

      const getParent = () => {
        try { return getCore().window; } catch (e) { return window; }
      };
      const getSkillSvg = (type, tier) => {
        let mainType = '主动';
        if (type === '召唤') mainType = '召唤';
        else if (type === '特殊' || type === '被动' || type === '辅助') mainType = '特殊';
        else if (type === '职业特殊') mainType = '职业特殊';
        let pathData = '';
        if (mainType === '职业特殊') {
          pathData = SKILL_SVG_PATHS['职业特殊'] || '';
        } else {
          const tierKey = tier || '基础';
          pathData = SKILL_SVG_PATHS[mainType]?.[tierKey] || '';
        }
        const isEmpty = !pathData;
        const opacity = isEmpty ? '0.3' : '1';
        const finalPath = pathData || DEFAULT_SVG;
        return `<svg class="skill-icon-svg" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" style="opacity:${opacity}"><path fill="currentColor" d="${finalPath}"/></svg>`;
      };
      const getBuffIcon = (name, isDebuff) => {
        if (name.includes('加速') || name.includes('疾风')) return 'ri-speed-line';
        if (name.includes('强壮') || name.includes('力量')) return 'ri-muscle-line';
        if (name.includes('护盾') || name.includes('防御')) return 'ri-shield-check-line';
        if (name.includes('治疗') || name.includes('恢复')) return 'ri-heart-add-line';
        if (name.includes('潜行')) return 'ri-eye-off-line';
        if (name.includes('流血')) return 'ri-drop-line';
        if (name.includes('中毒')) return 'ri-flask-line';
        if (name.includes('致盲')) return 'ri-eye-close-line';
        if (name.includes('火') || name.includes('炎')) return 'ri-fire-line';
        if (name.includes('冰') || name.includes('霜')) return 'ri-snowflake-line';
        if (name.includes('雷') || name.includes('电')) return 'ri-flashlight-line';
        if (name.includes('暗') || name.includes('鬼') || name.includes('冥')) return 'ri-sparkling-fill';
        return isDebuff ? 'ri-skull-line' : 'ri-sparkling-fill';
      };
      // ==================== 弹窗系统 ====================
      const tierColors = {
        '基础': '#95a5a6', '转职': '#3498db', '进阶': '#9b59b6',
        '必杀': '#e67e22', '奥义': '#e74c3c', '觉醒一': '#f1c40f',
        '觉醒二': '#e84393', '觉醒三': '#2c3e50'
      };

      const removePopup = () => {
        document.getElementById('bottom-popup')?.remove();
      };

      const bindPopupClose = () => {
        const popup = document.getElementById('bottom-popup');
        if (!popup) return;
        // 点击关闭按钮
        popup.querySelector('.popup-close')?.addEventListener('click', removePopup);
        // 点击遮罩层关闭
        popup.addEventListener('click', (e) => {
          if (e.target === popup) removePopup();
        });
      };

      // 尝试调用父窗口状态栏.js的弹窗，否则本地弹窗
      const showStatusPopup = (name, effect) => {
        const win = getParent();
        const fn = win.rpg_status_bar_showPopup;
        if (fn) { fn('status', name, effect); return; }
        // 本地弹窗
        removePopup();
        const isDebuff = effect.类型 === 'DEBUFF';
        const typeColor = isDebuff ? '#e94560' : '#27ae60';
        const duration = effect.持续时间 || '永久';
        const desc = effect.描述 || '无描述';
        const attrEffects = effect.属性影响 || {};
        const special = effect.特殊影响 || '';
        let attrHtml = '';
        if (Object.keys(attrEffects).length > 0) {
          attrHtml = '<div class="f-data-group">' +
            Object.entries(attrEffects).map(([k, v]) =>
              `<div class="f-data-row"><span class="f-data-label"><i class="ri-arrow-right-s-line"></i> ${k}</span><span class="f-data-val ${v >= 0 ? 'val-positive' : 'val-negative'}">${v >= 0 ? '+' : ''}${v}</span></div>`
            ).join('') + '</div>';
        }
        const html = `<div id="bottom-popup" class="fusion-popup-overlay">
          <div class="fusion-card" style="--quality-color: #2D3436">
            <button class="popup-close"><i class="ri-close-line"></i></button>
            <div class="f-header">
              <div class="f-meta-row">
                <span class="f-quality" style="background:none;-webkit-background-clip:unset;-webkit-text-fill-color:${typeColor};color:${typeColor}">${effect.类型 || 'BUFF'}</span>
                <span class="f-type">// 状态效果</span>
              </div>
              <div class="f-title-row"><span class="f-name" style="-webkit-text-fill-color:${typeColor}">${name}</span></div>
            </div>
            <div class="f-stat-bar">
              <div class="f-mini-stat"><span class="f-ms-label">持续时间</span><span class="f-ms-val">${duration}</span></div>
            </div>
            <div class="f-content">
              ${attrHtml}
              <div class="f-section-title"><i class="ri-file-text-line"></i> 描述</div>
              <div class="f-effect-box">${desc}</div>
              ${special ? `<div class="f-section-title"><i class="ri-magic-line"></i> 特殊效果</div><div class="f-effect-box">${special}</div>` : ''}
            </div>
          </div>
        </div>`;
        app.insertAdjacentHTML('afterend', html);
        bindPopupClose();
      };
      const showSkillPopup = (skillName, slotType) => {
        const win = getParent();
        const fn = win.rpg_status_bar_showPopup;
        const data = fetchLatestMvuData();
        const skillTree = data?.人物?.技能树 || {};
        const 技能列表 = skillTree.技能列表 || {};
        const 技能槽 = skillTree.技能槽 || {};
        const allSlots = { ...技能槽.主动技能槽, ...技能槽.觉醒技能槽 };
        const skillData = 技能列表[skillName] || allSlots[skillName] || {};
        if (fn) { fn('skill', skillName, skillData); return; }
        // 本地弹窗
        removePopup();
        const tier = skillData.阶位 || '基础';
        const typeStr = skillData.类型 || '技能';
        const tierConfig = TIER_CONFIG[tier] || {};
        const level = skillData.当前等级 || skillData.技能等级 || 0;
        const maxLevel = tierConfig.等级上限 || skillData.等级上限 || 1;
        const cd = tierConfig.冷却 || skillData.冷却 || 0;
        const spCost = tierConfig.SP消耗 || 0;
        const requiredLevel = tierConfig.习得等级 || 1;
        const desc = skillData.描述 || '';
        const dmg = calcSkillDamage({ ...skillData, 当前等级: level });
        const special = getSpecialEffect(skillData);
        const tierColor = tierColors[tier] || '#95a5a6';
        const charLevel = data?.人物?.等级 || 1;
        const isUnlocked = charLevel >= requiredLevel;

        // 判断是否有其他可装备的技能
        const isAwk = slotType === '觉醒技能槽';
        const awkTiers = new Set(['觉醒一', '觉醒二', '觉醒三']);
        const currentSlot = 技能槽[slotType] || {};
        const equippedNames = new Set(Object.keys(currentSlot));
        const availableOthers = Object.entries(技能列表).filter(([n, s]) => {
          if (n === skillName) return false;
          if (equippedNames.has(n)) return false;
          const t = s.阶位 || '基础';
          if (isAwk ? !awkTiers.has(t) : awkTiers.has(t)) return false;
          // 只显示当前等级已解锁且已学习的技能
          const tierCfg = TIER_CONFIG[t];
          if (tierCfg && charLevel < tierCfg.习得等级) return false;
          if ((s.当前等级 || 0) === 0) return false;
          return true;
        });

        const html = `<div id="bottom-popup" class="fusion-popup-overlay">
          <div class="fusion-card" style="--quality-color: ${tierColor}">
            <button class="popup-close"><i class="ri-close-line"></i></button>
            <div class="f-header">
              <div class="f-meta-row">
                <span class="f-quality">${tier}</span>
                <span class="f-type">// ${typeStr}</span>
              </div>
              <div class="f-title-row"><span class="f-name">${skillName}</span></div>
            </div>
            <div class="f-stat-bar">
              <div class="f-mini-stat"><span class="f-ms-label">等级</span><span class="f-ms-val">${level} <span style="font-size:0.8em;opacity:0.6">/ ${maxLevel}</span></span></div>
              <div class="f-mini-stat"><span class="f-ms-label">阶位</span><span class="f-ms-val" style="color:${tierColor}">${tier}</span></div>
              <div class="f-mini-stat"><span class="f-ms-label">解锁</span><span class="f-ms-val" style="color:${isUnlocked ? '#27ae60' : '#e74c3c'}">${isUnlocked ? '✓' : 'Lv.' + requiredLevel}</span></div>
            </div>
            <div class="f-content">
              <div class="f-data-group">
                ${spCost > 0 ? `<div class="f-data-row"><span class="f-data-label"><i class="ri-star-line"></i> SP消耗/级</span><span class="f-data-val">${spCost}</span></div>` : ''}
                ${cd > 0 ? `<div class="f-data-row"><span class="f-data-label"><i class="ri-timer-line"></i> 冷却</span><span class="f-data-val">${cd} 回合</span></div>` : ''}
                ${dmg > 0 ? `<div class="f-data-row"><span class="f-data-label"><i class="ri-sword-line"></i> 伤害倍率</span><span class="f-data-val val-positive">${dmg}%</span></div>` : ''}
              </div>
              <div class="f-section-title"><i class="ri-file-text-line"></i> 描述</div>
              <div class="f-effect-box">${desc || '无'}</div>
              ${special ? `<div class="f-section-title"><i class="ri-magic-line"></i> 当前效果 (Lv.${level})</div><div class="f-effect-box">${special}</div>` : ''}
            </div>
            ${slotType ? `<div style="display:flex;gap:8px;padding:12px 16px;border-top:1px solid #f0f0f0;">
              <button class="skill-action-btn skill-unequip" style="flex:1;padding:8px;border:1px solid #e0e0e0;border-radius:8px;background:#fff;cursor:pointer;font-size:0.75rem;color:#e74c3c;font-weight:600;">
                <i class="ri-delete-back-2-line"></i> 卸下
              </button>
              ${availableOthers.length > 0 ? `<button class="skill-action-btn skill-change" style="flex:1;padding:8px;border:1px solid #dfe6e9;border-radius:8px;background:#f8f9fa;cursor:pointer;font-size:0.75rem;color:var(--text-main);font-weight:600;">
                <i class="ri-refresh-line"></i> 更换
              </button>` : ''}
            </div>` : ''}
          </div>
        </div>`;
        app.insertAdjacentHTML('afterend', html);
        // 卸下
        if (slotType) {
          document.querySelector('.skill-unequip')?.addEventListener('click', () => {
            applyMvuPatches([
              { op: 'remove', path: `/人物/技能树/技能槽/${slotType}/${skillName}` },
              // 同步更新技能列表中的是否装备状态
              { op: 'replace', path: `/人物/技能树/技能列表/${skillName}/是否装备`, value: false }
            ]);
            removePopup();
            setTimeout(refresh, 100);
          });
          document.querySelector('.skill-change')?.addEventListener('click', () => {
            removePopup();
            openSkillPicker(slotType, skillName);
          });
        }
        bindPopupClose();
      };


      // 技能选择器
      const openSkillPicker = (slotType, replaceSkillName) => {
        document.getElementById('combo-picker-overlay')?.remove();
        const d = fetchLatestMvuData();
        const skillTree = d?.人物?.技能树 || {};
        const 技能列表 = skillTree.技能列表 || {};
        const 技能槽 = skillTree.技能槽 || {};
        const equippedAll = new Set([
          ...Object.keys(技能槽.主动技能槽 || {}),
          ...Object.keys(技能槽.觉醒技能槽 || {})
        ]);
        const isAwk = slotType === '觉醒技能槽';
        const awkTiers = new Set(['觉醒一', '觉醒二', '觉醒三']);

        const charLevel = d?.人物?.等级 || 1;
        const available = Object.entries(技能列表).filter(([name, skill]) => {
          if (equippedAll.has(name)) return false;
          const t = skill.阶位 || '基础';
          if (isAwk ? !awkTiers.has(t) : awkTiers.has(t)) return false;
          // 只显示当前等级已解锁的技能
          const tierCfg = TIER_CONFIG[t];
          if (tierCfg && charLevel < tierCfg.习得等级) return false;
          // 只显示已学习的技能（等级 > 0）
          if ((skill.当前等级 || 0) === 0) return false;
          return true;
        });

        if (available.length === 0) return;

        let listHtml = '';
        available.forEach(([name, skill]) => {
          const tier = skill.阶位 || '基础';
          const tierColor = tierColors[tier] || '#95a5a6';
          const lv = skill.当前等级 || 0;
          const typeStr = skill.类型 || '主动';
          const iconSvg = getSkillSvg(typeStr, tier);
          listHtml += `<div class="combo-picker-item" data-equip-skill="${name}" data-slot-type="${slotType}">
            <div style="width:32px;height:32px;display:flex;align-items:center;justify-content:center;flex-shrink:0;color:${tierColor};">${iconSvg}</div>
            <div class="combo-picker-info">
              <div class="combo-picker-bond-name">${name}</div>
              <div class="combo-picker-skill-name" style="color:var(--text-sub)">${typeStr} · ${tier} · Lv.${lv}</div>
            </div>
          </div>`;
        });

        const title = isAwk ? '选择觉醒技能' : '选择技能';
        const overlayHtml = `<div class="combo-picker-overlay" id="combo-picker-overlay">
          <div class="combo-picker">
            <div class="combo-picker-title" style="color:var(--text-main)"><i class="ri-sword-line"></i> ${title}</div>
            <div class="combo-picker-list">${listHtml}</div>
          </div>
        </div>`;
        document.body.insertAdjacentHTML('beforeend', overlayHtml);
        const overlay = document.getElementById('combo-picker-overlay');
        requestAnimationFrame(() => overlay?.classList.add('show'));
        overlay?.addEventListener('click', (e) => {
          if (e.target === overlay) { overlay.remove(); return; }
          const item = e.target.closest('[data-equip-skill]');
          if (!item) return;
          equipSkillToSlot(item.dataset.equipSkill, item.dataset.slotType, replaceSkillName);
          overlay.remove();
        });
      };

      const equipSkillToSlot = (skillName, slotType, replaceSkillName) => {
        const d = fetchLatestMvuData();
        const skill = d?.人物?.技能树?.技能列表?.[skillName] || {};
        const slotData = {
          名称: skillName,
          类型: skill.类型 || '主动',
          技能等级: skill.当前等级 || 1,
          冷却中: false,
          伤害倍率: calcSkillDamage({ ...skill, 当前等级: skill.当前等级 || 1 }),
          阶位: skill.阶位 || '基础',
          特殊效果: getSpecialEffectObj({ ...skill, 当前等级: skill.当前等级 || 1 }),
          描述: skill.描述 || ''
        };
        if (skill.召唤物名称) slotData.召唤物名称 = skill.召唤物名称;
        const patches = [];
        if (replaceSkillName) {
          patches.push({ op: 'remove', path: `/人物/技能树/技能槽/${slotType}/${replaceSkillName}` });
          // 同步更新被替换技能的是否装备状态
          patches.push({ op: 'replace', path: `/人物/技能树/技能列表/${replaceSkillName}/是否装备`, value: false });
        }
        patches.push({ op: 'add', path: `/人物/技能树/技能槽/${slotType}/${skillName}`, value: slotData });
        // 同步更新技能列表中的是否装备状态
        patches.push({ op: 'replace', path: `/人物/技能树/技能列表/${skillName}/是否装备`, value: true });
        applyMvuPatches(patches);
        setTimeout(refresh, 100);
      };

      // 暴露给 window 以便 innerHTML onclick 调用
      window.triggerAvatarUpload = (name) => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.onchange = (e) => {
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = (evt) => {
            const base64 = evt.target.result;
            const success = applyMvuPatches([
              { op: 'add', path: '/羁绊列表/' + name + '/头像', value: base64 }
            ]);
            if (success) {
              // 尝试刷新
              setTimeout(refresh, 100);
            }
          };
          reader.readAsDataURL(file);
        };
        input.click();
      };

      // 渲染羁绊详情到右侧面板
      // 渲染羁绊详情到右侧面板 (Bento Layout)
      const renderBondDetail = (name, data) => {
        const container = document.getElementById('bond-container');
        const pane = document.getElementById('bond-detail-container');
        if (!pane || !container) return;

        // 品质颜色映射
        const qualityColorMap = {
          '普通': '#2D3436',
          '精良': '#0047AB',
          '稀有': '#9b59b6',
          '神器': '#e84393',
          '传说': '#e67e22',
          '史诗': '#C9A227',
          '神话': '#e8198b'
        };
        const getQualityColor = (q) => qualityColorMap[q] || qualityColorMap['普通'];

        container.classList.add('mode-detail'); // 切换到紧凑模式

        const gender = data.性别 || '未知';
        const race = data.种族 || '未知';
        const level = data.等级 || 1;
        const thought = data.当前想法 || '无特别想法';
        const stats = data.属性 || {};
        const skills = data.技能 || {};
        const equips = data.装备列表 || {};
        const comboSkills = data.连携奥义 || {};
        const avatar = data.头像;

        // 好感度计算
        const favor = data.好感度 || 0;
        const favorMax = 100;
        const favorPct = Math.min(100, Math.max(0, ((favor + favorMax) / (favorMax * 2)) * 100));

        // Bento Grid HTML
        const html = `
          <div class="bd-layout">
            <div class="bd-banner">
              <button class="bd-close-abs" onclick="closeBondDetail()"><i class="ri-close-line"></i></button>
              
              <div class="bd-hero-avatar-container">
                ${avatar ?
            `<img src="${avatar}" class="bd-hero-img">` :
            `<div class="bd-hero-placeholder"><i class="ri-user-smile-line"></i></div>`
          }
                <div class="bd-upload-mask" onclick="triggerAvatarUpload('${name}')"><i class="ri-camera-line"></i></div>
              </div>
              
              <div class="bd-hero-info">
                <div class="bd-hero-name">
                  ${name}
                </div>
                <div class="bd-hero-badges">
                  <span class="bd-badge race">${race}</span>
                  <span class="bd-badge">${gender}</span>
                  <span class="bd-badge level">Lv.${level}</span>
                  ${data.同行誓约 ? '<span class="bd-badge" style="background:rgba(0,0,0,0.06);color:#f39c12;font-weight:600;">誓约</span>' : ''}
                </div>
                
                <div class="bd-favor-bar-container">
                  <div class="bd-favor-label" style="color: #e74c3c;">
                    <span>好感度</span>
                    <span>${favor > 0 ? '+' : ''}${favor}</span>
                  </div>
                  <div class="bd-favor-track">
                    <div class="bd-favor-fill" style="width: ${favorPct}%"></div>
                  </div>
                </div>
              </div>
            </div>

            <div class="bd-scroll-content">
              <div class="bd-bento-grid">
                
                <div class="bd-thought-quote">
                   ${thought}
                </div>
                
                <div class="bd-card">
                  <div class="bd-card-title"><i class="ri-bar-chart-box-line"></i> 属性</div>
                  <div class="bd-attr-grid">
                    ${(() => {
                      const abbr = {'鍔涢噺':'STR','鏁忔嵎':'DEX','浣撹川':'CON','鏅哄姏':'INT','鎰熺煡':'WIS','榄呭姏':'CHA'};
                      return Object.entries(stats).map(([k, v]) => `
                        <div class="bd-attr-card">
                          <div class="bd-attr-name">${k}</div>
                          <div class="bd-attr-val">${v}</div>
                          <div class="bd-attr-sub">${abbr[k] || ''}</div>
                        </div>
                      `).join('');
                    })()}
                  </div>
                </div>

                <div class="bd-card">
                   <div class="bd-card-title"><i class="ri-shirt-line"></i> 外观</div>
                   <div class="bd-info-row">
                      <div class="bd-info-item"><span>外貌</span><span>${data.外貌 || '未记录'}</span></div>
                      <div class="bd-info-item"><span>着装</span><span>${data.着装 || '未记录'}</span></div>
                   </div>
                </div>
                
                <div class="bd-card">
                   <div class="bd-card-title"><i class="ri-sword-line"></i> 战斗配置</div>
                   ${Object.entries(equips).length === 0 && Object.entries(skills).length === 0 && Object.entries(comboSkills).length === 0 ?
            '<div style="text-align:center;padding:10px;color:rgba(0,0,0,0.3)">暂无配置信息</div>' :
            `${Object.entries(equips).length > 0 ? `
              <div class="bd-combat-section">
                <div class="bd-combat-label">装备</div>
                <div class="bd-combat-list">
                  ${Object.entries(equips).map(([k, v]) => {
                    const qColor = getQualityColor(v.品质);
                    return `
                    <div class="bd-combat-wrapper">
                      <div class="bd-combat-item" data-type="equip" data-info='${JSON.stringify(v).replace(/'/g, "&#39;")}' onclick="toggleCombatDetail(this)" style="border-left: 3px solid ${qColor};">
                        <span style="color: ${qColor};">${v.名称 || k}</span><span>${v.部位 || ''}</span>
                      </div>
                    </div>`;
                  }).join('')}
                </div>
              </div>` : ''}
            ${Object.entries(skills).length > 0 ? `
              <div class="bd-combat-section">
                <div class="bd-combat-label">技能</div>
                <div class="bd-combat-list">
                  ${Object.entries(skills).map(([k, v]) => `
                    <div class="bd-combat-wrapper">
                      <div class="bd-combat-item" data-type="skill" data-info='${JSON.stringify({名称: k, ...v}).replace(/'/g, "&#39;")}' onclick="toggleCombatDetail(this)">
                        <span>${k}</span><span>${v.类型 || ''}</span>
                      </div>
                    </div>`).join('')}
                </div>
              </div>` : ''}
            ${Object.entries(comboSkills).length > 0 ? `
              <div class="bd-combat-section">
                <div class="bd-combat-label" style="color: #f39c12;">连携奥义</div>
                <div class="bd-combat-list">
                  ${Object.entries(comboSkills).map(([k, v]) => `
                    <div class="bd-combat-wrapper" style="width: 100%;">
                      <div class="bd-combat-item bd-combo-skill" data-type="combo" data-info='${JSON.stringify({名称: k, ...v}).replace(/'/g, "&#39;")}' onclick="toggleCombatDetail(this)">
                        <span><i class="ri-links-line" style="color: #f39c12; margin-right: 4px;"></i>${k}</span><span style="color: #e67e22;">${v.类型 || '连携'}</span>
                      </div>
                    </div>`).join('')}
                </div>
              </div>` : ''}`
          }
                </div>
                
              </div>
            </div>
          </div>
        `;
        pane.innerHTML = html;
      };

      window.closeBondDetail = () => {
        const container = document.getElementById('bond-container');
        if (container) {
          container.classList.remove('mode-detail');
          container.classList.remove('has-selection');
        }
        document.querySelectorAll('.bond-item').forEach(c => c.classList.remove('active'));
      };

      // 装备/技能详情展开
      window.toggleCombatDetail = (el) => {
        const wrapper = el.parentElement;
        const list = wrapper.parentElement;
        const existingDetail = wrapper.querySelector('.bd-combat-detail');
        const wasExpanded = el.classList.contains('expanded');
        
        // 品质颜色映射
        const qualityColorMap = {
          '普通': '#2D3436',
          '精良': '#0047AB',
          '稀有': '#9b59b6',
          '神器': '#e84393',
          '传说': '#e67e22',
          '史诗': '#C9A227',
          '神话': '#e8198b'
        };
        const getQualityColor = (q) => qualityColorMap[q] || qualityColorMap['普通'];
        
        // 清除所有展开状态
        list.querySelectorAll('.bd-combat-item').forEach(item => item.classList.remove('expanded'));
        list.querySelectorAll('.bd-combat-detail').forEach(d => d.remove());
        
        if (wasExpanded) return; // 点击已展开的项则收起
        
        const type = el.dataset.type;
        let data;
        try {
          data = JSON.parse(el.dataset.info);
        } catch(e) {
          console.error('解析数据失败', e);
          return;
        }
        
        el.classList.add('expanded');
        
        const qColor = type === 'equip' ? getQualityColor(data.品质) : null;
        const comboColor = type === 'combo' ? '#f39c12' : null;
        const borderColor = qColor || comboColor;
        let detailHtml = `<div class="bd-combat-detail"${borderColor ? ` style="border-top: 2px solid ${borderColor};"` : ''}>`;
        if (type === 'equip') {
          if (data.品质) detailHtml += `<div class="bd-combat-detail-row"><span class="label">品质</span><span class="value" style="color: ${qColor}; font-weight: 700;">${data.品质}</span></div>`;
          if (data.等级) detailHtml += `<div class="bd-combat-detail-row"><span class="label">等级</span><span class="value">Lv.${data.等级}</span></div>`;
          if (data.强化等级) detailHtml += `<div class="bd-combat-detail-row"><span class="label">强化</span><span class="value">+${data.强化等级}</span></div>`;
          if (data.属性加成 && Object.keys(data.属性加成).length > 0) {
            const bonusStr = Object.entries(data.属性加成).map(([k,v]) => `<span style="background:rgba(59,66,89,0.08);padding:2px 6px;border-radius:4px;margin-right:4px;font-weight:600;">${k}<span style="color:#e74c3c;">+${v}</span></span>`).join('');
            detailHtml += `<div class="bd-combat-detail-row"><span class="label">属性</span><span class="value">${bonusStr}</span></div>`;
          }
          if (data.效果) detailHtml += `<div class="bd-combat-detail-row effect-row"><span class="label">效果</span><span class="value">${data.效果}</span></div>`;
          if (data.描述) detailHtml += `<div class="bd-combat-detail-desc">${data.描述}</div>`;
        } else if (type === 'combo') {
          if (data.类型) detailHtml += `<div class="bd-combat-detail-row"><span class="label">类型</span><span class="value" style="color: #e67e22;">${data.类型}</span></div>`;
          if (data.效果) detailHtml += `<div class="bd-combat-detail-row effect-row"><span class="label">效果</span><span class="value" style="color: #d35400; background: rgba(243, 156, 18, 0.06);">${data.效果}</span></div>`;
          if (data.描述) detailHtml += `<div class="bd-combat-detail-desc" style="color: #b8860b; background: rgba(243, 156, 18, 0.04);">${data.描述}</div>`;
        } else {
          if (data.类型) detailHtml += `<div class="bd-combat-detail-row"><span class="label">类型</span><span class="value">${data.类型}</span></div>`;
          if (data.效果) detailHtml += `<div class="bd-combat-detail-row effect-row"><span class="label">效果</span><span class="value">${data.效果}</span></div>`;
          if (data.描述) detailHtml += `<div class="bd-combat-detail-desc">${data.描述}</div>`;
        }
        detailHtml += '</div>';
        
        wrapper.insertAdjacentHTML('beforeend', detailHtml);
      };

      // ==================== 附近的人详情 ====================
      const renderNearbyDetail = (name, data) => {
        const container = document.getElementById('nearby-container');
        const pane = document.getElementById('nearby-detail-container');
        if (!pane || !container) return;

        const qualityColorMap = {
          '普通': '#2D3436', '精良': '#0047AB', '稀有': '#9b59b6',
          '神器': '#e84393', '传说': '#e67e22', '史诗': '#C9A227', '神话': '#e8198b'
        };
        const getQC = q => qualityColorMap[q] || qualityColorMap['普通'];

        container.classList.add('mode-detail');

        const gender = data.性别 || '未知';
        const race = data.种族 || '未知';
        const level = data.等级 || 1;
        const stats = data.属性 || {};
        const equips = data.装备列表 || {};

        const html = `
          <div class="nd-layout">
            <div class="nd-banner">
              <button class="nd-close" onclick="closeNearbyDetail()"><i class="ri-close-line"></i></button>
              <div class="nd-avatar"><i class="ri-user-line"></i></div>
              <div class="nd-hero-info">
                <div class="nd-name">${name}</div>
                <div class="nd-badges">
                  <span class="nd-badge race">${race}</span>
                  <span class="nd-badge">${gender}</span>
                  <span class="nd-badge">Lv.${level}</span>
                </div>
              </div>
            </div>
            <div class="nd-scroll">
              <div class="nd-grid">
                <div class="nd-card">
                  <div class="nd-card-title"><i class="ri-bar-chart-box-line"></i> 属性</div>
                  <div class="nd-attr-grid">
                    ${Object.entries(stats).map(([k, v]) => `
                      <div class="nd-attr-item">
                        <div class="nd-attr-name">${k}</div>
                        <div class="nd-attr-val">${v}</div>
                      </div>`).join('')}
                  </div>
                </div>
                <div class="nd-card">
                  <div class="nd-card-title"><i class="ri-shirt-line"></i> 外观</div>
                  <div class="nd-info-row">
                    <div class="nd-info-item"><span>外貌</span><span>${data.外貌 || '未记录'}</span></div>
                    <div class="nd-info-item"><span>着装</span><span>${data.着装 || '未记录'}</span></div>
                  </div>
                </div>
                ${Object.keys(equips).length > 0 ? `
                <div class="nd-card">
                  <div class="nd-card-title"><i class="ri-sword-line"></i> 装备</div>
                  <div class="bd-combat-list">
                    ${Object.entries(equips).map(([k, v]) => {
                      const qc = getQC(v.品质);
                      return `<div class="bd-combat-wrapper">
                        <div class="bd-combat-item" data-type="equip" data-info='${JSON.stringify(v).replace(/'/g, "&#39;")}' onclick="toggleCombatDetail(this)" style="border-left: 3px solid ${qc};">
                          <span style="color: ${qc};">${v.名称 || k}</span><span>${v.部位 || ''}</span>
                        </div>
                      </div>`;
                    }).join('')}
                  </div>
                </div>` : ''}
              </div>
            </div>
          </div>`;
        pane.innerHTML = html;
      };

      window.closeNearbyDetail = () => {
        const container = document.getElementById('nearby-container');
        if (container) container.classList.remove('mode-detail');
        const pane = document.getElementById('nearby-detail-container');
        if (pane) pane.innerHTML = '';
        document.querySelectorAll('.nearby-card').forEach(c => c.classList.remove('active'));
        _activeNearbyPerson = null;
      };

      // ==================== 渲染函数 ====================
      const renderStatusBar = (data) => {
        const 人物 = data.人物 || {};
        const 世界信息 = data.世界信息 || {};
        const 羁绊列表 = data.羁绊列表 || {};
        const 声望 = 人物.声望 || {};
        const 传闻 = data.传闻 || {};
        const 附近的人 = data.附近的人 || {};
        const 位置 = 世界信息.位置 || {};
        const 状态效果 = 人物.状态效果 || {};
        const 技能树 = 人物.技能树 || {};
        const 技能槽 = 技能树.技能槽 || {};
        const 技能列表 = 技能树.技能列表 || {};
        const 时间 = 世界信息.时间 || '';
        const 年历 = 世界信息.年历 || '';
        const timeDisplay = [年历, 时间].filter(Boolean).join(' ') || '未知';
        const 场所 = 位置.场所 || '';
        const 区域 = 位置.区域 || '';
        const 大陆 = 位置.大陆 || '';
        const 位置显示 = 场所 || 区域 || 大陆 || '未知';
        const 位置完整 = [大陆, 区域, 场所].filter(Boolean).join(' > ');
        const 名称 = 人物.名称 || '冒险者';
        const 等级 = 人物.等级 || 1;
        const 职业 = 人物.职业 || '冒险者';
        const 种族 = 人物.种族 || '';
        const raceStr = 种族 ? ` · ${种族}` : '';

        // 根据职业更新背景（带缓存）
        if (职业 !== _cachedClassName) {
          const bgUrl = getClassBackgroundUrl(职业);
          document.documentElement.style.setProperty('--class-bg-url', `url('${bgUrl}')`);
          _cachedClassName = 职业;
        }

        const 当前HP = 人物.当前生命值 || 0;
        const 最大HP = 人物.生命值上限 || 1;
        const hpPct = Math.min(100, Math.max(0, (当前HP / 最大HP) * 100));
        const CP = 人物.CP || 0;
        const AC = 人物.AC || 10;
        const 当前经验 = 人物.当前总经验 || 0;
        const 升级阈值 = 人物.升级阈值 || 100;
        const expPct = Math.min(100, Math.max(0, (当前经验 / 升级阈值) * 100));
        // Buff 渲染
        let buffHTML = '';
        Object.entries(状态效果).forEach(([name, effect]) => {
          const isDebuff = effect.类型 === 'DEBUFF';
          const iconClass = getBuffIcon(name, isDebuff);
          const typeClass = isDebuff ? 'is-debuff' : 'is-buff';
          const duration = effect.持续时间 || '∞';
          const shortDur = duration === '永久' ? '∞' : duration.toString().replace('回合', 't');
          const desc = effect.描述 || '';
          buffHTML += `<div class="buff-icon-item ${typeClass}" data-buff-name="${name}">
            <i class="${iconClass}"></i>
            <div class="buff-duration-badge">${shortDur}</div>
            <div class="buff-tooltip">
              <span class="buff-tooltip-name">${name}</span>
              <span class="buff-tooltip-desc">${desc}</span>
            </div>
          </div>`;
        });
        // 技能槽渲染
        const 主动技能槽 = 技能槽.主动技能槽 || {};
        const 觉醒技能槽 = 技能槽.觉醒技能槽 || {};
        const isElf = 种族 === '森精种';
        const mainSlotCount = isElf ? 7 : 6;
        const awakeningSlotCount = isElf ? 3 : 2;

        const renderSlots = (slotObj, maxSlots, isAwk) => {
          const entries = Object.entries(slotObj);
          const slotType = isAwk ? '觉醒技能槽' : '主动技能槽';
          // 读取冷却缓存
          let cooldownCache = {};
          try {
            const raw = localStorage.getItem('rpg_skill_cooldowns');
            if (raw) cooldownCache = JSON.parse(raw);
          } catch(e) {}
          let html = '';
          for (let i = 0; i < maxSlots; i++) {
            const entry = entries[i];
            if (entry) {
              const [sName, skill] = entry;
              const fullSkill = 技能列表[sName] || skill;
              const type = fullSkill.类型 || '主动';
              const tier = fullSkill.阶位 || (isAwk ? '觉醒一' : '基础');
              const iconSvg = getSkillSvg(type, tier);
              const lv = skill.技能等级 || fullSkill.当前等级 || 1;
              const isCooling = skill.冷却中 === true;
              const dName = sName.length > 4 ? sName.slice(0, 4) + '…' : sName;
              const cls = `skill-slot ${isAwk ? 'awakening ' : ''} active`;
              let cdOverlay = '';
              if (isCooling) {
                const cdInfo = cooldownCache[sName];
                const remain = cdInfo ? cdInfo.剩余 : 1;
                const total = cdInfo ? cdInfo.上限 : 1;
                const pct = Math.min(100, Math.max(0, (remain / total) * 100));
                cdOverlay = `<div class="skill-cooldown-overlay" style="height:${pct}%"></div>`;
              }
              const showLvBadge = !isAwk;
              html += `<div class="skill-slot-wrapper">
                <div class="${cls}" data-skill="${sName}" data-slot-type="${slotType}">
                  <div class="skill-icon">${iconSvg}</div>
                  ${cdOverlay}
                  ${showLvBadge ? `<div class="skill-level-badge">${lv}</div>` : ''}
                </div>
                <div class="skill-slot-name">${dName}</div>
                <div class="skill-tooltip">${sName} Lv.${lv}</div>
              </div>`;
            } else {
              const cls = `skill-slot ${isAwk ? 'awakening ' : ''} empty`;
              html += `<div class="skill-slot-wrapper"><div class="${cls}" data-action="skill-pick" data-slot-type="${slotType}" style="cursor:pointer">
                <div class="skill-icon"><i class="ri-add-line" style="opacity:0.3"></i></div>
              </div></div>`;
            }
          }
          return html;
        };
        const mainHTML = renderSlots(主动技能槽, mainSlotCount, false);
        const awkHTML = renderSlots(觉醒技能槽, awakeningSlotCount, true);
        // 始终显示tab区域，即使技能槽为空（其他tab如关系、附近、传闻仍需显示）
        const hasSkills = true;

        // 连携奥义技能槽渲染（单槽，可切换）
        const comboDefaultSvg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="combo-svg-icon"><path d="M0 0h512v512H0z" fill="transparent"></path><g transform="translate(0,0)"><path d="M370.803 299.826c-5.82-6.27-9.52-15.655-9.52-26.135 0-18.86 11.98-34.172 26.74-34.172 14.76 0 26.74 15.312 26.74 34.172 0 10.48-3.7 19.865-9.52 26.135 22.54 9.514 38.87 37.201 38.87 69.836 0 7.677-.9 15.08-2.58 22.033h-18.76l-4.84 86.485h-59.82l-4.84-86.485h-18.77c-1.67-6.953-2.58-14.356-2.58-22.033 0-32.635 16.33-60.322 38.88-69.836zm-264.05 0c-5.82-6.27-9.52-15.655-9.52-26.135 0-18.86 11.99-34.172 26.74-34.172 14.76 0 26.74 15.312 26.74 34.172 0 10.48-3.7 19.865-9.52 26.135 22.55 9.514 38.88 37.201 38.88 69.836 0 7.677-.91 15.08-2.58 22.033h-18.77l-4.83 86.485h-59.83l-4.83-86.485h-18.77c-1.68-6.953-2.58-14.356-2.58-22.033 0-32.635 16.33-60.322 38.87-69.836zm202.43-156.338 41.78 45.309-94.96 92.421-29.74-28.941 76.44-57.99-10.07-13.278-78.45 59.512-17.71-17.238zm-67.61 27.44-57.25 40.534-23.29-22.665 41.79-45.309zm237.69-143.565c-2.08 12.875-13.5 21.964-25.9 28.838-21.67 12.003-47.57 16.695-47.57 16.695l-8.2 1.49 2.98 16.398 8.2-1.49s26.29-4.789 49.59-16.867c-3.48 10.913-13.84 18.89-25 25.074-21.67 12.003-47.57 16.696-47.57 16.696l-8.2 1.489 2.98 16.399 8.2-1.49s16.77-3.056 35.39-10.439c-4.84 7.576-13.07 13.509-21.8 18.345-19.22 10.649-41.78 15.544-46.62 16.512l-28.87-28.064c45.55-28.633-2.99-94.227 152.39-99.586zm-446.52 0c2.08 12.875 13.49 21.964 25.9 28.838 21.66 12.003 47.56 16.695 47.56 16.695l8.2 1.49-2.98 16.398-8.2-1.49s-26.29-4.789-49.59-16.867c3.49 10.913 13.84 18.89 25.01 25.074 21.66 12.003 47.56 16.696 47.56 16.696l8.2 1.489-2.98 16.399-8.2-1.49s-16.77-3.056-35.39-10.439c4.84 7.576 13.08 13.509 21.81 18.345 19.22 10.649 41.77 15.544 46.61 16.512l28.88-28.064c-45.55-28.633 2.99-94.227-152.39-99.586zm223.26 36.178c15.67 0 28.39 18.768 28.39 41.885 0 23.116-12.72 41.884-28.39 41.884s-28.39-18.768-28.39-41.884c0-23.117 12.72-41.885 28.39-41.885z" fill="#b8860b" fill-opacity="1"></path></g></svg>`;

        // 收集所有有连携奥义的伙伴
        const allCombos = [];
        Object.entries(羁绊列表).forEach(([bondName, bond]) => {
          const comboSkills = bond.连携奥义 || {};
          Object.entries(comboSkills).forEach(([skillName, skillData]) => {
            allCombos.push({ bondName, skillName, skillData, avatar: bond.头像 || '' });
          });
        });

        // 读取已保存的选择
        const savedCombo = 技能槽.连携奥义槽 || {};
        let comboFound = null;
        if (savedCombo.伙伴 && savedCombo.技能名) {
          comboFound = allCombos.find(c => c.bondName === savedCombo.伙伴 && c.skillName === savedCombo.技能名);
        }

        let comboHTML = '';
        if (comboFound) {
          const { bondName, skillName, skillData, avatar } = comboFound;
          const dName = skillName.length > 4 ? skillName.slice(0, 4) + '…' : skillName;
          const iconContent = avatar
            ? `<img class="combo-avatar-icon" src="${avatar}" alt="${bondName}">`
            : comboDefaultSvg;
          const cpFull = CP >= 100;
          const cpFillCls = cpFull ? 'combo-cp-fill cp-full' : 'combo-cp-fill';
          const cpPct = Math.min(100, Math.max(0, CP));
          comboHTML = `<div class="skill-slot-wrapper">
            <div class="skill-slot combo-ultimate active" data-skill="${skillName}" data-bond="${bondName}" data-combo-info='${JSON.stringify({名称: skillName, 伙伴: bondName, ...skillData}).replace(/'/g, "&#39;")}'>
              <div class="skill-icon">${iconContent}</div>
              <div class="${cpFillCls}" style="height:${cpPct}%"></div>
            </div>
            <div class="skill-slot-name combo-name">${dName}</div>
            <div class="skill-tooltip">${skillName}（${bondName}）</div>
          </div>`;
        } else {
          comboHTML = `<div class="skill-slot-wrapper"><div class="skill-slot combo-ultimate empty" data-action="combo-pick" style="cursor:pointer">
            <div class="skill-icon">${comboDefaultSvg}</div>
          </div></div>`;
        }

        // 羁绊列表渲染 (Premium List)
        const bondEntries = Object.entries(羁绊列表);
        let bondsHTML = '';
        /* 详情容器，初始为空 */
        const detailPaneHTML = `<div class="bond-detail-pane" id="bond-detail-container"></div>`;

        if (bondEntries.length > 0) {
          const bondH = Math.min(460, (bondEntries.length + 1) * 92);
          bondsHTML = `<div class="bond-section-container" id="bond-container" style="min-height:${bondH}px"><div class="bond-list-pane">`;
          bondEntries.forEach(([name, bond]) => {
            const favor = bond.好感度 || 0;
            const favorCls = favor > 0 ? 'positive' : favor < 0 ? 'negative' : 'neutral';
            const raceStr = bond.种族 || '未知种族';
            const levelStr = bond.等级 ? `Lv.${bond.等级}` : '';
            const oath = bond.同行誓约;
            const thought = bond.当前想法 || '';
            const avatar = bond.头像;
            const hasAvatarCls = avatar ? 'has-avatar' : '';
            const shortName = name.length > 4 ? name.slice(0, 4) : name;

            bondsHTML += `<div class="bond-item ${hasAvatarCls}" data-bond-name="${name}">
              ${avatar ? `<div class="bond-item-avatar-box">
                <img class="bond-item-avatar-img" src="${avatar}" alt="${name}">
              </div>` : ''}
              
              <div class="bond-item-info">
                <div class="bond-item-name">${name}</div>
                <div class="bond-item-meta">
                  <span class="bond-item-tag">${raceStr}</span>
                  ${levelStr ? `<span class="bond-item-tag">${levelStr}</span>` : ''}
                  ${oath ? `<span class="bond-item-tag" style="background:rgba(0,0,0,0.06);color:#f39c12;font-weight:600;">誓约</span>` : ''}
                </div>
              </div>
              
              <div class="bond-item-thought">
                ${thought ? `<span class="bond-item-thought-text">${thought}</span>` : ''}
              </div>
              
              <div class="bond-item-status">
                <div class="bond-favor-badge ${favorCls}">
                   <i class="ri-heart-fill" style="color:#e74c3c;"></i>
                   <span>${favor > 0 ? '+' : ''}${favor}</span>
                </div>
              </div>
              
              <div class="bond-item-compact-name">${shortName}</div>
            </div>`;
          });
          bondsHTML += `</div>${detailPaneHTML}</div>`;
        }

        // 声望列表渲染
        const repEntries = Object.entries(声望);
        let repHTML = '';
        if (repEntries.length > 0) {
          repHTML = '<div class="rep-list">';
          repEntries.forEach(([key, rep]) => {
            const repName = rep.阵营名称 || key;
            const repVal = rep.声望值 || 0;
            const repRank = rep.声望等级 || '中立';
            const repDesc = rep.描述 || '';
            const isPositive = repVal >= 0;
            const iconCls = isPositive ? 'rep-positive' : 'rep-negative';
            const rankCls = isPositive ? 'rank-positive' : 'rank-negative';
            const icon = isPositive ? 'ri-shield-star-line' : 'ri-shield-line';
            repHTML += `<div class="rep-item" title="${repDesc}">
              <div class="rep-icon ${iconCls}"><i class="${icon}"></i></div>
              <div class="rep-info">
                <div class="rep-name">${repName}</div>
                <div class="rep-desc">${repDesc}</div>
              </div>
              <div class="rep-right">
                <span class="rep-rank ${rankCls}">${repRank}</span>
                <span class="rep-val">${repVal > 0 ? '+' : ''}${repVal}</span>
              </div>
            </div>`;
          });
          repHTML += '</div>';
        }

        const hasBonds = bondEntries.length > 0;
        const hasRep = repEntries.length > 0;

        // 传闻渲染
        const 街头巷议 = 传闻.街头巷议 || {};
        const 情报交易 = 传闻.情报交易 || {};
        const 布告与檄文 = 传闻.布告与檄文 || {};
        const gossipEntries = Object.entries(街头巷议);
        const intelEntries = Object.entries(情报交易);
        const noticeEntries = Object.entries(布告与檄文);
        const hasRumors = gossipEntries.length > 0 || intelEntries.length > 0 || noticeEntries.length > 0;

        const credMap = { '酒话': ['cred-low', '酒话'], '可疑': ['cred-mid', '可疑'], '或许可信': ['cred-high', '或许可信'] };

        let rumorsContent = '';
        if (hasRumors) {
          let gossipHTML = '';
          gossipEntries.forEach(([title, r]) => {
            const [credCls, credLabel] = credMap[r.可信度] || credMap['可疑'];
            gossipHTML += `<div class="rumor-gossip-card">
              <div class="rumor-gossip-header">
                <span class="rumor-gossip-title">${title}</span>
                <span class="rumor-credibility ${credCls}">${credLabel}</span>
              </div>
              <div class="rumor-gossip-speaker"><i class="ri-user-voice-line"></i>${r.说书人 || '路人'}</div>
              <div class="rumor-gossip-content">${r.内容 || ''}</div>
            </div>`;
          });

          let intelHTML = '';
          intelEntries.forEach(([name, r]) => {
            const price = r.要价 || 0;
            const priceStr = price >= 1000 ? (price / 1000).toFixed(price % 1000 === 0 ? 0 : 1) + 'k' : price.toString();
            intelHTML += `<div class="rumor-intel-card">
              <div class="rumor-intel-header">
                <span class="rumor-intel-title">${name}</span>
                <span class="rumor-intel-price"><i class="ri-copper-coin-line"></i>${priceStr} G</span>
              </div>
              <div class="rumor-intel-seller"><i class="ri-spy-line"></i>${r.卖家 || '不明'}</div>
              <div class="rumor-intel-summary">${r.摘要 || ''}</div>
              <div class="rumor-intel-footer">
                <button class="rumor-intel-buy" data-intel-name="${name.replace(/"/g, '&quot;')}" data-intel-seller="${(r.卖家 || '不明').replace(/"/g, '&quot;')}"><i class="ri-shopping-bag-line"></i>购买情报</button>
              </div>
            </div>`;
          });

          let noticeHTML = '';
          noticeEntries.forEach(([title, r]) => {
            noticeHTML += `<div class="rumor-notice-card">
              <div class="rumor-notice-header">
                <span class="rumor-notice-title">${title}</span>
                <span class="rumor-notice-issuer">${r.发布者 || '佚名'}</span>
              </div>
              ${r.张贴位置 ? `<div class="rumor-notice-location"><i class="ri-pushpin-line"></i>${r.张贴位置}</div>` : ''}
              <div class="rumor-notice-content">${r.内容 || ''}</div>
            </div>`;
          });

          const hasGossip = gossipEntries.length > 0;
          const hasIntel = intelEntries.length > 0;
          const hasNotice = noticeEntries.length > 0;

          const subTabs = `<div class="rumor-sub-tabs">
            ${hasGossip ? `<button class="rumor-sub-tab active" data-rumor-tab="gossip"><i class="ri-chat-voice-line"></i>巷议<span class="rumor-count">${gossipEntries.length}</span></button>` : ''}
            ${hasIntel ? `<button class="rumor-sub-tab${!hasGossip ? ' active' : ''}" data-rumor-tab="intel"><i class="ri-spy-line"></i>情报<span class="rumor-count">${intelEntries.length}</span></button>` : ''}
            ${hasNotice ? `<button class="rumor-sub-tab${!hasGossip && !hasIntel ? ' active' : ''}" data-rumor-tab="notice"><i class="ri-file-paper-2-line"></i>布告<span class="rumor-count">${noticeEntries.length}</span></button>` : ''}
          </div>`;

          const gossipPane = hasGossip ? `<div class="rumor-pane active" data-rumor-pane="gossip"><div class="rumor-list">${gossipHTML}</div></div>` : '';
          const intelPane = hasIntel ? `<div class="rumor-pane${!hasGossip ? ' active' : ''}" data-rumor-pane="intel"><div class="rumor-list">${intelHTML}</div></div>` : '';
          const noticePane = hasNotice ? `<div class="rumor-pane${!hasGossip && !hasIntel ? ' active' : ''}" data-rumor-pane="notice"><div class="rumor-list">${noticeHTML}</div></div>` : '';

          rumorsContent = `<div class="rumors-section">${subTabs}${gossipPane}${intelPane}${noticePane}</div>`;
        } else {
          rumorsContent = '<div class="tab-placeholder"><i class="ri-chat-quote-line"></i>暂无传闻</div>';
        }
        let relationsContent = '';
        if (hasBonds || hasRep) {
          const subTabs = `<div class="rel-sub-tabs">
            ${hasBonds ? `<button class="rel-sub-tab active" data-rel-tab="bonds"><i class="ri-heart-2-line"></i>羁绊<span class="rel-count">${bondEntries.length}</span></button>` : ''}
            ${hasRep ? `<button class="rel-sub-tab${hasBonds ? '' : ' active'}" data-rel-tab="rep"><i class="ri-flag-2-line"></i>声望<span class="rel-count">${repEntries.length}</span></button>` : ''}
          </div>`;
          const bondPane = hasBonds ? `<div class="rel-pane active" data-rel-pane="bonds">${bondsHTML}</div>` : '';
          const repPane = hasRep ? `<div class="rel-pane${hasBonds ? '' : ' active'}" data-rel-pane="rep">${repHTML}</div>` : '';
          relationsContent = `<div class="relations-section">${subTabs}${bondPane}${repPane}</div>`;
        } else {
          relationsContent = '<div class="tab-placeholder"><i class="ri-group-line"></i>暂无关系数据</div>';
        }

        // 附近的人渲染
        const nearbyEntries = Object.entries(附近的人);
        let nearbyContent = '';
        if (nearbyEntries.length > 0) {
          let cardsHTML = '';
          nearbyEntries.forEach(([name, p]) => {
            const race = p.种族 || '未知';
            const lv = p.等级 || 1;
            const desc = p.外貌 || '';
            const shortName = name.length > 4 ? name.slice(0, 4) : name;
            cardsHTML += `<div class="nearby-card" data-nearby-name="${name.replace(/"/g, '&quot;')}">
              <div class="nearby-card-info">
                <div class="nearby-card-name">${name}</div>
                <div class="nearby-card-meta">
                  <span class="nearby-card-tag race">${race}</span>
                  <span class="nearby-card-tag">Lv.${lv}</span>
                </div>
              </div>
              <div class="nearby-card-desc">
                ${desc ? `<span class="nearby-card-desc-text">${desc}</span>` : ''}
              </div>
              <div class="nearby-card-compact-name">${shortName}</div>
            </div>`;
          });
          const nearbyH = Math.min(460, (nearbyEntries.length + 1) * 82);
          nearbyContent = `<div class="nearby-section" id="nearby-container" style="height:${nearbyH}px">
            <div class="nearby-list-pane">${cardsHTML}</div>
            <div class="nearby-detail-pane" id="nearby-detail-container"></div>
          </div>`;
        } else {
          nearbyContent = '<div class="tab-placeholder"><i class="ri-map-pin-2-line"></i>暂无附近信息</div>';
        }

        return `<div class="status-card">
          <div class="card-header">
            <div class="header-card-glass">
              <div class="header-right-info">
                <div class="world-info-block">
                  <div class="world-info-row" data-full="${timeDisplay}"><i class="ri-time-line"></i><span>${timeDisplay}</span></div>
                  <div class="world-info-row" data-full="${位置完整}" title="${位置完整}"><i class="ri-map-pin-line"></i><span class="world-location">${位置显示}</span></div>
                </div>
                <div class="quick-nav">
                  <button class="nav-btn" data-tab="0"><i class="ri-user-3-line"></i><span class="nav-tip">人物详情</span></button>
                  <button class="nav-btn" data-tab="1"><i class="ri-user-star-line"></i><span class="nav-tip">特质</span></button>
                  <button class="nav-btn" data-tab="2"><i class="ri-t-shirt-2-line"></i><span class="nav-tip">装备栏</span></button>
                  <button class="nav-btn" data-tab="3"><i class="ri-node-tree"></i><span class="nav-tip">技能树</span></button>
                  <button class="nav-btn" data-tab="4"><i class="ri-file-list-3-line"></i><span class="nav-tip">任务栏</span></button>
                </div>
              </div>
              <div class="char-header">
                <div class="avatar"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 120 120'%3E%3Cdefs%3E%3ClinearGradient id='bg' x1='0' y1='0' x2='1' y2='1'%3E%3Cstop offset='0%25' stop-color='%233B4259'/%3E%3Cstop offset='100%25' stop-color='%236C5CE7'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='120' height='120' fill='url(%23bg)'/%3E%3Cg fill='%23fff' opacity='0.9'%3E%3Ccircle cx='60' cy='42' r='18'/%3E%3Cpath d='M60 62c-20 0-36 12-36 28v14h72V90c0-16-16-28-36-28z'/%3E%3C/g%3E%3C/svg%3E" alt="头像"></div>
                <div class="char-details">
                  <h1>${名称}</h1>
                  <div class="class-tag"><span>Lv.${等级} ${职业}${raceStr}</span></div>
                </div>
                <div class="hp-container">
                  <div class="hp-label">Hit Points</div>
                  <div class="hp-bar-bg"><div class="hp-bar-fill" style="width:${hpPct}%"></div></div>
                  <div class="hp-text"><span class="hp-current">${当前HP}</span><span class="hp-max">/ ${最大HP}</span></div>
                  <div class="cp-container">
                    <div class="cp-label">Charge</div>
                    <div class="cp-bar-bg"><div class="cp-bar-fill" style="width:${CP}%"></div></div>
                    <div class="cp-text"><span class="cp-current">${CP}</span><span class="cp-max">/ 100</span></div>
                  </div>
                </div>
                <div class="armor-block"><div class="shield-icon">${AC}</div><div class="armor-label">Armor</div></div>
              </div>
              <div class="bars-section">
                <div class="bar-row">
                  <span class="bar-label">EXP</span>
                  <div class="bar-track exp-track"><div class="bar-fill exp-fill" style="width:${expPct}%"></div></div>
                  <span class="bar-value">${当前经验} / ${升级阈值}</span>
                </div>
              </div>
              <div class="buff-bar">${buffHTML}</div>
            </div>
          </div>
          ${hasSkills ? `<div class="tab-section">
            <div class="tab-bar">
              <button class="tab-item active" data-tab-id="skills"><i class="ri-sword-line"></i>技能</button>
              <button class="tab-item" data-tab-id="relations"><i class="ri-group-line"></i>关系</button>
              <button class="tab-item" data-tab-id="nearby"><i class="ri-map-pin-2-line"></i>附近</button>
              <button class="tab-item" data-tab-id="rumors"><i class="ri-chat-quote-line"></i>传闻</button>
              <button class="tab-item" data-tab-id="map"><i class="ri-map-2-line"></i>地图</button>
            </div>
            <div class="tab-content">
              <div class="tab-pane active" data-pane="skills">
                <div class="skills-section"><div class="skill-slots-section">
                  <div class="slots-grid">${mainHTML}</div>
                  <div class="slots-grid" style="padding-bottom:10px">${awkHTML}${comboHTML}</div>
                </div></div>
              </div>
              <div class="tab-pane" data-pane="relations">
                ${relationsContent}
              </div>
              <div class="tab-pane" data-pane="nearby">
                ${nearbyContent}
              </div>
              <div class="tab-pane" data-pane="rumors">
                ${rumorsContent}
              </div>
              <div class="tab-pane" data-pane="map">
                <iframe src="https://tangquanghuy.github.io/dnf/map.html?v=4" style="width:100%;height:400px;border:none;border-radius:8px;"></iframe>
              </div>
            </div>
          </div>` : ''}
        </div>`;
      };

      // ==================== 初始化 & 事件 ====================
      const app = document.getElementById('app');
      let _cachedData = null;

      const bindEvents = () => {
        // 世界信息点击显示全文（fixed定位，不受overflow裁切）
        let _worldTip = null;
        const removeWorldTip = () => {
          if (_worldTip) { _worldTip.remove(); _worldTip = null; }
        };
        document.querySelectorAll('.world-info-row[data-full]').forEach(row => {
          row.addEventListener('click', function(e) {
            e.stopPropagation();
            if (_worldTip && _worldTip._src === this) { removeWorldTip(); return; }
            removeWorldTip();
            const rect = this.getBoundingClientRect();
            const tip = document.createElement('div');
            tip.className = 'world-info-tip-fixed';
            tip.textContent = this.dataset.full;
            tip._src = this;
            document.body.appendChild(tip);
            _worldTip = tip;
            // 先渲染拿到尺寸
            const tipW = tip.offsetWidth;
            const vw = window.innerWidth;
            let left = rect.left;
            let arrowLeft = 12;
            // 右侧溢出：往左推
            if (left + tipW > vw - 8) {
              const shift = left + tipW - (vw - 8);
              left -= shift;
              arrowLeft = Math.min(Math.max(rect.left - left + rect.width / 2 - 5, 8), tipW - 16);
            }
            // 左侧溢出
            if (left < 8) { arrowLeft = Math.max(rect.left + rect.width / 2 - 5, 8); left = 8; }
            tip.style.top = (rect.bottom + 6) + 'px';
            tip.style.left = left + 'px';
            tip.style.setProperty('--arrow-left', arrowLeft + 'px');
            requestAnimationFrame(() => tip.classList.add('show'));
          });
        });
        document.addEventListener('click', removeWorldTip);

        // 快捷按钮 → 唤起状态栏面板
        document.querySelectorAll('.nav-btn[data-tab]').forEach(btn => {
          btn.addEventListener('click', function () {
            const tabIndex = parseInt(this.dataset.tab);
            try {
              const win = getParent();
              const $ = win.jQuery || window.jQuery;
              if (!$) return;
              const $p = $(`#rpg_status_bar-panel`);
              if (!$p.length) return;
              $p.addClass('visible');
              $p.find('.menu-item').removeClass('active');
              $p.find(`.menu-item[data-tab="${tabIndex}"]`).addClass('active');
              $p.find('.view-section').removeClass('active');
              if (tabIndex === 0) $p.find('#view-dashboard').addClass('active');
              else if (tabIndex === 1) $p.find('#view-traits').addClass('active');
              else if (tabIndex === 2) $p.find('#view-inventory').addClass('active');
              else if (tabIndex === 3) $p.find('#view-skills').addClass('active');
              else if (tabIndex === 4) $p.find('#view-quests').addClass('active');
            } catch (e) { }
          });
        });
        // Tab 切换
        document.querySelectorAll('.tab-item[data-tab-id]').forEach(btn => {
          btn.addEventListener('click', function () {
            const tabId = this.dataset.tabId;
            document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
            const pane = document.querySelector(`.tab-pane[data-pane="${tabId}"]`);
            if (pane) pane.classList.add('active');
          });
        });
        // Buff 点击 → 弹窗
        document.querySelectorAll('.buff-icon-item[data-buff-name]').forEach(el => {
          el.addEventListener('click', function () {
            const name = this.dataset.buffName;
            const d = fetchLatestMvuData();
            const effect = d?.人物?.状态效果?.[name];
            if (effect) showStatusPopup(name, effect);
          });
        });
        // 技能槽点击 → 弹窗
        document.querySelectorAll('.skill-slot.active[data-skill]:not(.combo-ultimate)').forEach(el => {
          el.addEventListener('click', function () {
            showSkillPopup(this.dataset.skill, this.dataset.slotType);
          });
        });
        // 空技能槽点击 → 选择器
        document.querySelectorAll('.skill-slot.empty[data-action="skill-pick"]').forEach(el => {
          el.addEventListener('click', function () {
            openSkillPicker(this.dataset.slotType);
          });
        });
        // 连携奥义槽点击 → 弹窗
        document.querySelectorAll('.skill-slot.combo-ultimate.active[data-combo-info]').forEach(el => {
          el.addEventListener('click', function () {
            const info = JSON.parse(this.dataset.comboInfo);
            const win = getParent();
            const fn = win.rpg_status_bar_showPopup;
            if (fn) { fn('combo', info.名称, info); return; }
            removePopup();

            const skillName = info.名称 || '';
            const partner = info.伙伴 || '';
            const comboType = info.类型 || '连携';
            const desc = info.描述 || '';
            const effect = info.效果 || '';

            // 收集所有可展示的属性行（排除已单独展示的字段）
            const excludeKeys = new Set(['名称', '伙伴', '类型', '描述', '效果']);
            let dataRowsHtml = '';
            Object.entries(info).forEach(([k, v]) => {
              if (excludeKeys.has(k)) return;
              if (v === null || v === undefined || v === '') return;
              const valStr = typeof v === 'object' ? JSON.stringify(v) : String(v);
              dataRowsHtml += `<div class="f-data-row"><span class="f-data-label"><i class="ri-arrow-right-s-line"></i> ${k}</span><span class="f-data-val">${valStr}</span></div>`;
            });

            // 检查是否有其他可选连携奥义
            const d = fetchLatestMvuData();
            const allBonds = d?.羁绊列表 || {};
            let otherCombos = [];
            Object.entries(allBonds).forEach(([bName, bond]) => {
              Object.entries(bond.连携奥义 || {}).forEach(([sName, sData]) => {
                if (bName !== partner || sName !== skillName) {
                  otherCombos.push({ bondName: bName, skillName: sName });
                }
              });
            });

            const html = `<div id="bottom-popup" class="fusion-popup-overlay">
              <div class="fusion-card" style="--quality-color: #d4a017">
                <button class="popup-close"><i class="ri-close-line"></i></button>
                <div class="f-header">
                  <div class="f-meta-row">
                    <span class="f-quality" style="color:#d4a017">连携奥义</span>
                    <span class="f-type">// ${comboType}</span>
                  </div>
                  <div class="f-title-row"><span class="f-name">${skillName}</span></div>
                </div>
                <div class="f-stat-bar">
                  <div class="f-mini-stat"><span class="f-ms-label">伙伴</span><span class="f-ms-val" style="color:#d4a017">${partner}</span></div>
                </div>
                <div class="f-content">
                  ${dataRowsHtml ? `<div class="f-data-group">${dataRowsHtml}</div>` : ''}
                  ${effect ? `<div class="f-section-title"><i class="ri-magic-line"></i> 效果</div><div class="f-effect-box" style="color:#d35400;">${effect}</div>` : ''}
                  ${desc ? `<div class="f-section-title"><i class="ri-file-text-line"></i> 描述</div><div class="f-effect-box">${desc}</div>` : ''}
                  ${!effect && !desc && !dataRowsHtml ? '<div class="f-effect-box">与伙伴协力发动的连携奥义</div>' : ''}
                </div>
                <div style="display:flex;gap:8px;padding:12px 16px;border-top:1px solid #f0f0f0;">
                  <button class="combo-action-btn combo-unequip" style="flex:1;padding:8px;border:1px solid #e0e0e0;border-radius:8px;background:#fff;cursor:pointer;font-size:0.75rem;color:#e74c3c;font-weight:600;transition:background 0.15s;">
                    <i class="ri-delete-back-2-line"></i> 卸下
                  </button>
                  ${otherCombos.length > 0 ? `<button class="combo-action-btn combo-change" style="flex:1;padding:8px;border:1px solid #f0c040;border-radius:8px;background:#fffbf0;cursor:pointer;font-size:0.75rem;color:#b8860b;font-weight:600;transition:background 0.15s;">
                    <i class="ri-refresh-line"></i> 更换
                  </button>` : ''}
                </div>
              </div>
            </div>`;
            document.body.insertAdjacentHTML('beforeend', html);
            requestAnimationFrame(() => document.getElementById('bottom-popup')?.classList.add('show'));
            // 卸下按钮
            document.querySelector('.combo-unequip')?.addEventListener('click', () => {
              applyMvuPatches([
                { op: 'replace', path: '/人物/技能树/技能槽/连携奥义槽', value: {} }
              ]);
              removePopup();
              setTimeout(refresh, 100);
            });
            // 更换按钮
            document.querySelector('.combo-change')?.addEventListener('click', () => {
              removePopup();
              openComboPicker();
            });
            bindPopupClose();
          });
        });
        // 连携奥义选择器
        const equipCombo = (bondName, skillName) => {
          const d = fetchLatestMvuData();
          const bond = d?.羁绊列表?.[bondName];
          const sData = bond?.连携奥义?.[skillName] || {};
          applyMvuPatches([
            { op: 'replace', path: '/人物/技能树/技能槽/连携奥义槽', value: {
              伙伴: bondName, 技能名: skillName,
              类型: sData.类型 || '', 效果: sData.效果 || '', 描述: sData.描述 || ''
            }}
          ]);
          setTimeout(refresh, 100);
        };
        const openComboPicker = () => {
          document.getElementById('combo-picker-overlay')?.remove();
          const d = fetchLatestMvuData();
          const bonds = d?.羁绊列表 || {};
          const saved = d?.人物?.技能树?.技能槽?.连携奥义槽 || {};
          const items = [];
          Object.entries(bonds).forEach(([bName, bond]) => {
            Object.entries(bond.连携奥义 || {}).forEach(([sName, sData]) => {
              items.push({ bondName: bName, skillName: sName, avatar: bond.头像 || '', isCurrent: saved.伙伴 === bName && saved.技能名 === sName });
            });
          });
          if (items.length === 0) return;
          let listHtml = '';
          items.forEach(({ bondName, skillName, avatar, isCurrent }) => {
            const avatarHtml = avatar
              ? `<img class="combo-picker-avatar" src="${avatar}" alt="${bondName}">`
              : `<div class="combo-picker-avatar-placeholder"><i class="ri-user-smile-line"></i></div>`;
            listHtml += `<div class="combo-picker-item${isCurrent ? ' current' : ''}" data-bond="${bondName}" data-skill="${skillName}">
              ${avatarHtml}
              <div class="combo-picker-info">
                <div class="combo-picker-bond-name">${bondName}</div>
                <div class="combo-picker-skill-name">${skillName}</div>
              </div>
              ${isCurrent ? '<i class="ri-check-line" style="color:#d4a017;font-size:1rem;"></i>' : ''}
            </div>`;
          });
          const overlayHtml = `<div class="combo-picker-overlay" id="combo-picker-overlay">
            <div class="combo-picker">
              <div class="combo-picker-title"><i class="ri-links-line"></i> 选择连携奥义</div>
              <div class="combo-picker-list">${listHtml}</div>
            </div>
          </div>`;
          document.body.insertAdjacentHTML('beforeend', overlayHtml);
          const overlay = document.getElementById('combo-picker-overlay');
          requestAnimationFrame(() => overlay?.classList.add('show'));
          overlay?.addEventListener('click', (e) => {
            if (e.target === overlay) { overlay.remove(); return; }
            const item = e.target.closest('.combo-picker-item');
            if (!item) return;
            equipCombo(item.dataset.bond, item.dataset.skill);
            overlay.remove();
          });
        };
        // 空槽点击 → 打开选择器
        document.querySelectorAll('[data-action="combo-pick"]').forEach(el => {
          el.addEventListener('click', (e) => { e.stopPropagation(); openComboPicker(); });
        });
        // 羁绊卡片点击 → 侧边详情模式
        document.querySelectorAll('.bond-item[data-bond-name]').forEach(el => {
          el.addEventListener('click', function () {
            // 先处理选中态
            document.querySelectorAll('.bond-item').forEach(c => c.classList.remove('active'));
            this.classList.add('active');

            const name = this.dataset.bondName;
            const d = fetchLatestMvuData();
            const bondData = d?.羁绊列表?.[name];
            if (bondData) {
              renderBondDetail(name, bondData);
            }
          });
        });
        // 关系子 Tab 切换
        document.querySelectorAll('.rel-sub-tab[data-rel-tab]').forEach(btn => {
          btn.addEventListener('click', function () {
            const relTabId = this.dataset.relTab;
            document.querySelectorAll('.rel-sub-tab').forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            document.querySelectorAll('.rel-pane').forEach(p => p.classList.remove('active'));
            const pane = document.querySelector(`.rel-pane[data-rel-pane="${relTabId}"]`);
            if (pane) pane.classList.add('active');
          });
        });
        // 传闻子 Tab 切换
        document.querySelectorAll('.rumor-sub-tab[data-rumor-tab]').forEach(btn => {
          btn.addEventListener('click', function () {
            const rumorTabId = this.dataset.rumorTab;
            document.querySelectorAll('.rumor-sub-tab').forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            document.querySelectorAll('.rumor-pane').forEach(p => p.classList.remove('active'));
            const pane = document.querySelector(`.rumor-pane[data-rumor-pane="${rumorTabId}"]`);
            if (pane) pane.classList.add('active');
          });
        });
        // 情报购买按钮
        document.querySelectorAll('.rumor-intel-buy').forEach(btn => {
          btn.addEventListener('click', function (e) {
            e.stopPropagation();
            const name = this.dataset.intelName;
            const seller = this.dataset.intelSeller;
            const text = `找${seller}购买情报「${name}」`;
            try {
              const win = window.parent || window;
              const $ = win.jQuery || window.jQuery;
              if (!$) return;
              const $ta = $(win.document).find('#send_textarea');
              if (!$ta.length) return;
              const cur = $ta.val() || '';
              if (cur.includes(text)) return;
              $ta.val((cur.trim() ? cur + '\n' : '') + text);
              $ta.trigger('input');
            } catch (err) {
              console.error('发送到聊天框失败:', err);
            }
          });
        });
        // 附近的人卡片点击 → 详情
        document.querySelectorAll('.nearby-card[data-nearby-name]').forEach(el => {
          el.addEventListener('click', function () {
            document.querySelectorAll('.nearby-card').forEach(c => c.classList.remove('active'));
            this.classList.add('active');
            const name = this.dataset.nearbyName;
            const d = fetchLatestMvuData();
            const personData = d?.附近的人?.[name];
            if (personData) renderNearbyDetail(name, personData);
          });
        });
      };
      let _activeTab = 'skills';
      let _activeRelTab = 'bonds';
      let _activeRumorTab = 'gossip';
      let _activeNearbyPerson = null;
      const refresh = () => {
        const data = fetchLatestMvuData();
        if (data && Object.keys(data).length > 0) {
          // 自动学习已解锁的技能并装备（无需打开悬浮球）
          autoLearnAndEquipSkills(data);
          const json = JSON.stringify(data);
          if (json !== _cachedData) {
            // 保存当前 tab
            const curTab = document.querySelector('.tab-item.active');
            if (curTab) _activeTab = curTab.dataset.tabId || 'skills';
            const curRelTab = document.querySelector('.rel-sub-tab.active');
            if (curRelTab) _activeRelTab = curRelTab.dataset.relTab || 'bonds';
            const curRumorTab = document.querySelector('.rumor-sub-tab.active');
            if (curRumorTab) _activeRumorTab = curRumorTab.dataset.rumorTab || 'gossip';
            const curNearby = document.querySelector('.nearby-card.active');
            if (curNearby) _activeNearbyPerson = curNearby.dataset.nearbyName;
            else _activeNearbyPerson = null;
            _cachedData = json;
            app.innerHTML = renderStatusBar(data);
            // 恢复 tab 状态
            if (_activeTab !== 'skills') {
              document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
              document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
              const btn = document.querySelector(`.tab-item[data-tab-id="${_activeTab}"]`);
              const pane = document.querySelector(`.tab-pane[data-pane="${_activeTab}"]`);
              if (btn) btn.classList.add('active');
              if (pane) pane.classList.add('active');
            }
            // 恢复关系子 tab 状态
            if (_activeRelTab !== 'bonds') {
              document.querySelectorAll('.rel-sub-tab').forEach(t => t.classList.remove('active'));
              document.querySelectorAll('.rel-pane').forEach(p => p.classList.remove('active'));
              const relBtn = document.querySelector(`.rel-sub-tab[data-rel-tab="${_activeRelTab}"]`);
              const relPane = document.querySelector(`.rel-pane[data-rel-pane="${_activeRelTab}"]`);
              if (relBtn) relBtn.classList.add('active');
              if (relPane) relPane.classList.add('active');
            }
            // 恢复传闻子 tab 状态
            if (_activeRumorTab !== 'gossip') {
              document.querySelectorAll('.rumor-sub-tab').forEach(t => t.classList.remove('active'));
              document.querySelectorAll('.rumor-pane').forEach(p => p.classList.remove('active'));
              const rumorBtn = document.querySelector(`.rumor-sub-tab[data-rumor-tab="${_activeRumorTab}"]`);
              const rumorPane = document.querySelector(`.rumor-pane[data-rumor-pane="${_activeRumorTab}"]`);
              if (rumorBtn) rumorBtn.classList.add('active');
              if (rumorPane) rumorPane.classList.add('active');
            }
            // 恢复附近的人详情状态
            if (_activeNearbyPerson) {
              const card = document.querySelector(`.nearby-card[data-nearby-name="${_activeNearbyPerson}"]`);
              if (card) {
                card.classList.add('active');
                const personData = data?.附近的人?.[_activeNearbyPerson];
                if (personData) renderNearbyDetail(_activeNearbyPerson, personData);
              }
            }
            bindEvents();
          }
        } else {
          if (!_cachedData) app.innerHTML = '<div class="no-data-hint">等待 MVU 数据加载…</div>';
        }
      };

      refresh();
      setInterval(refresh, 3000);
      try {
        const win = getParent();
        if (win.eventSource?.on) win.eventSource.on('mvu_data_updated', refresh);
      } catch (e) { }
    })();
  </script>
</body>
```
