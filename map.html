<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ê∑±Ê∏äÈÉΩÂ∏Ç ¬∑ ÂπªÊÉ≥‰∏ñÁïåÂú∞Âõæ</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Noto+Serif+SC:wght@400;600;700&display=swap" rel="stylesheet">
<style>
* { margin:0; padding:0; box-sizing:border-box; }
html, body { width:100%; height:100%; overflow:hidden; font-family:'Noto Serif SC',serif; }
body {
  background: linear-gradient(135deg, #2b3a4a 0%, #1e2d3d 40%, #1a2535 100%);
  color: #c8b88a;
}
/* SVG noise texture overlay */
body::before {
  content:''; position:fixed; inset:0; z-index:0; pointer-events:none;
  background: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
  background-size: 256px 256px;
}
/* Vignette */
body::after {
  content:''; position:fixed; inset:0; z-index:1; pointer-events:none;
  background: radial-gradient(ellipse at center, transparent 50%, rgba(10,15,20,0.5) 100%);
}
#map-container { position:relative; width:100%; height:100%; z-index:2; overflow:hidden; cursor:grab; }
#map-container.grabbing { cursor:grabbing; }
#edge-canvas { position:absolute; top:0; left:0; width:100%; height:100%; }
#node-layer { position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; }
.node-wrapper {
  position:absolute; display:flex; flex-direction:column; align-items:center;
  pointer-events:auto; cursor:pointer; transform:translate(-50%,-50%);
  transition: filter 0.2s;
}
.node-wrapper:hover { filter: brightness(1.3) drop-shadow(0 0 8px rgba(200,184,138,0.5)); }
.node-icon svg { display:block; filter: drop-shadow(1px 2px 3px rgba(0,0,0,0.7)) drop-shadow(0 0 5px rgba(0,0,0,0.4)); }
.node-label {
  margin-top:5px; white-space:nowrap; text-align:center;
  color:#f0e8d0; font-weight:700;
  text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000;
  font-family:'Noto Serif SC',serif; line-height:1.3;
  background: rgba(12,18,28,0.82);
  padding: 3px 10px; border-radius: 4px;
}
/* City/Castle glow halo */
.node-wrapper[data-tier="major"] .node-icon svg {
  filter: drop-shadow(1px 2px 3px rgba(0,0,0,0.7)) drop-shadow(0 0 8px rgba(200,168,80,0.35));
}
.node-wrapper[data-tier="major"] .node-label { color: #f0e4c4; font-weight: 700; }

/* ============ DETAIL MODAL STYLES ============ */
.detail-overlay {
  display:none; position:fixed; inset:0; z-index:200;
  background:rgba(5,10,18,0.75); backdrop-filter:blur(6px);
  justify-content:center; align-items:center;
}
.detail-overlay.active { display:flex; }
.detail-panel {
  position:relative; width:90%; max-width:680px; max-height:85vh;
  background: linear-gradient(160deg, rgba(28,36,48,0.97) 0%, rgba(22,30,42,0.98) 100%);
  border:1px solid rgba(200,184,138,0.25); border-radius:12px;
  overflow-y:auto; padding:0;
  box-shadow: 0 8px 40px rgba(0,0,0,0.6), 0 0 60px rgba(200,184,138,0.05);
}
.detail-panel::-webkit-scrollbar { width:6px; }
.detail-panel::-webkit-scrollbar-track { background:transparent; }
.detail-panel::-webkit-scrollbar-thumb { background:rgba(200,184,138,0.2); border-radius:3px; }
.detail-close {
  position:sticky; top:0; right:0; z-index:10; float:right;
  margin:12px 12px 0 0;
  width:32px; height:32px; border:1px solid rgba(200,184,138,0.2);
  background:rgba(20,28,36,0.9); color:#c8b88a; font-size:18px;
  border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center;
  transition: background 0.2s;
}
.detail-close:hover { background:rgba(200,184,138,0.15); }
.detail-header {
  padding:28px 28px 16px; border-bottom:1px solid rgba(200,184,138,0.1);
  background: linear-gradient(180deg, rgba(200,184,138,0.04) 0%, transparent 100%);
}
.detail-title {
  font-family:'Cinzel','Noto Serif SC',serif; font-size:22px; font-weight:700;
  color:#e8dcc0; margin-bottom:8px; line-height:1.3;
  display:flex; align-items:center; gap:12px;
}
.detail-title svg { flex-shrink:0; filter:drop-shadow(1px 2px 3px rgba(0,0,0,0.5)); }
.detail-type-badge {
  display:inline-block; padding:3px 10px; border-radius:12px; font-size:11px;
  background:rgba(200,184,138,0.12); color:#c8b88a; border:1px solid rgba(200,184,138,0.2);
  font-family:'Noto Serif SC',serif; letter-spacing:0.5px;
}
.detail-summary {
  padding:16px 28px; color:#b8b8a8; font-size:14px; line-height:1.8;
  white-space:pre-line; border-bottom:1px solid rgba(200,184,138,0.08);
}
.detail-body { padding:8px 28px 28px; }
.detail-section {
  margin-top:16px; padding-top:14px;
  border-top:1px solid rgba(200,184,138,0.06);
}
.detail-section:first-child { margin-top:8px; border-top:none; padding-top:0; }
.detail-section-title {
  font-size:13px; font-weight:600; color:#c8b88a; margin-bottom:8px;
  letter-spacing:0.5px; display:flex; align-items:center; gap:6px;
}
.detail-section-title::before {
  content:''; display:inline-block; width:3px; height:14px;
  background:linear-gradient(180deg, #c8a84a, #8a6a3a); border-radius:2px;
}
.detail-section-content {
  color:#a8a898; font-size:13px; line-height:1.7; white-space:pre-line;
}
.detail-grid {
  display:grid; grid-template-columns:1fr 1fr; gap:8px;
}
.detail-grid-item {
  background:rgba(200,184,138,0.04); border:1px solid rgba(200,184,138,0.08);
  border-radius:6px; padding:8px 10px;
}
.detail-grid-item .grid-label {
  font-size:11px; color:#8a8a7a; margin-bottom:3px;
}
.detail-grid-item .grid-value {
  font-size:12px; color:#c0b8a0; line-height:1.5; white-space:pre-line;
}
.detail-tags { display:flex; flex-wrap:wrap; gap:6px; }
.detail-tag {
  display:inline-block; padding:3px 10px; border-radius:10px; font-size:12px;
  background:rgba(200,184,138,0.08); color:#b8a880; border:1px solid rgba(200,184,138,0.12);
  line-height:1.4;
}
.detail-connections {
  margin-top:16px; padding-top:14px;
  border-top:1px solid rgba(200,184,138,0.06);
}
.detail-conn-item {
  display:inline-flex; align-items:center; gap:4px;
  padding:4px 10px; margin:3px 4px 3px 0; border-radius:8px; font-size:12px;
  background:rgba(100,140,180,0.08); color:#8ab0c8; border:1px solid rgba(100,140,180,0.15);
  cursor:pointer; transition: background 0.2s;
}
.detail-conn-item:hover { background:rgba(100,140,180,0.18); }
.detail-conn-dist {
  font-size:10px; color:#6a8a9a; margin-left:2px;
}
/* ============ EDIT MODE STYLES ============ */
.edit-toolbar {
  position:fixed; top:16px; left:16px; z-index:60;
  display:flex; gap:6px; align-items:center;
}
.edit-btn {
  padding:6px 14px; border-radius:6px; font-size:13px; cursor:pointer;
  font-family:'Noto Serif SC',serif; border:1px solid rgba(200,184,138,0.3);
  background:rgba(20,28,36,0.9); color:#c8b88a; transition: all 0.2s;
  backdrop-filter:blur(4px);
}
.edit-btn:hover { background:rgba(200,184,138,0.15); }
.edit-btn.active { background:rgba(200,168,80,0.25); border-color:rgba(200,168,80,0.6); color:#f0e4c4; }
.edit-btn.danger.active { background:rgba(180,60,60,0.25); border-color:rgba(200,80,80,0.6); color:#f0a0a0; }
.edit-hint {
  font-size:11px; color:#8a8a7a; margin-left:8px; font-family:'Noto Serif SC',serif;
}
.node-wrapper.editing { cursor:move; }
.node-wrapper.editing:hover { filter: brightness(1.3) drop-shadow(0 0 12px rgba(200,168,80,0.6)); }

/* ============ SPECIAL MARKER STYLES ============ */
/* ÈÄöÂæÄÁ¨¨‰∫åÂ±ÇÂÖ•Âè£Ê†áËÆ∞ */
.special-marker-layer2 {
  position: absolute; pointer-events: none; z-index: -1;
}
.special-marker-layer2::before {
  content: ''; position: absolute; top: 50%; left: 50%;
  width: 90px; height: 90px; transform: translate(-50%, -50%);
  border-radius: 50%;
  background: radial-gradient(circle, rgba(80,160,255,0.35) 0%, rgba(80,160,255,0.08) 50%, transparent 70%);
  animation: pulse-layer2 2.5s ease-in-out infinite;
}
.special-marker-layer2::after {
  content: ''; position: absolute; top: 50%; left: 50%;
  width: 110px; height: 110px; transform: translate(-50%, -50%);
  border-radius: 50%;
  border: 2px dashed rgba(80,160,255,0.5);
  animation: spin-marker 12s linear infinite;
}
@keyframes pulse-layer2 {
  0%, 100% { opacity: 0.6; transform: translate(-50%, -50%) scale(1); }
  50% { opacity: 1; transform: translate(-50%, -50%) scale(1.15); }
}
@keyframes spin-marker {
  from { transform: translate(-50%, -50%) rotate(0deg); }
  to { transform: translate(-50%, -50%) rotate(360deg); }
}
.special-badge-layer2 {
  position: absolute; top: -18px; left: 50%; transform: translateX(-50%);
  white-space: nowrap; font-size: 10px; font-weight: 700;
  color: #5ac8ff; background: rgba(10,20,40,0.88);
  padding: 2px 8px; border-radius: 10px;
  border: 1px solid rgba(80,160,255,0.5);
  letter-spacing: 1px; pointer-events: none;
  text-shadow: 0 0 6px rgba(80,160,255,0.6);
  animation: badge-glow-layer2 2s ease-in-out infinite alternate;
}
@keyframes badge-glow-layer2 {
  0% { box-shadow: 0 0 4px rgba(80,160,255,0.3); }
  100% { box-shadow: 0 0 12px rgba(80,160,255,0.6); }
}

/* ÈÄöÂæÄÁ¨¨‰∏âÂ±ÇÂÖ•Âè£Ê†áËÆ∞ */
.special-marker-layer3 {
  position: absolute; pointer-events: none; z-index: -1;
}
.special-marker-layer3::before {
  content: ''; position: absolute; top: 50%; left: 50%;
  width: 95px; height: 95px; transform: translate(-50%, -50%);
  border-radius: 50%;
  background: radial-gradient(circle, rgba(168,85,247,0.4) 0%, rgba(168,85,247,0.1) 50%, transparent 70%);
  animation: pulse-layer3 2.8s ease-in-out infinite;
}
.special-marker-layer3::after {
  content: ''; position: absolute; top: 50%; left: 50%;
  width: 115px; height: 115px; transform: translate(-50%, -50%);
  border-radius: 50%;
  border: 2px dashed rgba(168,85,247,0.5);
  animation: spin-marker-layer3 14s linear infinite;
}
@keyframes pulse-layer3 {
  0%, 100% { opacity: 0.6; transform: translate(-50%, -50%) scale(1); }
  50% { opacity: 1; transform: translate(-50%, -50%) scale(1.15); }
}
@keyframes spin-marker-layer3 {
  from { transform: translate(-50%, -50%) rotate(0deg); }
  to { transform: translate(-50%, -50%) rotate(360deg); }
}
.special-badge-layer3 {
  position: absolute; top: -18px; left: 50%; transform: translateX(-50%);
  white-space: nowrap; font-size: 10px; font-weight: 700;
  color: #c084fc; background: rgba(20,10,35,0.9);
  padding: 2px 8px; border-radius: 10px;
  border: 1px solid rgba(168,85,247,0.5);
  letter-spacing: 1px; pointer-events: none;
  text-shadow: 0 0 6px rgba(168,85,247,0.6);
  animation: badge-glow-layer3 2s ease-in-out infinite alternate;
}
@keyframes badge-glow-layer3 {
  0% { box-shadow: 0 0 4px rgba(168,85,247,0.3); }
  100% { box-shadow: 0 0 12px rgba(168,85,247,0.6); }
}

/* ‰∏ñÁïå‰πãÁóïÂÖ•Âè£Ê†áËÆ∞ */
.special-marker-worldscar {
  position: absolute; pointer-events: none; z-index: -1;
}
.special-marker-worldscar::before {
  content: ''; position: absolute; top: 50%; left: 50%;
  width: 100px; height: 100px; transform: translate(-50%, -50%);
  border-radius: 50%;
  background: radial-gradient(circle, rgba(255,170,50,0.4) 0%, rgba(255,140,30,0.1) 50%, transparent 70%);
  animation: pulse-worldscar 3s ease-in-out infinite;
}
.special-marker-worldscar::after {
  content: ''; position: absolute; top: 50%; left: 50%;
  width: 120px; height: 120px; transform: translate(-50%, -50%);
  border: 2px solid rgba(255,170,50,0.4);
  border-radius: 50%;
  animation: ring-worldscar 3s ease-in-out infinite;
}
@keyframes pulse-worldscar {
  0%, 100% { opacity: 0.5; transform: translate(-50%, -50%) scale(1); }
  50% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
}
@keyframes ring-worldscar {
  0%, 100% { opacity: 0.3; transform: translate(-50%, -50%) scale(1); }
  50% { opacity: 0.8; transform: translate(-50%, -50%) scale(1.1); }
}
.special-badge-worldscar {
  position: absolute; top: -18px; left: 50%; transform: translateX(-50%);
  white-space: nowrap; font-size: 10px; font-weight: 700;
  color: #ffaa32; background: rgba(30,18,5,0.9);
  padding: 2px 8px; border-radius: 10px;
  border: 1px solid rgba(255,170,50,0.5);
  letter-spacing: 1px; pointer-events: none;
  text-shadow: 0 0 6px rgba(255,170,50,0.6);
  animation: badge-glow-worldscar 2s ease-in-out infinite alternate;
}
@keyframes badge-glow-worldscar {
  0% { box-shadow: 0 0 4px rgba(255,170,50,0.3); }
  100% { box-shadow: 0 0 12px rgba(255,170,50,0.6); }
}
.edge-delete-hit {
  position:absolute; pointer-events:auto; cursor:pointer; z-index:3;
}

/* ============ PLAYER LOCATION MARKER ============ */
.player-marker {
  position: absolute; pointer-events: none; z-index: 10;
  width: 0; height: 0;
}
.player-marker-ping {
  position: absolute; top: 50%; left: 50%;
  width: 28px; height: 28px; transform: translate(-50%, -50%);
  border-radius: 50%;
  background: radial-gradient(circle, rgba(0,220,130,0.7) 0%, rgba(0,220,130,0.15) 60%, transparent 75%);
  animation: player-ping 2s ease-in-out infinite;
}
.player-marker-ring {
  position: absolute; top: 50%; left: 50%;
  width: 44px; height: 44px; transform: translate(-50%, -50%);
  border-radius: 50%;
  border: 2px solid rgba(0,220,130,0.6);
  animation: player-ring 2s ease-in-out infinite;
}
.player-marker-dot {
  position: absolute; top: 50%; left: 50%;
  width: 10px; height: 10px; transform: translate(-50%, -50%);
  border-radius: 50%;
  background: #00dc82;
  box-shadow: 0 0 8px rgba(0,220,130,0.8), 0 0 16px rgba(0,220,130,0.4);
  z-index: 2;
}
.player-marker-label {
  position: absolute; top: 50%; left: 50%;
  transform: translate(-50%, 22px);
  white-space: nowrap; font-size: 10px; font-weight: 700;
  color: #00dc82; background: rgba(10,20,15,0.88);
  padding: 2px 8px; border-radius: 8px;
  border: 1px solid rgba(0,220,130,0.5);
  letter-spacing: 0.5px; pointer-events: none;
  text-shadow: 0 0 4px rgba(0,220,130,0.5);
  font-family: 'Noto Serif SC', serif;
  z-index: 2;
}
@keyframes player-ping {
  0%, 100% { opacity: 0.5; transform: translate(-50%, -50%) scale(1); }
  50% { opacity: 1; transform: translate(-50%, -50%) scale(1.4); }
}
@keyframes player-ring {
  0%, 100% { opacity: 0.4; transform: translate(-50%, -50%) scale(1); }
  50% { opacity: 0.8; transform: translate(-50%, -50%) scale(1.2); }
}
#layer-switcher .layer-btn:hover {
  background:rgba(200,184,138,0.15) !important;
  color:#c8b88a !important;
}
#layer-switcher .layer-btn.active:hover {
  background:rgba(200,168,80,0.3) !important;
  color:#f0e4c4 !important;
}
</style>
</head>
<body>

<!-- ============ SVG SYMBOL DEFINITIONS ============ -->
<svg style="display:none" xmlns="http://www.w3.org/2000/svg">
<defs>
  <!-- CITY: Castle with 3 towers -->
  <symbol id="icon-city" viewBox="0 0 32 32">
    <rect x="8" y="14" width="16" height="14" rx="1" fill="#b8956a" stroke="#3a2a1a" stroke-width="0.8"/>
    <rect x="10" y="16" width="3" height="4" rx="0.5" fill="#8a6a4a"/>
    <rect x="19" y="16" width="3" height="4" rx="0.5" fill="#8a6a4a"/>
    <rect x="5" y="8" width="6" height="20" rx="0.5" fill="#a8856a" stroke="#3a2a1a" stroke-width="0.7"/>
    <polygon points="5,8 8,2 11,8" fill="#8b3a3a" stroke="#3a2a1a" stroke-width="0.5"/>
    <rect x="21" y="8" width="6" height="20" rx="0.5" fill="#a8856a" stroke="#3a2a1a" stroke-width="0.7"/>
    <polygon points="21,8 24,2 27,8" fill="#8b3a3a" stroke="#3a2a1a" stroke-width="0.5"/>
    <rect x="12" y="6" width="8" height="22" rx="0.5" fill="#b8956a" stroke="#3a2a1a" stroke-width="0.7"/>
    <polygon points="12,6 16,0 20,6" fill="#8b3a3a" stroke="#3a2a1a" stroke-width="0.5"/>
    <circle cx="8" cy="14" r="0.8" fill="#ffd700"/>
    <circle cx="8" cy="18" r="0.8" fill="#ffd700"/>
    <circle cx="24" cy="14" r="0.8" fill="#ffd700"/>
    <circle cx="24" cy="18" r="0.8" fill="#ffd700"/>
    <circle cx="16" cy="12" r="1" fill="#ffd700"/>
    <circle cx="16" cy="16" r="0.8" fill="#ffd700"/>
    <path d="M14,28 L14,23 Q16,21 18,23 L18,28 Z" fill="#4a3020"/>
    <rect x="5" y="7.5" width="1.5" height="1.5" fill="#a8856a" stroke="#3a2a1a" stroke-width="0.3"/>
    <rect x="9.5" y="7.5" width="1.5" height="1.5" fill="#a8856a" stroke="#3a2a1a" stroke-width="0.3"/>
    <rect x="21" y="7.5" width="1.5" height="1.5" fill="#a8856a" stroke="#3a2a1a" stroke-width="0.3"/>
    <rect x="25.5" y="7.5" width="1.5" height="1.5" fill="#a8856a" stroke="#3a2a1a" stroke-width="0.3"/>
  </symbol>

  <!-- VILLAGE: 2-3 small houses -->
  <symbol id="icon-village" viewBox="0 0 32 32">
    <rect x="3" y="18" width="10" height="10" rx="0.5" fill="#d4b896" stroke="#5a4030" stroke-width="0.6"/>
    <polygon points="2,18 8,11 14,18" fill="#7a5a3a" stroke="#5a4030" stroke-width="0.5"/>
    <rect x="6" y="22" width="3" height="6" fill="#5a4030"/>
    <rect x="4.5" y="20" width="2" height="2" fill="#8ab0c8" opacity="0.6"/>
    <rect x="16" y="16" width="12" height="12" rx="0.5" fill="#d4b896" stroke="#5a4030" stroke-width="0.6"/>
    <polygon points="15,16 22,8 29,16" fill="#7a5a3a" stroke="#5a4030" stroke-width="0.5"/>
    <rect x="20" y="21" width="3" height="7" fill="#5a4030"/>
    <rect x="24" y="18.5" width="2.5" height="2.5" fill="#8ab0c8" opacity="0.6"/>
    <rect x="25" y="9" width="2" height="7" fill="#6a5040"/>
    <ellipse cx="26" cy="8" rx="1.5" ry="1" fill="#9a9a9a" opacity="0.4"/>
    <ellipse cx="26.5" cy="6" rx="1" ry="0.8" fill="#9a9a9a" opacity="0.25"/>
    <ellipse cx="27" cy="4.5" rx="0.8" ry="0.6" fill="#9a9a9a" opacity="0.15"/>
  </symbol>

  <!-- TOWN: Cluster of buildings with a tower -->
  <symbol id="icon-town" viewBox="0 0 32 32">
    <rect x="2" y="18" width="8" height="12" rx="0.5" fill="#c8a878" stroke="#5a4030" stroke-width="0.5"/>
    <polygon points="1,18 6,12 11,18" fill="#6a4a2a" stroke="#5a4030" stroke-width="0.4"/>
    <rect x="4" y="20" width="2" height="2" fill="#8ab0c8" opacity="0.6"/>
    <rect x="4" y="24" width="2" height="6" fill="#5a4030"/>
    <rect x="12" y="14" width="10" height="16" rx="0.5" fill="#d4b896" stroke="#5a4030" stroke-width="0.6"/>
    <polygon points="11,14 17,6 23,14" fill="#7a5a3a" stroke="#5a4030" stroke-width="0.5"/>
    <rect x="15" y="24" width="3" height="6" fill="#5a4030"/>
    <rect x="13" y="16" width="2.5" height="2.5" fill="#8ab0c8" opacity="0.6"/>
    <rect x="18.5" y="16" width="2.5" height="2.5" fill="#8ab0c8" opacity="0.6"/>
    <rect x="24" y="20" width="6" height="10" rx="0.5" fill="#c8a878" stroke="#5a4030" stroke-width="0.5"/>
    <polygon points="23,20 27,14 31,20" fill="#6a4a2a" stroke="#5a4030" stroke-width="0.4"/>
    <rect x="26" y="22" width="2" height="2" fill="#8ab0c8" opacity="0.6"/>
    <rect x="17" y="7" width="1.5" height="5" fill="#5a4030"/>
    <ellipse cx="18" cy="6" rx="1" ry="0.7" fill="#9a9a9a" opacity="0.3"/>
  </symbol>

  <!-- FOREST: 3 overlapping trees -->
  <symbol id="icon-forest" viewBox="0 0 32 32">
    <polygon points="16,2 8,18 24,18" fill="#4a8a3a" opacity="0.9"/>
    <polygon points="16,6 10,18 22,18" fill="#3a7a2a"/>
    <polygon points="9,6 3,22 15,22" fill="#2d5a1e"/>
    <polygon points="9,10 5,22 13,22" fill="#3a7a2a"/>
    <polygon points="23,6 17,22 29,22" fill="#2d5a1e"/>
    <polygon points="23,10 19,22 27,22" fill="#3a7a2a"/>
    <rect x="15" y="18" width="2" height="10" fill="#4a3020"/>
    <rect x="8" y="22" width="2" height="8" fill="#4a3020"/>
    <rect x="22" y="22" width="2" height="8" fill="#4a3020"/>
    <ellipse cx="16" cy="30" rx="12" ry="2" fill="#2d5a1e" opacity="0.3"/>
  </symbol>

  <!-- MOUNTAIN: Peak with snow cap -->
  <symbol id="icon-mountain" viewBox="0 0 32 32">
    <polygon points="0,28 8,12 16,28" fill="#6a5a4a" opacity="0.6"/>
    <polygon points="16,28 24,14 32,28" fill="#6a5a4a" opacity="0.6"/>
    <polygon points="16,2 4,30 28,30" fill="#7a6a5a" stroke="#5a4a3a" stroke-width="0.5"/>
    <line x1="10" y1="20" x2="14" y2="14" stroke="#5a4a3a" stroke-width="0.4" opacity="0.5"/>
    <line x1="22" y1="20" x2="18" y2="14" stroke="#5a4a3a" stroke-width="0.4" opacity="0.5"/>
    <polygon points="16,2 12,10 20,10" fill="#f0f0f0"/>
    <polygon points="16,2 11,11 13,10 16,6 19,10 21,11" fill="#e0e8f0"/>
    <path d="M12,10 Q13,12 14,10.5 Q15,12 16,10 Q17,12 18,10.5 Q19,12 20,10" fill="#e8ecf0" opacity="0.7"/>
  </symbol>

  <!-- TEMPLE: Domed building -->
  <symbol id="icon-temple" viewBox="0 0 32 32">
    <rect x="4" y="26" width="24" height="4" rx="0.5" fill="#a09080" stroke="#5a4a3a" stroke-width="0.5"/>
    <rect x="6" y="24" width="20" height="3" fill="#c0b0a0"/>
    <rect x="8" y="12" width="16" height="13" rx="0.5" fill="#e8dcc8" stroke="#8a7a6a" stroke-width="0.5"/>
    <rect x="9" y="14" width="1.5" height="11" fill="#d8ccb8"/>
    <rect x="13" y="14" width="1.5" height="11" fill="#d8ccb8"/>
    <rect x="17.5" y="14" width="1.5" height="11" fill="#d8ccb8"/>
    <rect x="21.5" y="14" width="1.5" height="11" fill="#d8ccb8"/>
    <path d="M8,12 Q8,4 16,2 Q24,4 24,12 Z" fill="#c8a84a" stroke="#8a7a3a" stroke-width="0.5"/>
    <line x1="16" y1="2" x2="16" y2="-1" stroke="#c8a84a" stroke-width="1.2"/>
    <line x1="14.5" y1="0.5" x2="17.5" y2="0.5" stroke="#c8a84a" stroke-width="1"/>
    <circle cx="16" cy="18" r="2" fill="#4a6a8a" opacity="0.5"/>
    <circle cx="16" cy="18" r="1.2" fill="#6a8aaa" opacity="0.4"/>
  </symbol>

  <!-- PORT: Small ship -->
  <symbol id="icon-port" viewBox="0 0 32 32">
    <path d="M2,24 Q6,22 10,24 Q14,26 18,24 Q22,22 26,24 Q30,26 32,24 L32,32 L0,32 Z" fill="#4a7a9a" opacity="0.5"/>
    <path d="M6,22 L10,28 L22,28 L26,22 Z" fill="#5a4030" stroke="#3a2a1a" stroke-width="0.6"/>
    <path d="M8,22 L10,26 L22,26 L24,22 Z" fill="#6a5040"/>
    <line x1="16" y1="6" x2="16" y2="22" stroke="#5a4030" stroke-width="1.2"/>
    <path d="M16,6 L16,20 L8,18 Z" fill="#e8dcc8" stroke="#b8a888" stroke-width="0.4"/>
    <path d="M16,8 L16,20 L23,17 Z" fill="#d8ccb8" stroke="#b8a888" stroke-width="0.4"/>
    <path d="M16,6 L20,4 L16,2" fill="#8b3a3a"/>
    <line x1="8" y1="18" x2="10" y2="22" stroke="#8a7a5a" stroke-width="0.3"/>
    <line x1="23" y1="17" x2="22" y2="22" stroke="#8a7a5a" stroke-width="0.3"/>
  </symbol>

  <!-- RUINS: Broken columns -->
  <symbol id="icon-ruins" viewBox="0 0 32 32">
    <ellipse cx="16" cy="29" rx="13" ry="3" fill="#6a6a5a" opacity="0.4"/>
    <rect x="5" y="10" width="4" height="18" fill="#8a8a7a" stroke="#5a5a4a" stroke-width="0.4"/>
    <polygon points="5,10 5.5,8 6.5,9 7.5,7 8.5,9.5 9,10" fill="#8a8a7a"/>
    <rect x="21" y="14" width="4" height="14" fill="#7a7a6a" stroke="#5a5a4a" stroke-width="0.4"/>
    <polygon points="21,14 21.5,13 23,12 24.5,13.5 25,14" fill="#7a7a6a"/>
    <rect x="11" y="24" width="6" height="4" rx="0.5" fill="#6a6a5a" stroke="#4a4a3a" stroke-width="0.3" transform="rotate(-12,14,26)"/>
    <path d="M9,10 Q16,4 23,14" fill="none" stroke="#8a8a7a" stroke-width="2" opacity="0.6"/>
    <path d="M6,15 L7.5,18 L6.5,22" fill="none" stroke="#4a4a3a" stroke-width="0.4"/>
    <path d="M22,17 L23.5,20 L22.5,24" fill="none" stroke="#4a4a3a" stroke-width="0.4"/>
    <circle cx="13" cy="27" r="1.2" fill="#7a7a6a"/>
    <circle cx="18" cy="28" r="0.9" fill="#6a6a5a"/>
    <rect x="15" y="20" width="3" height="2" rx="0.3" fill="#6a6a5a" transform="rotate(20,16.5,21)"/>
  </symbol>

  <!-- DUNGEON: Dark cave entrance -->
  <symbol id="icon-dungeon" viewBox="0 0 32 32">
    <path d="M2,30 L4,14 L8,10 L12,8 L16,6 L20,8 L24,10 L28,14 L30,30 Z" fill="#4a4a4a" stroke="#2a2a2a" stroke-width="0.5"/>
    <path d="M8,30 L10,16 Q16,12 22,16 L24,30 Z" fill="#1a1a1a"/>
    <path d="M10,30 L12,20 Q16,16 20,20 L22,30 Z" fill="#8a3030" opacity="0.3"/>
    <path d="M12,30 L14,22 Q16,20 18,22 L20,30 Z" fill="#aa4040" opacity="0.2"/>
    <polygon points="12,16 12.5,20 11.5,20" fill="#3a3a3a"/>
    <polygon points="16,13 16.5,18 15.5,18" fill="#3a3a3a"/>
    <polygon points="20,16 20.5,19 19.5,19" fill="#3a3a3a"/>
    <circle cx="14" cy="24" r="0.8" fill="#cc4444" opacity="0.6"/>
    <circle cx="18" cy="24" r="0.8" fill="#cc4444" opacity="0.6"/>
    <path d="M4,20 L6,18 L5,22" fill="none" stroke="#3a3a3a" stroke-width="0.4"/>
    <path d="M26,20 L28,18 L27,22" fill="none" stroke="#3a3a3a" stroke-width="0.4"/>
  </symbol>

  <!-- MINE: Pickaxe over rocks -->
  <symbol id="icon-mine" viewBox="0 0 32 32">
    <polygon points="6,28 10,22 16,26 12,30" fill="#7a7a6a" stroke="#5a5a4a" stroke-width="0.4"/>
    <polygon points="16,26 22,20 28,26 22,30" fill="#6a6a5a" stroke="#4a4a3a" stroke-width="0.4"/>
    <polygon points="12,24 16,18 20,24" fill="#8a8a7a" stroke="#5a5a4a" stroke-width="0.4"/>
    <line x1="8" y1="6" x2="24" y2="22" stroke="#6a4a2a" stroke-width="2" stroke-linecap="round"/>
    <path d="M6,4 L12,2 L10,8 Z" fill="#9a9aaa" stroke="#6a6a7a" stroke-width="0.5"/>
    <path d="M6,4 L4,10 L10,8 Z" fill="#8a8a9a" stroke="#6a6a7a" stroke-width="0.5"/>
    <circle cx="18" cy="22" r="1.5" fill="#7a5a9a" opacity="0.8"/>
    <circle cx="18" cy="22" r="0.6" fill="#aa8acc"/>
    <circle cx="24" cy="24" r="1.2" fill="#5a7a9a" opacity="0.8"/>
    <circle cx="24" cy="24" r="0.5" fill="#8aaabb"/>
    <line x1="18" y1="20" x2="18" y2="19" stroke="#aa8acc" stroke-width="0.4"/>
    <line x1="16.5" y1="22" x2="15.5" y2="22" stroke="#aa8acc" stroke-width="0.4"/>
    <line x1="19.5" y1="22" x2="20.5" y2="22" stroke="#aa8acc" stroke-width="0.4"/>
  </symbol>

  <!-- CAMP: Tent with campfire -->
  <symbol id="icon-camp" viewBox="0 0 32 32">
    <polygon points="4,28 16,6 28,28" fill="#b89a6a" stroke="#7a5a3a" stroke-width="0.6"/>
    <polygon points="8,28 16,10 24,28" fill="#a88a5a"/>
    <path d="M13,28 L16,18 L19,28 Z" fill="#5a4030"/>
    <circle cx="16" cy="6" r="0.8" fill="#7a5a3a"/>
    <ellipse cx="16" cy="29" rx="3" ry="1" fill="#4a3020" opacity="0.5"/>
    <path d="M14,28 Q13,24 15,22 Q16,20 16,18 Q16,20 17,22 Q19,24 18,28 Z" fill="#d4642a" opacity="0.8" transform="translate(0,2) scale(0.6) translate(10,18)"/>
    <path d="M15,28 Q14.5,25 16,23 Q17.5,25 17,28 Z" fill="#ffa030" opacity="0.9" transform="translate(0,2) scale(0.6) translate(10,18)"/>
    <ellipse cx="22" cy="14" rx="1" ry="0.6" fill="#8a8a8a" opacity="0.15"/>
    <ellipse cx="21.5" cy="12" rx="0.8" ry="0.5" fill="#8a8a8a" opacity="0.1"/>
  </symbol>
</defs>
</svg>

<svg style="display:none" xmlns="http://www.w3.org/2000/svg">
<defs>
  <!-- WAYSTATION: Signpost -->
  <symbol id="icon-waystation" viewBox="0 0 32 32">
    <rect x="14.5" y="8" width="3" height="22" rx="0.5" fill="#6a4a2a" stroke="#4a3020" stroke-width="0.4"/>
    <circle cx="16" cy="8" r="2" fill="#6a4a2a" stroke="#4a3020" stroke-width="0.4"/>
    <polygon points="18,11 28,10 28,15 18,16" fill="#b89a6a" stroke="#7a5a3a" stroke-width="0.4"/>
    <line x1="20" y1="12" x2="26" y2="11.5" stroke="#7a5a3a" stroke-width="0.3"/>
    <line x1="20" y1="14" x2="26" y2="13.5" stroke="#7a5a3a" stroke-width="0.3"/>
    <polygon points="14,17 4,16 4,21 14,22" fill="#a88a5a" stroke="#7a5a3a" stroke-width="0.4"/>
    <line x1="6" y1="17.5" x2="12" y2="18" stroke="#6a4a2a" stroke-width="0.3"/>
    <line x1="6" y1="19.5" x2="12" y2="20" stroke="#6a4a2a" stroke-width="0.3"/>
    <ellipse cx="16" cy="30" rx="5" ry="1.5" fill="#4a3a2a" opacity="0.3"/>
  </symbol>

  <!-- SHOP: Market stall -->
  <symbol id="icon-shop" viewBox="0 0 32 32">
    <rect x="4" y="14" width="24" height="14" rx="0.5" fill="#7a5a3a" stroke="#4a3020" stroke-width="0.5"/>
    <rect x="3" y="20" width="26" height="2" fill="#8a6a4a"/>
    <path d="M2,14 L16,8 L30,14 Z" fill="#9a3a2a" stroke="#6a2a1a" stroke-width="0.4"/>
    <path d="M4,14 Q8,12 10,14 Q12,12 14,14 Q16,12 18,14 Q20,12 22,14 Q24,12 26,14 Q28,12 28,14" fill="none" stroke="#7a2a1a" stroke-width="0.6"/>
    <circle cx="10" cy="17" r="1.5" fill="#c8a840"/>
    <circle cx="14" cy="17" r="1.5" fill="#c8a840"/>
    <circle cx="18" cy="17" r="1.5" fill="#d4642a"/>
    <rect x="21" y="15.5" width="3" height="3" rx="0.3" fill="#6a8a4a"/>
    <line x1="8" y1="14" x2="8" y2="16" stroke="#8a7a5a" stroke-width="0.3"/>
    <circle cx="8" cy="16.5" r="0.8" fill="#9a8a5a"/>
    <line x1="24" y1="14" x2="24" y2="16" stroke="#8a7a5a" stroke-width="0.3"/>
    <circle cx="24" cy="16.5" r="0.8" fill="#9a8a5a"/>
  </symbol>

  <!-- TOWER: Tall narrow tower -->
  <symbol id="icon-tower" viewBox="0 0 32 32">
    <rect x="11" y="8" width="10" height="22" rx="0.5" fill="#7a7a6a" stroke="#4a4a3a" stroke-width="0.5"/>
    <line x1="11" y1="14" x2="21" y2="14" stroke="#6a6a5a" stroke-width="0.3"/>
    <line x1="11" y1="20" x2="21" y2="20" stroke="#6a6a5a" stroke-width="0.3"/>
    <line x1="16" y1="8" x2="16" y2="14" stroke="#6a6a5a" stroke-width="0.3"/>
    <line x1="14" y1="14" x2="14" y2="20" stroke="#6a6a5a" stroke-width="0.3"/>
    <line x1="18" y1="14" x2="18" y2="20" stroke="#6a6a5a" stroke-width="0.3"/>
    <polygon points="10,8 16,0 22,8" fill="#3a4a5a" stroke="#2a3a4a" stroke-width="0.5"/>
    <rect x="14" y="10" width="4" height="3" rx="1.5" fill="#ffd700" opacity="0.7"/>
    <rect x="14" y="10" width="4" height="3" rx="1.5" fill="none" stroke="#8a7a3a" stroke-width="0.3"/>
    <rect x="14.5" y="22" width="3" height="3" rx="0.5" fill="#ffd700" opacity="0.5"/>
    <rect x="10.5" y="7" width="2" height="2" fill="#7a7a6a" stroke="#4a4a3a" stroke-width="0.3"/>
    <rect x="19.5" y="7" width="2" height="2" fill="#7a7a6a" stroke="#4a4a3a" stroke-width="0.3"/>
  </symbol>

  <!-- WILDERNESS: Wind-blown grass/dead tree -->
  <symbol id="icon-wilderness" viewBox="0 0 32 32">
    <path d="M16,28 L16,12 Q14,10 12,8 M16,16 Q18,14 20,10 M16,20 Q13,18 10,16" fill="none" stroke="#6a5a3a" stroke-width="1.5" stroke-linecap="round"/>
    <path d="M4,28 Q6,22 8,24 Q10,20 12,26" fill="none" stroke="#7a8a5a" stroke-width="0.8"/>
    <path d="M20,28 Q22,22 24,25 Q26,20 28,26" fill="none" stroke="#7a8a5a" stroke-width="0.8"/>
    <path d="M8,30 Q10,26 12,28" fill="none" stroke="#6a7a4a" stroke-width="0.6"/>
    <path d="M22,30 Q24,26 26,29" fill="none" stroke="#6a7a4a" stroke-width="0.6"/>
    <path d="M2,14 Q8,12 14,14" fill="none" stroke="#8a9a7a" stroke-width="0.3" opacity="0.5"/>
    <path d="M6,18 Q12,16 18,18" fill="none" stroke="#8a9a7a" stroke-width="0.3" opacity="0.4"/>
    <ellipse cx="16" cy="30" rx="12" ry="2" fill="#5a5a3a" opacity="0.2"/>
  </symbol>

  <!-- SWAMP: Murky water with reeds -->
  <symbol id="icon-swamp" viewBox="0 0 32 32">
    <ellipse cx="16" cy="24" rx="14" ry="8" fill="#3a4a3a"/>
    <ellipse cx="16" cy="24" rx="12" ry="6" fill="#2a3a2a" opacity="0.6"/>
    <path d="M6,22 Q10,20 14,22 Q18,24 22,22 Q26,20 28,22" fill="none" stroke="#4a5a4a" stroke-width="0.5"/>
    <path d="M8,26 Q12,24 16,26 Q20,28 24,26" fill="none" stroke="#4a5a4a" stroke-width="0.4"/>
    <line x1="8" y1="10" x2="7" y2="22" stroke="#6a5a3a" stroke-width="1" stroke-linecap="round"/>
    <ellipse cx="8" cy="9" rx="1.5" ry="2.5" fill="#5a4a2a"/>
    <line x1="14" y1="8" x2="13" y2="20" stroke="#6a5a3a" stroke-width="0.8" stroke-linecap="round"/>
    <ellipse cx="14" cy="7" rx="1.2" ry="2" fill="#5a4a2a"/>
    <line x1="22" y1="12" x2="21" y2="22" stroke="#6a5a3a" stroke-width="0.8" stroke-linecap="round"/>
    <ellipse cx="22" cy="11" rx="1.2" ry="2" fill="#5a4a2a"/>
    <circle cx="12" cy="24" r="0.8" fill="#5a6a5a" opacity="0.5"/>
    <circle cx="18" cy="22" r="0.6" fill="#5a6a5a" opacity="0.4"/>
    <circle cx="20" cy="26" r="0.5" fill="#5a6a5a" opacity="0.3"/>
  </symbol>

  <!-- PLAINS: Rolling hills -->
  <symbol id="icon-plains" viewBox="0 0 32 32">
    <path d="M0,20 Q8,12 16,16 Q24,12 32,18 L32,32 L0,32 Z" fill="#7a8a5a" opacity="0.5"/>
    <path d="M0,24 Q6,16 14,20 Q20,14 28,20 L32,22 L32,32 L0,32 Z" fill="#8a9a6a"/>
    <path d="M6,22 L7,19 L8,22" fill="none" stroke="#6a7a4a" stroke-width="0.4"/>
    <path d="M12,20 L13,17 L14,20" fill="none" stroke="#6a7a4a" stroke-width="0.4"/>
    <path d="M20,18 L21,15 L22,18" fill="none" stroke="#6a7a4a" stroke-width="0.4"/>
    <path d="M26,20 L27,17 L28,20" fill="none" stroke="#6a7a4a" stroke-width="0.4"/>
    <circle cx="10" cy="22" r="0.5" fill="#c8a860" opacity="0.6"/>
    <circle cx="18" cy="20" r="0.5" fill="#c8a860" opacity="0.6"/>
    <circle cx="24" cy="22" r="0.5" fill="#c8a860" opacity="0.6"/>
    <path d="M4,26 Q10,24 16,26 Q22,24 28,26" fill="none" stroke="#9aaa7a" stroke-width="0.3" opacity="0.4"/>
  </symbol>

  <!-- CEMETERY: Tombstones -->
  <symbol id="icon-cemetery" viewBox="0 0 32 32">
    <ellipse cx="16" cy="28" rx="14" ry="4" fill="#3a4a3a" opacity="0.3"/>
    <rect x="4" y="16" width="6" height="12" rx="0.5" fill="#7a7a7a" stroke="#5a5a5a" stroke-width="0.4"/>
    <path d="M4,16 Q7,12 10,16" fill="#7a7a7a" stroke="#5a5a5a" stroke-width="0.4"/>
    <rect x="13" y="14" width="6" height="14" rx="0.5" fill="#6a6a6a" stroke="#4a4a4a" stroke-width="0.4"/>
    <path d="M13,14 Q16,10 19,14" fill="#6a6a6a" stroke="#4a4a4a" stroke-width="0.4"/>
    <rect x="24" y="8" width="2" height="18" fill="#3a3a3a" stroke="#2a2a2a" stroke-width="0.4"/>
    <rect x="21" y="12" width="8" height="2" fill="#3a3a3a" stroke="#2a2a2a" stroke-width="0.4"/>
    <circle cx="6" cy="24" r="1" fill="#4a6a3a" opacity="0.5"/>
    <circle cx="15" cy="26" r="0.8" fill="#4a6a3a" opacity="0.4"/>
    <path d="M7,18 L6.5,21 L7.5,23" fill="none" stroke="#5a5a5a" stroke-width="0.3"/>
    <path d="M16,16 L15.5,19 L16.5,22" fill="none" stroke="#4a4a4a" stroke-width="0.3"/>
  </symbol>

  <!-- DESERT: Sand dunes -->
  <symbol id="icon-desert" viewBox="0 0 32 32">
    <path d="M0,22 Q8,14 16,18 Q24,14 32,20 L32,32 L0,32 Z" fill="#c8a860" opacity="0.6"/>
    <path d="M0,26 Q6,18 14,22 Q22,16 32,24 L32,32 L0,32 Z" fill="#b89850"/>
    <path d="M6,20 Q10,17 14,22" fill="none" stroke="#a88840" stroke-width="0.4"/>
    <path d="M22,18 Q26,16 30,22" fill="none" stroke="#a88840" stroke-width="0.4"/>
    <rect x="18" y="10" width="2" height="14" rx="1" fill="#5a7a3a" stroke="#3a5a2a" stroke-width="0.4"/>
    <path d="M18,16 Q14,16 14,12 L14,12 Q14,14 16,14" fill="none" stroke="#5a7a3a" stroke-width="1.5" stroke-linecap="round"/>
    <path d="M20,14 Q24,14 24,10 L24,10 Q24,12 22,12" fill="none" stroke="#5a7a3a" stroke-width="1.5" stroke-linecap="round"/>
    <ellipse cx="8" cy="24" rx="2.5" ry="2" fill="#d8d0c0"/>
    <circle cx="7" cy="23.5" r="0.6" fill="#3a3020"/>
    <circle cx="9" cy="23.5" r="0.6" fill="#3a3020"/>
    <path d="M7.5,25.5 L8.5,25.5" stroke="#3a3020" stroke-width="0.3"/>
  </symbol>
</defs>
</svg>

<svg style="display:none" xmlns="http://www.w3.org/2000/svg">
<defs>
  <!-- CASTLE: Fortress with walls and battlements -->
  <symbol id="icon-castle" viewBox="0 0 32 32">
    <rect x="2" y="14" width="28" height="16" rx="0.5" fill="#a8856a" stroke="#3a2a1a" stroke-width="0.7"/>
    <rect x="2" y="13" width="3" height="3" fill="#a8856a" stroke="#3a2a1a" stroke-width="0.3"/>
    <rect x="7" y="13" width="3" height="3" fill="#a8856a" stroke="#3a2a1a" stroke-width="0.3"/>
    <rect x="12" y="13" width="3" height="3" fill="#a8856a" stroke="#3a2a1a" stroke-width="0.3"/>
    <rect x="17" y="13" width="3" height="3" fill="#a8856a" stroke="#3a2a1a" stroke-width="0.3"/>
    <rect x="22" y="13" width="3" height="3" fill="#a8856a" stroke="#3a2a1a" stroke-width="0.3"/>
    <rect x="27" y="13" width="3" height="3" fill="#a8856a" stroke="#3a2a1a" stroke-width="0.3"/>
    <rect x="3" y="6" width="7" height="24" rx="0.3" fill="#b8956a" stroke="#3a2a1a" stroke-width="0.6"/>
    <polygon points="3,6 6.5,0 10,6" fill="#8b3a3a" stroke="#3a2a1a" stroke-width="0.4"/>
    <rect x="22" y="6" width="7" height="24" rx="0.3" fill="#b8956a" stroke="#3a2a1a" stroke-width="0.6"/>
    <polygon points="22,6 25.5,0 29,6" fill="#8b3a3a" stroke="#3a2a1a" stroke-width="0.4"/>
    <rect x="11" y="8" width="10" height="22" rx="0.3" fill="#c8a57a" stroke="#3a2a1a" stroke-width="0.6"/>
    <polygon points="11,8 16,2 21,8" fill="#8b3a3a" stroke="#3a2a1a" stroke-width="0.4"/>
    <circle cx="6.5" cy="12" r="0.8" fill="#ffd700"/>
    <circle cx="6.5" cy="18" r="0.8" fill="#ffd700"/>
    <circle cx="25.5" cy="12" r="0.8" fill="#ffd700"/>
    <circle cx="25.5" cy="18" r="0.8" fill="#ffd700"/>
    <circle cx="16" cy="12" r="1" fill="#ffd700"/>
    <path d="M13.5,30 L13.5,22 Q16,19 18.5,22 L18.5,30 Z" fill="#4a3020"/>
    <line x1="15" y1="22" x2="15" y2="30" stroke="#3a2a1a" stroke-width="0.3"/>
    <line x1="17" y1="22" x2="17" y2="30" stroke="#3a2a1a" stroke-width="0.3"/>
    <line x1="16" y1="2" x2="16" y2="-2" stroke="#5a4030" stroke-width="0.6"/>
    <path d="M16,-2 L20,-1 L16,0.5" fill="#8b3a3a"/>
  </symbol>

  <!-- POI: Scroll marker -->
  <symbol id="icon-poi" viewBox="0 0 32 32">
    <rect x="8" y="6" width="16" height="20" rx="1" fill="#d4c494" stroke="#8a7a5a" stroke-width="0.5"/>
    <ellipse cx="16" cy="6" rx="9" ry="2.5" fill="#c8b484" stroke="#8a7a5a" stroke-width="0.4"/>
    <ellipse cx="16" cy="26" rx="9" ry="2.5" fill="#c8b484" stroke="#8a7a5a" stroke-width="0.4"/>
    <line x1="11" y1="11" x2="21" y2="11" stroke="#8a7a5a" stroke-width="0.4"/>
    <line x1="11" y1="14" x2="21" y2="14" stroke="#8a7a5a" stroke-width="0.4"/>
    <line x1="11" y1="17" x2="18" y2="17" stroke="#8a7a5a" stroke-width="0.4"/>
    <line x1="11" y1="20" x2="21" y2="20" stroke="#8a7a5a" stroke-width="0.4"/>
    <circle cx="18" cy="22" r="2.5" fill="#8a3030"/>
    <circle cx="18" cy="22" r="1.5" fill="#aa4040"/>
    <path d="M17,21.5 L18,20.5 L19,21.5 L18.5,22.5 L17.5,22.5 Z" fill="#8a3030"/>
  </symbol>

  <!-- PORTAL: Glowing archway -->
  <symbol id="icon-portal" viewBox="0 0 32 32">
    <path d="M6,30 L6,10 Q6,2 16,2 Q26,2 26,10 L26,30" fill="none" stroke="#6a6a7a" stroke-width="3"/>
    <path d="M6,30 L6,10 Q6,2 16,2 Q26,2 26,10 L26,30" fill="none" stroke="#8a8a9a" stroke-width="1.5"/>
    <path d="M9,30 L9,12 Q9,5 16,5 Q23,5 23,12 L23,30 Z" fill="url(#portalGrad)" opacity="0.7"/>
    <circle cx="8" cy="16" r="1" fill="#7a4a9a" opacity="0.6"/>
    <circle cx="8" cy="22" r="1" fill="#7a4a9a" opacity="0.6"/>
    <circle cx="24" cy="16" r="1" fill="#7a4a9a" opacity="0.6"/>
    <circle cx="24" cy="22" r="1" fill="#7a4a9a" opacity="0.6"/>
    <circle cx="14" cy="12" r="0.5" fill="#aa8aee" opacity="0.8"/>
    <circle cx="18" cy="18" r="0.5" fill="#8a9aee" opacity="0.7"/>
    <circle cx="16" cy="24" r="0.5" fill="#aa8aee" opacity="0.6"/>
    <polygon points="14,3 16,0.5 18,3" fill="#8a8a9a" stroke="#5a5a6a" stroke-width="0.3"/>
  </symbol>

  <linearGradient id="portalGrad" x1="0" y1="0" x2="0" y2="1">
    <stop offset="0%" stop-color="#7a4a9a" stop-opacity="0.8"/>
    <stop offset="50%" stop-color="#5a5aaa" stop-opacity="0.6"/>
    <stop offset="100%" stop-color="#4a6a9a" stop-opacity="0.4"/>
  </linearGradient>

  <!-- OCEAN: Waves -->
  <symbol id="icon-ocean" viewBox="0 0 32 32">
    <rect x="0" y="8" width="32" height="24" rx="2" fill="#3a6a8a" opacity="0.6"/>
    <path d="M0,12 Q4,8 8,12 Q12,16 16,12 Q20,8 24,12 Q28,16 32,12" fill="none" stroke="#4a7a9a" stroke-width="1.5"/>
    <path d="M0,18 Q4,14 8,18 Q12,22 16,18 Q20,14 24,18 Q28,22 32,18" fill="none" stroke="#5a8aaa" stroke-width="1.2"/>
    <path d="M0,24 Q4,20 8,24 Q12,28 16,24 Q20,20 24,24 Q28,28 32,24" fill="none" stroke="#4a7a9a" stroke-width="1"/>
    <path d="M2,11 Q4,9 6,11" fill="none" stroke="#e8e8e8" stroke-width="0.5" opacity="0.5"/>
    <path d="M14,11 Q16,9 18,11" fill="none" stroke="#e8e8e8" stroke-width="0.5" opacity="0.5"/>
    <path d="M26,11 Q28,9 30,11" fill="none" stroke="#e8e8e8" stroke-width="0.5" opacity="0.5"/>
    <circle cx="10" cy="16" r="0.4" fill="#e8e8e8" opacity="0.4"/>
    <circle cx="22" cy="22" r="0.4" fill="#e8e8e8" opacity="0.4"/>
  </symbol>

  <!-- LAKE: Calm water -->
  <symbol id="icon-lake" viewBox="0 0 32 32">
    <ellipse cx="16" cy="18" rx="14" ry="10" fill="#4a7a9a" opacity="0.6"/>
    <ellipse cx="16" cy="18" rx="12" ry="8" fill="#5a8aaa" opacity="0.4"/>
    <ellipse cx="16" cy="16" rx="6" ry="2" fill="none" stroke="#6a9aba" stroke-width="0.4" opacity="0.5"/>
    <ellipse cx="16" cy="18" rx="9" ry="3" fill="none" stroke="#6a9aba" stroke-width="0.3" opacity="0.4"/>
    <ellipse cx="16" cy="20" rx="11" ry="4" fill="none" stroke="#6a9aba" stroke-width="0.3" opacity="0.3"/>
    <path d="M4,22 Q8,26 16,28 Q24,26 28,22" fill="none" stroke="#7a8a5a" stroke-width="0.5" opacity="0.4"/>
  </symbol>

  <!-- FACTION: Banner/flag -->
  <symbol id="icon-faction" viewBox="0 0 32 32">
    <rect x="8" y="2" width="2" height="28" rx="0.5" fill="#6a4a2a" stroke="#4a3020" stroke-width="0.3"/>
    <circle cx="9" cy="2" r="1.5" fill="#c8a84a"/>
    <path d="M10,4 L26,6 L26,16 L10,14 Z" fill="#8a3030"/>
    <path d="M10,4 L26,6 L26,16 L10,14 Z" fill="none" stroke="#6a2020" stroke-width="0.4"/>
    <path d="M10,4 L26,6" stroke="#c8a84a" stroke-width="0.6"/>
    <path d="M10,14 L26,16" stroke="#c8a84a" stroke-width="0.6"/>
    <circle cx="18" cy="10" r="3" fill="#aa4040" opacity="0.6"/>
    <path d="M16.5,9 L18,7 L19.5,9 L18.5,11 L17.5,11 Z" fill="#c8a84a"/>
    <path d="M26,6 Q28,10 26,16" fill="none" stroke="#7a2020" stroke-width="0.5"/>
  </symbol>

  <!-- TAVERN: Mug/building with sign -->
  <symbol id="icon-tavern" viewBox="0 0 32 32">
    <rect x="6" y="12" width="20" height="18" rx="0.5" fill="#7a5a3a" stroke="#4a3020" stroke-width="0.5"/>
    <polygon points="4,12 16,4 28,12" fill="#5a3a2a" stroke="#3a2a1a" stroke-width="0.4"/>
    <rect x="13" y="22" width="6" height="8" rx="0.5" fill="#5a3a2a"/>
    <circle cx="17.5" cy="26" r="0.5" fill="#c8a84a"/>
    <rect x="8" y="15" width="4" height="4" rx="0.3" fill="#c8a840" opacity="0.7"/>
    <rect x="8" y="15" width="4" height="4" rx="0.3" fill="none" stroke="#5a4030" stroke-width="0.3"/>
    <line x1="10" y1="15" x2="10" y2="19" stroke="#5a4030" stroke-width="0.3"/>
    <line x1="8" y1="17" x2="12" y2="17" stroke="#5a4030" stroke-width="0.3"/>
    <rect x="20" y="15" width="4" height="4" rx="0.3" fill="#c8a840" opacity="0.7"/>
    <rect x="20" y="15" width="4" height="4" rx="0.3" fill="none" stroke="#5a4030" stroke-width="0.3"/>
    <line x1="26" y1="14" x2="30" y2="14" stroke="#5a4030" stroke-width="0.6"/>
    <rect x="27" y="14" width="5" height="4" rx="0.5" fill="#b89a6a" stroke="#5a4030" stroke-width="0.3"/>
    <path d="M28.5,15.5 L28.5,17 L30.5,17 L30.5,15.5 Z" fill="#c8a840" stroke="#8a6a2a" stroke-width="0.2"/>
    <rect x="20" y="4" width="2.5" height="8" fill="#5a3a2a"/>
    <ellipse cx="21.5" cy="3" rx="1.5" ry="1" fill="#8a8a8a" opacity="0.2"/>
    <ellipse cx="22" cy="1.5" rx="1" ry="0.7" fill="#8a8a8a" opacity="0.12"/>
  </symbol>
</defs>
</svg>

<!-- ============ MAP CONTAINER ============ -->
<div id="map-container">
  <canvas id="edge-canvas"></canvas>
  <div id="node-layer"></div>
</div>

<!-- ============ TOOLTIP ============ -->
<div id="tooltip" style="
  display:none; position:fixed; z-index:100; pointer-events:none;
  background:rgba(20,28,36,0.92); border:1px solid rgba(200,184,138,0.3);
  border-radius:6px; padding:8px 12px; max-width:260px;
  font-family:'Noto Serif SC',serif; backdrop-filter:blur(4px);
">
  <div id="tt-name" style="color:#e8dcc0; font-size:14px; font-weight:600; margin-bottom:4px;"></div>
  <div id="tt-type" style="color:#a0b890; font-size:11px; margin-bottom:5px;"></div>
  <div id="tt-summary" style="color:#b8b8a8; font-size:12px; line-height:1.5; max-height:80px; overflow:hidden;"></div>
</div>

<!-- ============ DETAIL MODAL ============ -->
<div class="detail-overlay" id="detail-overlay">
  <div class="detail-panel" id="detail-panel">
    <button class="detail-close" id="detail-close" title="ÂÖ≥Èó≠">&times;</button>
    <div class="detail-header" id="detail-header"></div>
    <div class="detail-summary" id="detail-summary"></div>
    <div class="detail-body" id="detail-body"></div>
  </div>
</div>

<!-- ============ TITLE ============ -->
<div id="map-title" style="
  position:fixed; top:8px; left:50%; transform:translateX(-50%); z-index:55;
  font-family:'Cinzel',serif; font-size:14px; font-weight:600;
  color:#c8b88a; letter-spacing:2px;
  text-shadow: 0 2px 8px rgba(0,0,0,0.8);
  pointer-events:none; white-space:nowrap;
  background: linear-gradient(180deg, rgba(15,20,28,0.7) 0%, rgba(15,20,28,0.5) 100%);
  padding: 4px 14px; border-radius: 6px; border-bottom: 1px solid rgba(200,184,138,0.15);
"></div>

<!-- ============ EDIT TOOLBAR ============ -->
<div class="edit-toolbar" id="edit-toolbar" style="display:none;">
  <button class="edit-btn" id="btn-edit-mode" onclick="toggleEditMode()">‚úèÔ∏è ÁºñËæëÊ®°Âºè</button>
  <button class="edit-btn danger" id="btn-delete-edge" onclick="toggleDeleteEdge()" style="display:none;">üóëÔ∏è Âà†Èô§ËøûÁ∫ø</button>
  <button class="edit-btn" id="btn-export" onclick="exportData()" style="display:none;">üíæ ÂØºÂá∫Êï∞ÊçÆ</button>
  <span class="edit-hint" id="edit-hint"></span>
</div>

<!-- ============ ZOOM CONTROLS ============ -->
<div id="zoom-controls" style="
  position:fixed; bottom:180px; right:16px; z-index:50;
  display:flex; flex-direction:column; gap:4px;
">
  <button onclick="zoomIn()" style="
    width:32px; height:32px; border:1px solid rgba(200,184,138,0.3);
    background:rgba(20,28,36,0.85); color:#c8b88a; font-size:16px;
    border-radius:4px; cursor:pointer; font-family:'Cinzel',serif;
    backdrop-filter:blur(4px);
  ">+</button>
  <button onclick="zoomOut()" style="
    width:32px; height:32px; border:1px solid rgba(200,184,138,0.3);
    background:rgba(20,28,36,0.85); color:#c8b88a; font-size:16px;
    border-radius:4px; cursor:pointer; font-family:'Cinzel',serif;
    backdrop-filter:blur(4px);
  ">‚àí</button>
  <button onclick="resetView()" title="ÂÆö‰ΩçÂà∞ÂΩìÂâç‰ΩçÁΩÆ" style="
    width:32px; height:32px; border:1px solid rgba(200,184,138,0.3);
    background:rgba(20,28,36,0.85); color:#00dc82; font-size:10px;
    border-radius:4px; cursor:pointer; font-family:'Cinzel',serif;
    backdrop-filter:blur(4px);
  ">‚ü≤</button>
</div>

<!-- ============ MINIMAP ============ -->
<canvas id="minimap" style="
  position:fixed; bottom:16px; right:16px; z-index:50;
  width:150px; height:120px; border:1px solid rgba(200,184,138,0.25);
  border-radius:4px; background:rgba(20,28,36,0.85);
  backdrop-filter:blur(4px);
"></canvas>

<!-- ============ LEGEND ============ -->
<div id="legend" style="
  position:fixed; bottom:16px; left:16px; z-index:50;
  background:rgba(20,28,36,0.88); border:1px solid rgba(200,184,138,0.2);
  border-radius:6px; padding:10px 12px; max-height:calc(100vh - 80px);
  overflow-y:auto; backdrop-filter:blur(4px);
  font-family:'Noto Serif SC',serif;
">
  <div style="color:#c8b88a; font-size:12px; font-weight:600; letter-spacing:1px; font-family:'Cinzel',serif; cursor:pointer; display:flex; align-items:center; gap:6px; user-select:none;" onclick="var b=document.getElementById('legend-items');var a=document.getElementById('legend-arrow');if(b.style.display==='none'){b.style.display='grid';a.style.transform='rotate(0deg)';}else{b.style.display='none';a.style.transform='rotate(-90deg)';}">
    <span id="legend-arrow" style="display:inline-block;font-size:10px;transition:transform 0.2s;transform:rotate(-90deg);">‚ñº</span>
    LEGEND
  </div>
  <div id="legend-items" style="display:none; grid-template-columns:1fr 1fr; gap:4px 14px; margin-top:8px;"></div>
</div>

<!-- ============ LAYER SWITCHER ============ -->
<div id="layer-switcher" style="
  position:fixed; top:36px; left:50%; transform:translateX(-50%); z-index:55;
  display:flex; gap:2px; background:rgba(15,20,28,0.8); border:1px solid rgba(200,184,138,0.15);
  border-radius:6px; padding:2px; backdrop-filter:blur(6px);
  font-family:'Noto Serif SC',serif;
">
  <button class="layer-btn active" data-layer="0" onclick="switchLayer(0)" style="
    padding:3px 8px; border-radius:4px; font-size:10px; cursor:pointer;
    font-family:'Noto Serif SC',serif; border:1px solid transparent;
    background:rgba(200,168,80,0.25); color:#f0e4c4; transition:all 0.2s;
  ">1¬∑Ë°®Â±Ç</button>
  <button class="layer-btn" data-layer="1" onclick="switchLayer(1)" style="
    padding:3px 8px; border-radius:4px; font-size:10px; cursor:pointer;
    font-family:'Noto Serif SC',serif; border:1px solid transparent;
    background:transparent; color:#8a8a7a; transition:all 0.2s;
  ">2¬∑‰∏≠Â±Ç</button>
  <button class="layer-btn" data-layer="2" onclick="switchLayer(2)" style="
    padding:3px 8px; border-radius:4px; font-size:10px; cursor:pointer;
    font-family:'Noto Serif SC',serif; border:1px solid transparent;
    background:transparent; color:#8a8a7a; transition:all 0.2s;
  ">3¬∑Ê∑±Â±Ç</button>
</div>

<!-- ============ DATA ============ -->


<script>
// ============ DATA CONFIG ============
// Â§öÂ±ÇÂú∞ÂõæÈÖçÁΩÆ
// CDN_URL ÁïôÁ©∫Âàô‰ΩøÁî®Êú¨Âú∞ map-data.js / map-data-layer2.js
const LAYER_CONFIGS = [
  { cdnUrl: 'https://cdn.jsdelivr.net/gh/tangquanghuy/dnf@main/map-data.js', localVar: 'MAP_JSON_DATA',   label: 'Á¨¨‰∏ÄÂ±Ç ¬∑ Ë°®Â±ÇÁïå' },
  { cdnUrl: 'https://cdn.jsdelivr.net/gh/tangquanghuy/dnf@main/map-data-layer2.js', localVar: 'MAP_JSON_DATA_L2', label: 'Á¨¨‰∫åÂ±Ç ¬∑ ‰∏≠Â±ÇÁïå' },
  { cdnUrl: 'https://cdn.jsdelivr.net/gh/tangquanghuy/dnf@main/map-data-layer3.js', localVar: 'MAP_JSON_DATA_L3', label: 'Á¨¨‰∏âÂ±Ç ¬∑ Ê∑±Â±ÇÁïå' },
];

let currentLayerIndex = 0;
let layerDataCache = []; // ÁºìÂ≠òÂ∑≤Âä†ËΩΩÁöÑÂ±ÇÊï∞ÊçÆ

async function loadLayerData(layerIdx) {
  if (layerDataCache[layerIdx]) return layerDataCache[layerIdx];
  const cfg = LAYER_CONFIGS[layerIdx];
  // 1. ‰ºòÂÖà‰ªé CDN fetch
  if (cfg.cdnUrl) {
    try {
      const resp = await fetch(cfg.cdnUrl);
      if (resp.ok) {
        const text = await resp.text();
        // JS Êñá‰ª∂Ê†ºÂºè: var XXX = {...}; ÊèêÂèñ JSON ÈÉ®ÂàÜ
        const match = text.match(/=\s*(\{[\s\S]*\})\s*;?\s*$/);
        if (match) {
          const json = JSON.parse(match[1]);
          if (json && json.mapData) { layerDataCache[layerIdx] = json; return json; }
        }
      }
    } catch (e) {
      console.warn(`CDN Âä†ËΩΩÂ±Ç${layerIdx + 1}Â§±Ë¥•:`, e.message);
    }
  }
  // 2. Fallback Âà∞Êú¨Âú∞ script Ê†áÁ≠æÂä†ËΩΩÁöÑÂÖ®Â±ÄÂèòÈáè
  const localData = window[cfg.localVar];
  if (localData && localData.mapData) { layerDataCache[layerIdx] = localData; return localData; }
  return null;
}

// Â±ÇÁ∫ßËÉåÊôØ‰∏ªÈ¢ò
const LAYER_THEMES = [
  // Á¨¨‰∏ÄÂ±ÇÔºöËá™ÁÑ∂Ê∑±Ê∏ä
  'linear-gradient(135deg, #2b3a4a 0%, #1e2d3d 40%, #1a2535 100%)',
  // Á¨¨‰∫åÂ±ÇÔºöÂ∑•‰∏öÈí¢ÈìÅ
  'linear-gradient(135deg, #2a2535 0%, #1e1a2d 40%, #1a1525 100%)',
  // Á¨¨‰∏âÂ±ÇÔºöÂ≤©ÊµÜÈ≠îÁïå
  'linear-gradient(135deg, #3a1a1a 0%, #2d1515 40%, #251010 100%)',
];

(async function init() {
const MAP_DATA = await loadLayerData(0);
if (!MAP_DATA) {
  document.body.innerHTML = '<div style="color:#c8b88a;font-size:20px;text-align:center;margin-top:40vh;">Êï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•ÔºöËØ∑ÈÖçÁΩÆ CDN_URL ÊàñÁ°Æ‰øù map-data.js Â≠òÂú®</div>';
  return;
}

let mapData = MAP_DATA.mapData;
let nodes = mapData.nodes;
let edges = mapData.edges || [];

// ============ SET TITLE ============
document.getElementById('map-title').textContent = mapData.title || 'Ê∑±Ê∏äÈÉΩÂ∏Ç ¬∑ ABYSS METROPOLIS';

// ============ TYPE CONFIG ============
const typeConfig = {
  city:       { size: 64, label: 'Â§ßÂüéÂ∏Ç', labelSize: 20, bold: true },
  castle:     { size: 60, label: 'ÂüéÂ†°', labelSize: 19, bold: true },
  temple:     { size: 54, label: 'Á•ûÊÆø', labelSize: 18, bold: false },
  port:       { size: 50, label: 'Ê∏ØÂè£', labelSize: 17, bold: false },
  shop:       { size: 48, label: 'ÂïÜÈì∫', labelSize: 17, bold: false },
  dungeon:    { size: 52, label: 'Âú∞‰∏ãÂüé', labelSize: 18, bold: false },
  tower:      { size: 50, label: 'Â°îÊ•º', labelSize: 17, bold: false },
  mine:       { size: 48, label: 'ÁüøËÑâ', labelSize: 17, bold: false },
  ruins:      { size: 50, label: 'ÈÅóËøπ', labelSize: 17, bold: false },
  village:    { size: 46, label: 'ÊùëÂ∫Ñ', labelSize: 17, bold: false },
  town:       { size: 50, label: 'ÂüéÈïá', labelSize: 17, bold: false },
  camp:       { size: 46, label: 'Ëê•Âú∞', labelSize: 17, bold: false },
  waystation: { size: 44, label: 'È©øÁ´ô', labelSize: 16, bold: false },
  forest:     { size: 48, label: 'Ê£ÆÊûó', labelSize: 17, bold: false },
  mountain:   { size: 52, label: 'Â±±ËÑâ', labelSize: 17, bold: false },
  wilderness: { size: 46, label: 'ËçíÈáé', labelSize: 17, bold: false },
  swamp:      { size: 46, label: 'Ê≤ºÊ≥Ω', labelSize: 17, bold: false },
  plains:     { size: 46, label: 'Âπ≥Âéü', labelSize: 17, bold: false },
  cemetery:   { size: 46, label: 'Â¢ìÂú∞', labelSize: 17, bold: false },
  desert:     { size: 48, label: 'ËçíÊº†', labelSize: 17, bold: false },
  portal:     { size: 50, label: '‰º†ÈÄÅÈó®', labelSize: 17, bold: false },
  ocean:      { size: 50, label: 'Êµ∑Ê¥ã', labelSize: 17, bold: false },
  lake:       { size: 46, label: 'ÊπñÊ≥ä', labelSize: 17, bold: false },
  faction:    { size: 48, label: 'ÂäøÂäõ', labelSize: 17, bold: false },
  tavern:     { size: 46, label: 'ÈÖíÈ¶Ü', labelSize: 17, bold: false },
  poi:        { size: 46, label: 'ÂÖ¥Ë∂£ÁÇπ', labelSize: 17, bold: false },
};

// ============ FIELD LABELS (English key -> Chinese label) ============
const FIELD_LABELS = {
  originalReference: 'ÂéüÂßãÂèÇËÄÉ',
  tier: 'Â±ÇÁ∫ßÂå∫Âüü',
  nature: 'Âú∞ÁÇπÊÄßË¥®',
  newLandscape: 'Êñ∞Âú∞Ë≤åÊèèËø∞',
  monsters: 'ÊÄ™Áâ©',
  residentFactions: 'È©ªÁïôÂäøÂäõ',
  populationComposition: '‰∫∫Âè£ÊûÑÊàê',
  security: 'Ê≤ªÂÆâ',
  economy: 'ÁªèÊµé',
  NPC: 'NPC',
  keyNPCs: 'ÂÖ≥ÈîÆNPC',
  npcAndFunction: 'NPC‰∏éÂäüËÉΩ',
  function: 'ÂäüËÉΩ',
  specialFunction: 'ÁâπÊÆäÂäüËÉΩ',
  environmentFeatures: 'ÁéØÂ¢ÉÁâπÂæÅ',
  environmentalHazards: 'ÁéØÂ¢ÉÂç±ÂÆ≥',
  dangerLevel: 'Âç±Èô©Á≠âÁ∫ß',
  ecology: 'ÁîüÊÄÅ',
  danger: 'Âç±Èô©',
  operation: 'ËøêËê•',
  militaryPower: 'ÂÜõ‰∫ãÂäõÈáè',
  politicalStance: 'ÊîøÊ≤ªÁ´ãÂú∫',
  apostleProjection: '‰ΩøÂæíÊäïÂΩ±',
  clearSignificance: 'ÈÄöÂÖ≥ÊÑè‰πâ',
  special: 'ÁâπÊÆä',
  settlement: 'ËÅöËêΩ',
  settlementFunction: 'ËÅöËêΩÂäüËÉΩ',
  ecologicalChain: 'ÁîüÊÄÅÈìæ',
  civilizationImpact: 'ÊñáÊòéÂΩ±Âìç',
  relationWithSixteenRaces: '‰∏éÂçÅÂÖ≠ÁßçÊóèÂÖ≥Á≥ª',
};

const PHYSICAL_LABELS = {
  terrain: 'Âú∞ÂΩ¢',
  lighting: 'ÂÖâÁÖß',
  gravity: 'ÈáçÂäõ',
  temperaturePressure: 'Ê∏©Â∫¶‰∏éÊ∞îÂéã',
  hydrology: 'Ê∞¥Êñá',
};

// Fields to skip in detail modal
const SKIP_FIELDS = new Set([
  'id', 'name', 'type', 'x', 'y', 'discovered', 'secrets', 'detailMap',
  'summary', 'physicalConsequences', 'encounters', 'loot'
]);

// ============ STATE ============
const SPREAD = 2.0;
let viewX = 0, viewY = 0, scale = 0.95;
let isDragging = false, dragStartX = 0, dragStartY = 0, dragViewX = 0, dragViewY = 0;
let clickStartX = 0, clickStartY = 0;
let nodeMap = {};
nodes.forEach(n => { nodeMap[n.id] = n; });

// Edit mode state
let editMode = false;
let deleteEdgeMode = false;
let nodeDragging = null;
let nodeDragStartX = 0, nodeDragStartY = 0;
let nodeOrigX = 0, nodeOrigY = 0;
let deletedEdges = []; // track deleted edges for undo

// ============ DOM REFS ============
const container = document.getElementById('map-container');
const canvas = document.getElementById('edge-canvas');
const ctx = canvas.getContext('2d');
const nodeLayer = document.getElementById('node-layer');
const tooltip = document.getElementById('tooltip');
const minimap = document.getElementById('minimap');
const minimapCtx = minimap.getContext('2d');
const detailOverlay = document.getElementById('detail-overlay');
const detailPanel = document.getElementById('detail-panel');
const detailHeader = document.getElementById('detail-header');
const detailSummary = document.getElementById('detail-summary');
const detailBody = document.getElementById('detail-body');
const detailClose = document.getElementById('detail-close');

// ============ COORDINATE HELPERS ============
function worldToScreen(wx, wy) {
  const cx = window.innerWidth / 2;
  const cy = window.innerHeight / 2;
  return {
    x: cx + (wx * SPREAD + viewX) * scale,
    y: cy + (wy * SPREAD + viewY) * scale
  };
}

// ============ RESIZE ============
function resizeCanvas() {
  const dpr = devicePixelRatio || 1;
  canvas.width = window.innerWidth * dpr;
  canvas.height = window.innerHeight * dpr;
  canvas.style.width = window.innerWidth + 'px';
  canvas.style.height = window.innerHeight + 'px';
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  minimap.width = 150 * dpr;
  minimap.height = 120 * dpr;
  render();
}
window.addEventListener('resize', resizeCanvas);

// ============ RENDER EDGES ============
function renderEdges() {
  ctx.clearRect(0, 0, window.innerWidth, window.innerHeight);
  ctx.save();
  ctx.strokeStyle = 'rgba(180,164,130,0.55)';
  ctx.lineWidth = 2.2 * scale;
  ctx.setLineDash([8 * scale, 5 * scale]);
  ctx.lineCap = 'round';

  edges.forEach(e => {
    const src = nodeMap[e.source];
    const tgt = nodeMap[e.target];
    if (!src || !tgt) return;
    const s = worldToScreen(src.x, src.y);
    const t = worldToScreen(tgt.x, tgt.y);
    ctx.beginPath();
    ctx.moveTo(s.x, s.y);
    ctx.lineTo(t.x, t.y);
    ctx.stroke();
  });
  ctx.restore();

  // Edge labels ‚Äî avoid overlapping with node positions
  ctx.save();
  const labelFontSize = Math.max(11, 12 * scale);
  ctx.font = `500 ${labelFontSize}px 'Noto Serif SC', serif`;
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';

  // Collect node screen rects for collision detection
  const nodeRects = [];
  nodes.forEach(n => {
    const p = worldToScreen(n.x, n.y);
    const cfg = typeConfig[n.type] || typeConfig.poi;
    const hw = (cfg.size * 0.5 + 40) * Math.min(1.2, Math.max(0.5, scale));
    const hh = (cfg.size * 0.5 + 16) * Math.min(1.2, Math.max(0.5, scale));
    nodeRects.push({ x: p.x - hw, y: p.y - hh, w: hw * 2, h: hh * 2 });
  });

  function rectsOverlap(ax, ay, aw, ah, bx, by, bw, bh) {
    return ax < bx + bw && ax + aw > bx && ay < by + bh && ay + ah > by;
  }

  edges.forEach(e => {
    const src = nodeMap[e.source];
    const tgt = nodeMap[e.target];
    if (!src || !tgt) return;
    const s = worldToScreen(src.x, src.y);
    const t = worldToScreen(tgt.x, tgt.y);
    let mx = (s.x + t.x) / 2;
    let my = (s.y + t.y) / 2;
    if (scale < 0.45) return;
    const text = e.label || '';
    if (!text) return;
    const tw = ctx.measureText(text).width;
    const ph = Math.max(16, 18 * scale);
    const pw = tw + 16;

    // Check overlap with any node and nudge if needed
    const dx = t.x - s.x;
    const dy = t.y - s.y;
    const len = Math.sqrt(dx * dx + dy * dy) || 1;
    // Perpendicular direction
    const nx = -dy / len;
    const ny = dx / len;
    const nudgeStep = 18;
    for (let attempt = 0; attempt < 6; attempt++) {
      let overlaps = false;
      for (const nr of nodeRects) {
        if (rectsOverlap(mx - pw/2, my - ph/2, pw, ph, nr.x, nr.y, nr.w, nr.h)) {
          overlaps = true;
          break;
        }
      }
      if (!overlaps) break;
      // Alternate nudge direction: perpendicular, then along edge
      if (attempt % 2 === 0) {
        mx += nx * nudgeStep;
        my += ny * nudgeStep;
      } else {
        mx -= nx * nudgeStep * 2;
        my -= ny * nudgeStep * 2;
      }
    }

    ctx.fillStyle = 'rgba(12,18,28,0.88)';
    ctx.beginPath();
    ctx.roundRect(mx - pw/2, my - ph/2, pw, ph, 4);
    ctx.fill();
    ctx.strokeStyle = 'rgba(138,122,90,0.25)';
    ctx.lineWidth = 0.6;
    ctx.setLineDash([]);
    ctx.stroke();
    ctx.fillStyle = '#c8b890';
    ctx.fillText(text, mx, my);
  });
  ctx.restore();
}

// ============ RENDER NODES ============
let nodeElements = [];
function createNodeElements() {
  nodeLayer.innerHTML = '';
  nodeElements = [];
  nodes.forEach(n => {
    const cfg = typeConfig[n.type] || typeConfig.poi;
    const wrapper = document.createElement('div');
    wrapper.className = 'node-wrapper';
    wrapper.dataset.id = n.id;
    if (n.type === 'city' || n.type === 'castle') wrapper.dataset.tier = 'major';

    const iconSize = cfg.size;
    const iconDiv = document.createElement('div');
    iconDiv.className = 'node-icon';
    iconDiv.innerHTML = `<svg width="${iconSize}" height="${iconSize}" viewBox="0 0 32 32"><use href="#icon-${n.type}"/></svg>`;

    const label = document.createElement('div');
    label.className = 'node-label';
    label.style.fontSize = cfg.labelSize + 'px';
    if (cfg.bold) label.style.fontWeight = '600';
    label.textContent = n.name;

    wrapper.appendChild(iconDiv);
    wrapper.appendChild(label);

    // ============ SPECIAL MARKERS ============
    const LAYER2_ENTRANCES = ['airship_dock', 'sky_sea'];
    const WORLDSCAR_ENTRANCES = ['abyss_port'];
    const LAYER1_RETURN = ['mogadishu_start']; // Á¨¨‰∫åÂ±ÇËøîÂõûÁ¨¨‰∏ÄÂ±ÇÁöÑÂÖ•Âè£
    const LAYER3_ENTRANCES = ['kronos_island']; // Á¨¨‰∫åÂ±ÇÈÄöÂæÄÁ¨¨‰∏âÂ±ÇÁöÑÂÖ•Âè£
    const LAYER2_RETURN = ['scorched_outpost']; // Á¨¨‰∏âÂ±ÇËøîÂõûÁ¨¨‰∫åÂ±ÇÁöÑÂÖ•Âè£

    if (currentLayerIndex === 0 && LAYER2_ENTRANCES.includes(n.id)) {
      const markerBg = document.createElement('div');
      markerBg.className = 'special-marker-layer2';
      markerBg.style.cssText = 'width:100%;height:100%;position:absolute;top:0;left:0;';
      wrapper.insertBefore(markerBg, iconDiv);
      const badge = document.createElement('div');
      badge.className = 'special-badge-layer2';
      badge.textContent = '‚ñº Á¨¨‰∫åÂ±Ç ¬∑ Â§©ÁïåÂÖ•Âè£';
      wrapper.appendChild(badge);
    }

    if (currentLayerIndex === 0 && WORLDSCAR_ENTRANCES.includes(n.id)) {
      const markerBg = document.createElement('div');
      markerBg.className = 'special-marker-worldscar';
      markerBg.style.cssText = 'width:100%;height:100%;position:absolute;top:0;left:0;';
      wrapper.insertBefore(markerBg, iconDiv);
      const badge = document.createElement('div');
      badge.className = 'special-badge-worldscar';
      badge.textContent = '‚óÜ Ëµ∑ÁÇπ ¬∑ ‰∏ñÁïå‰πãÁóï ¬∑ Ê∑±Ê∏äÂÖ•Âè£';
      wrapper.appendChild(badge);
    }

    // Á¨¨‰∫åÂ±ÇÂú∞Âõæ‰∏≠ËøîÂõûÁ¨¨‰∏ÄÂ±ÇÁöÑÂÖ•Âè£Ê†áËÆ∞
    if (currentLayerIndex === 1 && LAYER1_RETURN.includes(n.id)) {
      const markerBg = document.createElement('div');
      markerBg.className = 'special-marker-worldscar';
      markerBg.style.cssText = 'width:100%;height:100%;position:absolute;top:0;left:0;';
      wrapper.insertBefore(markerBg, iconDiv);
      const badge = document.createElement('div');
      badge.className = 'special-badge-worldscar';
      badge.textContent = '‚ñ≤ ËøîÂõûÁ¨¨‰∏ÄÂ±Ç ¬∑ Ë°®Â±ÇÁïå';
      wrapper.appendChild(badge);
    }

    // Á¨¨‰∫åÂ±ÇÂú∞Âõæ‰∏≠ÈÄöÂæÄÁ¨¨‰∏âÂ±ÇÁöÑÂÖ•Âè£Ê†áËÆ∞
    if (currentLayerIndex === 1 && LAYER3_ENTRANCES.includes(n.id)) {
      const markerBg = document.createElement('div');
      markerBg.className = 'special-marker-layer3';
      markerBg.style.cssText = 'width:100%;height:100%;position:absolute;top:0;left:0;';
      wrapper.insertBefore(markerBg, iconDiv);
      const badge = document.createElement('div');
      badge.className = 'special-badge-layer3';
      badge.textContent = '‚ñº Á¨¨‰∏âÂ±Ç ¬∑ Ê∑±Â±ÇÁïåÂÖ•Âè£';
      wrapper.appendChild(badge);
    }

    // Á¨¨‰∏âÂ±ÇÂú∞Âõæ‰∏≠ËøîÂõûÁ¨¨‰∫åÂ±ÇÁöÑÂÖ•Âè£Ê†áËÆ∞
    if (currentLayerIndex === 2 && LAYER2_RETURN.includes(n.id)) {
      const markerBg = document.createElement('div');
      markerBg.className = 'special-marker-worldscar';
      markerBg.style.cssText = 'width:100%;height:100%;position:absolute;top:0;left:0;';
      wrapper.insertBefore(markerBg, iconDiv);
      const badge = document.createElement('div');
      badge.className = 'special-badge-worldscar';
      badge.textContent = '‚ñ≤ ËøîÂõûÁ¨¨‰∫åÂ±Ç ¬∑ ÁªèÂØÇÈùôÂüé';
      wrapper.appendChild(badge);
    }

    // Tooltip events
    wrapper.addEventListener('mouseenter', () => {
      tooltip.style.display = 'block';
      document.getElementById('tt-name').textContent = n.name;
      document.getElementById('tt-type').textContent = cfg.label;
      document.getElementById('tt-summary').textContent = (n.summary || '').replace(/\n/g, ' ').substring(0, 120);
    });
    wrapper.addEventListener('mousemove', (ev) => {
      tooltip.style.left = (ev.clientX + 14) + 'px';
      tooltip.style.top = (ev.clientY + 14) + 'px';
      const tr = tooltip.getBoundingClientRect();
      if (tr.right > window.innerWidth - 8) tooltip.style.left = (ev.clientX - tr.width - 10) + 'px';
      if (tr.bottom > window.innerHeight - 8) tooltip.style.top = (ev.clientY - tr.height - 10) + 'px';
    });
    wrapper.addEventListener('mouseleave', () => {
      tooltip.style.display = 'none';
    });

    // Click to open detail OR drag node in edit mode
    wrapper.addEventListener('mousedown', (ev) => {
      clickStartX = ev.clientX;
      clickStartY = ev.clientY;
      if (editMode) {
        ev.stopPropagation();
        nodeDragging = n;
        nodeDragStartX = ev.clientX;
        nodeDragStartY = ev.clientY;
        nodeOrigX = n.x;
        nodeOrigY = n.y;
      }
    });
    wrapper.addEventListener('mouseup', (ev) => {
      const dx = Math.abs(ev.clientX - clickStartX);
      const dy = Math.abs(ev.clientY - clickStartY);
      if (nodeDragging === n) {
        nodeDragging = null;
        if (dx < 5 && dy < 5) return; // was just a click, no drag
        return; // finished dragging
      }
      if (dx < 5 && dy < 5 && !editMode) {
        tooltip.style.display = 'none';
        openDetail(n);
      }
    });

    nodeLayer.appendChild(wrapper);
    nodeElements.push({ el: wrapper, node: n });
  });
}

function updateNodePositions() {
  nodeElements.forEach(({ el, node }) => {
    const pos = worldToScreen(node.x, node.y);
    el.style.left = pos.x + 'px';
    el.style.top = pos.y + 'px';
    el.style.transform = `translate(-50%,-50%) scale(${Math.min(1.2, Math.max(0.5, scale))})`;
    const lbl = el.querySelector('.node-label');
    if (lbl) lbl.style.opacity = scale < 0.35 ? '0' : scale < 0.55 ? '0.6' : '1';
  });
}

// ============ DETAIL MODAL ============
function openDetail(node) {
  const cfg = typeConfig[node.type] || typeConfig.poi;
  const iconSize = 36;

  // Header: icon + name + type badge
  detailHeader.innerHTML = `
    <div class="detail-title">
      <svg width="${iconSize}" height="${iconSize}" viewBox="0 0 32 32"><use href="#icon-${node.type}"/></svg>
      <span>${escHtml(node.name)}</span>
    </div>
    <div style="margin-top:6px;">
      <span class="detail-type-badge">${cfg.label}</span>
      ${node.tier ? `<span class="detail-type-badge" style="margin-left:6px; background:rgba(138,122,90,0.12);">${escHtml(node.tier)}</span>` : ''}
    </div>
  `;

  // Summary
  if (node.summary && node.summary.trim()) {
    detailSummary.textContent = node.summary;
    detailSummary.style.display = '';
  } else {
    detailSummary.style.display = 'none';
  }

  // Body
  let bodyHtml = '';

  // Physical Consequences grid
  if (node.physicalConsequences && typeof node.physicalConsequences === 'object') {
    const pc = node.physicalConsequences;
    // ËøáÊª§Á©∫ÂÄºÂíåÊó†ÊÑè‰πâÂç†‰ΩçÊñáÊú¨
    const TRIVIAL_RE = /^(Âõ†.*ËÄåÂºÇ|Ê≠£Â∏∏|ÂÄíÁΩÆ|Êó†$|Êó†Ê∞¥|Êó†Ê∞¥Ê∫ê|N\/A|Êú™Áü•|ÂæÖÂÆö)/;
    const entries = Object.entries(pc).filter(([k, v]) => {
      if (!v) return false;
      const s = String(v).trim();
      if (!s) return false;
      if (TRIVIAL_RE.test(s)) return false;
      // Èùû terrain Â≠óÊÆµÔºöËøá‰∫éÁÆÄÁü≠ÁöÑÂÄºÔºà<=4Â≠óÔºâÊ≤°Êúâ‰ø°ÊÅØÈáè
      if (k !== 'terrain' && s.length <= 4) return false;
      return true;
    });
    if (entries.length > 0) {
      bodyHtml += `<div class="detail-section">
        <div class="detail-section-title">Áâ©ÁêÜÁéØÂ¢É</div>
        <div class="detail-grid">`;
      entries.forEach(([key, val]) => {
        const label = PHYSICAL_LABELS[key] || key;
        bodyHtml += `<div class="detail-grid-item">
          <div class="grid-label">${escHtml(label)}</div>
          <div class="grid-value">${escHtml(String(val))}</div>
        </div>`;
      });
      bodyHtml += `</div></div>`;
    }
  }

  // All other fields
  for (const [key, val] of Object.entries(node)) {
    if (SKIP_FIELDS.has(key)) continue;
    if (key === 'tier') continue; // already shown in header
    if (!FIELD_LABELS[key]) continue; // unknown field, skip
    if (val === null || val === undefined) continue;

    // Check emptiness
    if (Array.isArray(val)) {
      if (val.length === 0) continue;
      // Render as tags
      bodyHtml += `<div class="detail-section">
        <div class="detail-section-title">${escHtml(FIELD_LABELS[key])}</div>
        <div class="detail-tags">`;
      val.forEach(item => {
        bodyHtml += `<span class="detail-tag">${escHtml(String(item))}</span>`;
      });
      bodyHtml += `</div></div>`;
    } else if (typeof val === 'object') {
      // Skip objects (physicalConsequences already handled)
      continue;
    } else {
      const strVal = String(val).trim();
      if (!strVal) continue;
      bodyHtml += `<div class="detail-section">
        <div class="detail-section-title">${escHtml(FIELD_LABELS[key])}</div>
        <div class="detail-section-content">${escHtml(strVal)}</div>
      </div>`;
    }
  }

  // Connected locations
  const connections = [];
  edges.forEach(e => {
    if (e.source === node.id && nodeMap[e.target]) {
      connections.push({ node: nodeMap[e.target], label: e.label, distance: e.distance });
    } else if (e.target === node.id && nodeMap[e.source]) {
      connections.push({ node: nodeMap[e.source], label: e.label, distance: e.distance });
    }
  });
  if (connections.length > 0) {
    bodyHtml += `<div class="detail-connections">
      <div class="detail-section-title">ËøûÊé•Âú∞ÁÇπ</div>
      <div style="display:flex; flex-wrap:wrap;">`;
    connections.forEach(c => {
      const cCfg = typeConfig[c.node.type] || typeConfig.poi;
      bodyHtml += `<div class="detail-conn-item" data-target-id="${c.node.id}">
        <svg width="16" height="16" viewBox="0 0 32 32" style="flex-shrink:0;"><use href="#icon-${c.node.type}"/></svg>
        <span>${escHtml(c.node.name)}</span>
        ${c.label ? `<span class="detail-conn-dist">¬∑ ${escHtml(c.label)}</span>` : ''}
        ${c.distance ? `<span class="detail-conn-dist">(${escHtml(String(c.distance))})</span>` : ''}
      </div>`;
    });
    bodyHtml += `</div></div>`;
  }

  detailBody.innerHTML = bodyHtml;

  // Make connection items clickable
  detailBody.querySelectorAll('.detail-conn-item').forEach(el => {
    el.addEventListener('click', () => {
      const targetId = el.dataset.targetId;
      const targetNode = nodeMap[targetId];
      if (targetNode) openDetail(targetNode);
    });
  });

  // Show modal
  detailOverlay.classList.add('active');
  detailPanel.scrollTop = 0;
}

function escHtml(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

// Close detail modal
detailClose.addEventListener('click', () => {
  detailOverlay.classList.remove('active');
});
detailOverlay.addEventListener('click', (e) => {
  if (e.target === detailOverlay) detailOverlay.classList.remove('active');
});
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') detailOverlay.classList.remove('active');
});

// ============ MINIMAP ============
function renderMinimap() {
  const dpr = devicePixelRatio;
  const mw = 150 * dpr, mh = 120 * dpr;
  minimapCtx.clearRect(0, 0, mw, mh);

  let minX = Infinity, maxX = -Infinity, minY = Infinity, maxY = -Infinity;
  nodes.forEach(n => {
    const wx = n.x * SPREAD, wy = n.y * SPREAD;
    if (wx < minX) minX = wx; if (wx > maxX) maxX = wx;
    if (wy < minY) minY = wy; if (wy > maxY) maxY = wy;
  });
  const pad = 100;
  minX -= pad; maxX += pad; minY -= pad; maxY += pad;
  const rangeX = maxX - minX, rangeY = maxY - minY;
  const mScale = Math.min(mw / rangeX, mh / rangeY) * 0.9;
  const offX = (mw - rangeX * mScale) / 2;
  const offY = (mh - rangeY * mScale) / 2;

  function miniPos(wx, wy) {
    return { x: offX + (wx - minX) * mScale, y: offY + (wy - minY) * mScale };
  }

  // Edges
  minimapCtx.strokeStyle = 'rgba(138,122,90,0.25)';
  minimapCtx.lineWidth = 0.5 * dpr;
  minimapCtx.setLineDash([]);
  edges.forEach(e => {
    const src = nodeMap[e.source], tgt = nodeMap[e.target];
    if (!src || !tgt) return;
    const s = miniPos(src.x * SPREAD, src.y * SPREAD);
    const t = miniPos(tgt.x * SPREAD, tgt.y * SPREAD);
    minimapCtx.beginPath();
    minimapCtx.moveTo(s.x, s.y);
    minimapCtx.lineTo(t.x, t.y);
    minimapCtx.stroke();
  });

  // Nodes
  const LAYER2_IDS = new Set(['airship_dock', 'sky_sea']);
  const WORLDSCAR_IDS = new Set(['abyss_port']);
  const LAYER1_RETURN_IDS = new Set(['mogadishu_start']);
  const LAYER3_IDS = new Set(['kronos_island']);
  const LAYER2_RETURN_IDS = new Set(['scorched_outpost']);
  nodes.forEach(n => {
    const p = miniPos(n.x * SPREAD, n.y * SPREAD);
    if (currentLayerIndex === 0 && LAYER2_IDS.has(n.id)) {
      minimapCtx.fillStyle = '#5ac8ff';
      minimapCtx.beginPath();
      minimapCtx.arc(p.x, p.y, 3.5 * dpr, 0, Math.PI * 2);
      minimapCtx.fill();
    } else if (currentLayerIndex === 0 && WORLDSCAR_IDS.has(n.id)) {
      minimapCtx.fillStyle = '#ffaa32';
      minimapCtx.beginPath();
      minimapCtx.arc(p.x, p.y, 3.5 * dpr, 0, Math.PI * 2);
      minimapCtx.fill();
    } else if (currentLayerIndex === 1 && LAYER1_RETURN_IDS.has(n.id)) {
      minimapCtx.fillStyle = '#ffaa32';
      minimapCtx.beginPath();
      minimapCtx.arc(p.x, p.y, 3.5 * dpr, 0, Math.PI * 2);
      minimapCtx.fill();
    } else if (currentLayerIndex === 1 && LAYER3_IDS.has(n.id)) {
      minimapCtx.fillStyle = '#c084fc';
      minimapCtx.beginPath();
      minimapCtx.arc(p.x, p.y, 3.5 * dpr, 0, Math.PI * 2);
      minimapCtx.fill();
    } else if (currentLayerIndex === 2 && LAYER2_RETURN_IDS.has(n.id)) {
      minimapCtx.fillStyle = '#ffaa32';
      minimapCtx.beginPath();
      minimapCtx.arc(p.x, p.y, 3.5 * dpr, 0, Math.PI * 2);
      minimapCtx.fill();
    } else {
      minimapCtx.fillStyle = n.type === 'city' || n.type === 'castle' ? '#c8b88a' : 'rgba(200,184,138,0.5)';
      minimapCtx.beginPath();
      minimapCtx.arc(p.x, p.y, (n.type === 'city' || n.type === 'castle' ? 2.5 : 1.5) * dpr, 0, Math.PI * 2);
      minimapCtx.fill();
    }
  });

  // Viewport rect
  const cx = window.innerWidth / 2, cy = window.innerHeight / 2;
  const vpLeft = (-viewX - cx / scale), vpTop = (-viewY - cy / scale);
  const vpRight = (-viewX + cx / scale), vpBottom = (-viewY + cy / scale);
  const tl = miniPos(vpLeft, vpTop);
  const br = miniPos(vpRight, vpBottom);
  minimapCtx.strokeStyle = 'rgba(200,184,138,0.5)';
  minimapCtx.lineWidth = 1 * dpr;
  minimapCtx.setLineDash([]);
  minimapCtx.strokeRect(tl.x, tl.y, br.x - tl.x, br.y - tl.y);
}

// ============ LEGEND ============
function buildLegend() {
  const legendItems = document.getElementById('legend-items');
  const usedTypes = new Set(nodes.map(n => n.type));
  Object.keys(typeConfig).forEach(type => {
    if (!usedTypes.has(type)) return;
    const cfg = typeConfig[type];
    const item = document.createElement('div');
    item.style.cssText = 'display:flex; align-items:center; gap:4px; padding:1px 0;';
    item.innerHTML = `
      <svg width="18" height="18" viewBox="0 0 32 32" style="flex-shrink:0; filter:drop-shadow(0 1px 1px rgba(0,0,0,0.4));"><use href="#icon-${type}"/></svg>
      <span style="font-size:11px; color:#c0b090; white-space:nowrap;">${cfg.label}</span>
    `;
    legendItems.appendChild(item);
  });

  // Special marker legends
  const specialSep = document.createElement('div');
  specialSep.style.cssText = 'grid-column:1/-1; border-top:1px solid rgba(200,184,138,0.15); margin:4px 0 2px; padding-top:4px; font-size:11px; color:#c8b88a; font-weight:600; letter-spacing:0.5px;';
  specialSep.textContent = 'ÁâπÊÆäÊ†áËÆ∞';
  legendItems.appendChild(specialSep);

  if (currentLayerIndex === 0) {
    const layer2Legend = document.createElement('div');
    layer2Legend.style.cssText = 'display:flex; align-items:center; gap:4px; padding:1px 0;';
    layer2Legend.innerHTML = `
      <span style="display:inline-block;width:14px;height:14px;border-radius:50%;border:2px dashed rgba(80,160,255,0.6);flex-shrink:0;"></span>
      <span style="font-size:11px; color:#5ac8ff; white-space:nowrap;">Á¨¨‰∫åÂ±ÇÂÖ•Âè£</span>
    `;
    legendItems.appendChild(layer2Legend);

    const worldscarLegend = document.createElement('div');
    worldscarLegend.style.cssText = 'display:flex; align-items:center; gap:4px; padding:1px 0;';
    worldscarLegend.innerHTML = `
      <span style="display:inline-block;width:14px;height:14px;border-radius:50%;border:2px solid rgba(255,170,50,0.6);flex-shrink:0;"></span>
      <span style="font-size:11px; color:#ffaa32; white-space:nowrap;">‰∏ñÁïå‰πãÁóï</span>
    `;
    legendItems.appendChild(worldscarLegend);
  } else if (currentLayerIndex === 1) {
    const returnLegend = document.createElement('div');
    returnLegend.style.cssText = 'display:flex; align-items:center; gap:4px; padding:1px 0;';
    returnLegend.innerHTML = `
      <span style="display:inline-block;width:14px;height:14px;border-radius:50%;border:2px solid rgba(255,170,50,0.6);flex-shrink:0;"></span>
      <span style="font-size:11px; color:#ffaa32; white-space:nowrap;">ËøîÂõûÁ¨¨‰∏ÄÂ±Ç</span>
    `;
    legendItems.appendChild(returnLegend);

    const layer3Legend = document.createElement('div');
    layer3Legend.style.cssText = 'display:flex; align-items:center; gap:4px; padding:1px 0;';
    layer3Legend.innerHTML = `
      <span style="display:inline-block;width:14px;height:14px;border-radius:50%;border:2px dashed rgba(168,85,247,0.6);flex-shrink:0;"></span>
      <span style="font-size:11px; color:#c084fc; white-space:nowrap;">Á¨¨‰∏âÂ±ÇÂÖ•Âè£</span>
    `;
    legendItems.appendChild(layer3Legend);
  } else if (currentLayerIndex === 2) {
    const returnLegend = document.createElement('div');
    returnLegend.style.cssText = 'display:flex; align-items:center; gap:4px; padding:1px 0;';
    returnLegend.innerHTML = `
      <span style="display:inline-block;width:14px;height:14px;border-radius:50%;border:2px solid rgba(255,170,50,0.6);flex-shrink:0;"></span>
      <span style="font-size:11px; color:#ffaa32; white-space:nowrap;">ËøîÂõûÁ¨¨‰∫åÂ±Ç</span>
    `;
    legendItems.appendChild(returnLegend);
  }

  // Áé©ÂÆ∂‰ΩçÁΩÆÂõæ‰æã
  const playerLegend = document.createElement('div');
  playerLegend.style.cssText = 'display:flex; align-items:center; gap:4px; padding:1px 0;';
  playerLegend.innerHTML = `
    <span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:#00dc82;box-shadow:0 0 6px rgba(0,220,130,0.6);flex-shrink:0;margin:0 2px;"></span>
    <span style="font-size:11px; color:#00dc82; white-space:nowrap;">ÂΩìÂâç‰ΩçÁΩÆ</span>
  `;
  legendItems.appendChild(playerLegend);
}

// ============ MAIN RENDER ============
function render() {
  renderEdges();
  updateNodePositions();
  renderMinimap();
  if (editMode && deleteEdgeMode) updateEdgeHitAreas();
}

// ============ PAN ============
container.addEventListener('mousedown', (e) => {
  if (e.target.closest('.node-wrapper')) return;
  isDragging = true;
  dragStartX = e.clientX;
  dragStartY = e.clientY;
  dragViewX = viewX;
  dragViewY = viewY;
  container.classList.add('grabbing');
});
window.addEventListener('mousemove', (e) => {
  // Node dragging in edit mode
  if (nodeDragging) {
    const dx = (e.clientX - nodeDragStartX) / scale / SPREAD;
    const dy = (e.clientY - nodeDragStartY) / scale / SPREAD;
    nodeDragging.x = nodeOrigX + dx;
    nodeDragging.y = nodeOrigY + dy;
    render();
    return;
  }
  if (!isDragging) return;
  viewX = dragViewX + (e.clientX - dragStartX) / scale;
  viewY = dragViewY + (e.clientY - dragStartY) / scale;
  render();
});
window.addEventListener('mouseup', () => {
  if (nodeDragging) { nodeDragging = null; return; }
  isDragging = false;
  container.classList.remove('grabbing');
});

// ============ ZOOM ============
container.addEventListener('wheel', (e) => {
  e.preventDefault();
  const zoomFactor = e.deltaY < 0 ? 1.1 : 0.9;
  const cx = window.innerWidth / 2;
  const cy = window.innerHeight / 2;
  const wx = (e.clientX - cx) / scale - viewX;
  const wy = (e.clientY - cy) / scale - viewY;
  scale *= zoomFactor;
  scale = Math.max(0.15, Math.min(3, scale));
  viewX = (e.clientX - cx) / scale - wx;
  viewY = (e.clientY - cy) / scale - wy;
  render();
}, { passive: false });

function zoomIn() { scale = Math.min(3, scale * 1.2); render(); }
function zoomOut() { scale = Math.max(0.15, scale / 1.2); render(); }
function resetView() {
  if (lastMatchedNodeId && nodeMap[lastMatchedNodeId]) {
    const n = nodeMap[lastMatchedNodeId];
    viewX = -n.x * SPREAD;
    viewY = -n.y * SPREAD;
  } else {
    viewX = 0; viewY = 0;
  }
  scale = 0.95; render();
}
window.zoomIn = zoomIn; window.zoomOut = zoomOut; window.resetView = resetView;

// ============ TOUCH SUPPORT ============
let lastTouchDist = 0;
let lastTouchCenter = null;
container.addEventListener('touchstart', (e) => {
  if (e.touches.length === 1) {
    isDragging = true;
    dragStartX = e.touches[0].clientX;
    dragStartY = e.touches[0].clientY;
    dragViewX = viewX;
    dragViewY = viewY;
  } else if (e.touches.length === 2) {
    isDragging = false;
    const dx = e.touches[0].clientX - e.touches[1].clientX;
    const dy = e.touches[0].clientY - e.touches[1].clientY;
    lastTouchDist = Math.sqrt(dx * dx + dy * dy);
    lastTouchCenter = {
      x: (e.touches[0].clientX + e.touches[1].clientX) / 2,
      y: (e.touches[0].clientY + e.touches[1].clientY) / 2
    };
  }
}, { passive: true });
container.addEventListener('touchmove', (e) => {
  e.preventDefault();
  if (e.touches.length === 1 && isDragging) {
    viewX = dragViewX + (e.touches[0].clientX - dragStartX) / scale;
    viewY = dragViewY + (e.touches[0].clientY - dragStartY) / scale;
    render();
  } else if (e.touches.length === 2) {
    const dx = e.touches[0].clientX - e.touches[1].clientX;
    const dy = e.touches[0].clientY - e.touches[1].clientY;
    const dist = Math.sqrt(dx * dx + dy * dy);
    if (lastTouchDist > 0) {
      const zoomFactor = dist / lastTouchDist;
      const cx = window.innerWidth / 2;
      const cy = window.innerHeight / 2;
      const tcx = (e.touches[0].clientX + e.touches[1].clientX) / 2;
      const tcy = (e.touches[0].clientY + e.touches[1].clientY) / 2;
      const wx = (tcx - cx) / scale - viewX;
      const wy = (tcy - cy) / scale - viewY;
      scale *= zoomFactor;
      scale = Math.max(0.15, Math.min(3, scale));
      viewX = (tcx - cx) / scale - wx;
      viewY = (tcy - cy) / scale - wy;
      render();
    }
    lastTouchDist = dist;
  }
}, { passive: false });
container.addEventListener('touchend', () => {
  isDragging = false;
  lastTouchDist = 0;
  lastTouchCenter = null;
});

// ============ EDIT MODE ============
function toggleEditMode() {
  editMode = !editMode;
  deleteEdgeMode = false;
  const btn = document.getElementById('btn-edit-mode');
  const btnDel = document.getElementById('btn-delete-edge');
  const btnExp = document.getElementById('btn-export');
  const hint = document.getElementById('edit-hint');
  btn.classList.toggle('active', editMode);
  btnDel.style.display = editMode ? '' : 'none';
  btnExp.style.display = editMode ? '' : 'none';
  btnDel.classList.remove('active');
  hint.textContent = editMode ? 'ÊãñÊãΩËäÇÁÇπË∞ÉÊï¥‰ΩçÁΩÆ' : '';
  // Toggle node cursor
  nodeElements.forEach(({ el }) => {
    el.classList.toggle('editing', editMode);
  });
  updateEdgeHitAreas();
}

function toggleDeleteEdge() {
  deleteEdgeMode = !deleteEdgeMode;
  const btn = document.getElementById('btn-delete-edge');
  const hint = document.getElementById('edit-hint');
  btn.classList.toggle('active', deleteEdgeMode);
  hint.textContent = deleteEdgeMode ? 'ÁÇπÂáªËøûÁ∫ø‰∏≠Èó¥ÁöÑ √ó Âà†Èô§' : 'ÊãñÊãΩËäÇÁÇπË∞ÉÊï¥‰ΩçÁΩÆ';
  updateEdgeHitAreas();
}

// Edge delete hit areas
let edgeHitLayer = null;
function updateEdgeHitAreas() {
  if (!edgeHitLayer) {
    edgeHitLayer = document.createElement('div');
    edgeHitLayer.id = 'edge-hit-layer';
    edgeHitLayer.style.cssText = 'position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:3;';
    container.appendChild(edgeHitLayer);
  }
  edgeHitLayer.innerHTML = '';
  if (!editMode || !deleteEdgeMode) return;

  edges.forEach((e, idx) => {
    const src = nodeMap[e.source];
    const tgt = nodeMap[e.target];
    if (!src || !tgt) return;
    const s = worldToScreen(src.x, src.y);
    const t = worldToScreen(tgt.x, tgt.y);
    const mx = (s.x + t.x) / 2;
    const my = (s.y + t.y) / 2;

    const btn = document.createElement('div');
    btn.className = 'edge-delete-hit';
    btn.style.cssText = `
      left:${mx - 12}px; top:${my - 12}px; width:24px; height:24px;
      background:rgba(180,50,50,0.8); border-radius:50%; pointer-events:auto;
      display:flex; align-items:center; justify-content:center;
      font-size:14px; color:#fff; cursor:pointer; border:1px solid rgba(255,100,100,0.5);
    `;
    btn.textContent = '√ó';
    btn.title = `Âà†Èô§: ${e.label || e.source + ' ‚Üí ' + e.target}`;
    btn.addEventListener('click', (ev) => {
      ev.stopPropagation();
      deletedEdges.push(edges.splice(idx, 1)[0]);
      render();
      updateEdgeHitAreas();
    });
    edgeHitLayer.appendChild(btn);
  });
}

// Re-render hit areas on pan/zoom is handled in render()

function exportData() {
  // Build updated JSON
  const exportObj = JSON.parse(JSON.stringify(MAP_DATA.mapData ? MAP_DATA : { mapData: MAP_DATA.mapData }));
  // Update node positions
  const expMapData = exportObj.mapData || exportObj;
  expMapData.nodes = nodes.map(n => {
    const copy = {};
    for (const [k, v] of Object.entries(n)) {
      copy[k] = v;
    }
    // Round coordinates
    copy.x = Math.round(n.x * 100) / 100;
    copy.y = Math.round(n.y * 100) / 100;
    return copy;
  });
  expMapData.edges = edges.map(e => ({ ...e }));

  const jsonStr = JSON.stringify(exportObj, null, 2);
  const blob = new Blob([jsonStr], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `Á¨¨${currentLayerIndex + 1}Â±ÇÂú∞Âõæ_edited.json`;
  a.click();
  URL.revokeObjectURL(url);

  document.getElementById('edit-hint').textContent = 'Â∑≤ÂØºÂá∫ Á¨¨‰∏ÄÂ±ÇÂú∞Âõæ_edited.json';
  setTimeout(() => {
    if (editMode) document.getElementById('edit-hint').textContent = 'ÊãñÊãΩËäÇÁÇπË∞ÉÊï¥‰ΩçÁΩÆ';
  }, 3000);
}

window.toggleEditMode = toggleEditMode;
window.toggleDeleteEdge = toggleDeleteEdge;
window.exportData = exportData;

// ============ LAYER SWITCHING ============
async function switchLayer(layerIdx) {
  if (layerIdx === currentLayerIndex) return;
  const data = await loadLayerData(layerIdx);
  if (!data) {
    alert('ËØ•Â±ÇÊï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Á°Æ‰øùÂØπÂ∫îÁöÑ map-data Êñá‰ª∂Â≠òÂú®');
    return;
  }
  currentLayerIndex = layerIdx;
  mapData = data.mapData;
  nodes = mapData.nodes;
  edges = mapData.edges || [];
  nodeMap = {};
  nodes.forEach(n => { nodeMap[n.id] = n; });

  // Êõ¥Êñ∞Ê†áÈ¢ò
  document.getElementById('map-title').textContent = mapData.title || 'Ê∑±Ê∏äÈÉΩÂ∏Ç ¬∑ ABYSS METROPOLIS';

  // Êõ¥Êñ∞ËÉåÊôØ‰∏ªÈ¢ò
  document.body.style.background = LAYER_THEMES[layerIdx] || LAYER_THEMES[0];

  // Êõ¥Êñ∞Â±ÇÁ∫ßÊåâÈíÆÊ†∑Âºè
  document.querySelectorAll('#layer-switcher .layer-btn').forEach(btn => {
    const idx = parseInt(btn.dataset.layer);
    if (idx === layerIdx) {
      btn.style.background = 'rgba(200,168,80,0.25)';
      btn.style.color = '#f0e4c4';
      btn.classList.add('active');
    } else {
      btn.style.background = 'transparent';
      btn.style.color = '#8a8a7a';
      btn.classList.remove('active');
    }
  });

  // ÈÄÄÂá∫ÁºñËæëÊ®°Âºè
  if (editMode) toggleEditMode();

  // ÈáçÁΩÆËßÜÂõæ
  viewX = 0; viewY = 0; scale = 0.95;

  // ÈáçÂª∫ËäÇÁÇπÂíåÂõæ‰æã
  createNodeElements();
  // ÈáçÂª∫Âõæ‰æã
  const legendItems = document.getElementById('legend-items');
  legendItems.innerHTML = '';
  buildLegend();

  // ÈáçÂª∫Áé©ÂÆ∂‰ΩçÁΩÆÊ†áËÆ∞ÔºàÂõ†‰∏∫ nodeLayer Ë¢´Ê∏ÖÁ©∫‰∫ÜÔºâ
  playerMarkerEl = null;
  createPlayerMarker();
  updatePlayerLocation();

  render();
}
window.switchLayer = switchLayer;

// ============ MVU Êé•ÂÖ•Â±Ç ‚Äî Áé©ÂÆ∂‰ΩçÁΩÆÊ†áËÆ∞ (ÂêåÂ∫ïÈÉ®Áä∂ÊÄÅÊ†è) ============
// map.html ÂµåÂ•óÂú®Â∫ïÈÉ®Áä∂ÊÄÅÊ†è iframe ÂÜÖÔºåÈúÄË¶ÅÂêë‰∏äÊü•ÊâæÂà∞ SillyTavern ‰∏ªÁ™óÂè£
const getCore = () => {
  try {
    // ÈÄêÁ∫ßÂêë‰∏äÊü•ÊâæÂåÖÂê´ Mvu ÁöÑÁ™óÂè£
    let win = window;
    for (let i = 0; i < 5; i++) {
      try {
        if (win.Mvu && typeof win.Mvu.getMvuData === 'function') return { window: win };
        if (win.parent && win.parent !== win) { win = win.parent; } else break;
      } catch (e) { break; } // Ë∑®ÂüüÂàôÂÅúÊ≠¢
    }
    return { window: win };
  } catch (e) {
    return { window: window };
  }
};

const mvuState = {
  ready: false, mvu: null,
  check: () => {
    try {
      const win = getCore().window;
      if (typeof win.Mvu === 'undefined' || typeof win.Mvu.getMvuData !== 'function') {
        mvuState.ready = false; mvuState.mvu = null; return false;
      }
      mvuState.ready = true; mvuState.mvu = win.Mvu; return true;
    } catch (e) {
      mvuState.ready = false; mvuState.mvu = null; return false;
    }
  }
};

const fetchLatestMvuData = () => {
  let finalData = {};
  try {
    if (mvuState.ready || mvuState.check()) {
      const mvuData = mvuState.mvu.getMvuData({ type: 'message', message_id: 'latest' });
      if (mvuData?.stat_data && Object.keys(mvuData.stat_data).length > 0) {
        finalData = mvuData.stat_data;
      } else {
        const chatData = mvuState.mvu.getMvuData({ type: 'chat' });
        if (chatData?.stat_data && Object.keys(chatData.stat_data).length > 0) finalData = chatData.stat_data;
      }
    }
  } catch (e) { console.warn('[Âú∞Âõæ] MVU fetch error:', e); }
  return finalData;
};

// Áé©ÂÆ∂‰ΩçÁΩÆÊ†áËÆ∞ÂÖÉÁ¥†
let playerMarkerEl = null;
let lastMatchedNodeId = null;

function createPlayerMarker() {
  if (playerMarkerEl) return;
  playerMarkerEl = document.createElement('div');
  playerMarkerEl.className = 'player-marker';
  playerMarkerEl.innerHTML = `
    <div class="player-marker-ring"></div>
    <div class="player-marker-ping"></div>
    <div class="player-marker-dot"></div>
    <div class="player-marker-label">üìç ÂΩìÂâç‰ΩçÁΩÆ</div>
  `;
  playerMarkerEl.style.display = 'none';
  nodeLayer.appendChild(playerMarkerEl);
}

function normalizeStr(s) {
  // Áªü‰∏ÄÂÖ®ËßíÂçäËßí„ÄÅÂéªÈô§Á©∫Ê†ºÔºå‰æø‰∫éÊ®°Á≥äÂåπÈÖç
  return s.replace(/\s+/g, '').replace(/¬∑/g, '¬∑').replace(/\./g, '¬∑').replace(/„Éª/g, '¬∑').replace(/‚Äß/g, '¬∑').toLowerCase();
}

function findMatchingNode(Âú∫ÊâÄ, Âå∫Âüü, Â§ßÈôÜ) {
  // ‰ºòÂÖàÁ≤æÁ°ÆÂåπÈÖçÂú∫ÊâÄ ‚Üí Âå∫Âüü ‚Üí Â§ßÈôÜ
  const candidates = [Âú∫ÊâÄ, Âå∫Âüü, Â§ßÈôÜ].filter(Boolean);
  for (const locName of candidates) {
    // Á≤æÁ°ÆÂåπÈÖç node.name
    const exact = nodes.find(n => n.name === locName);
    if (exact) return exact;
  }
  // ÂΩí‰∏ÄÂåñÂåπÈÖç
  for (const locName of candidates) {
    if (!locName) continue;
    const norm = normalizeStr(locName);
    const match = nodes.find(n => normalizeStr(n.name) === norm);
    if (match) return match;
  }
  // Ê®°Á≥äÂåπÈÖçÔºönode.name ÂåÖÂê´‰ΩçÁΩÆÂêç Êàñ ‰ΩçÁΩÆÂêçÂåÖÂê´ node.name
  for (const locName of candidates) {
    if (!locName || locName.length < 2) continue;
    const norm = normalizeStr(locName);
    const fuzzy = nodes.find(n => {
      const nn = normalizeStr(n.name);
      return nn.includes(norm) || norm.includes(nn);
    });
    if (fuzzy) return fuzzy;
  }
  // ÂàÜÊÆµÂåπÈÖçÔºöÁî® ¬∑ ÂàÜÂâ≤ÂêéÈÄêÊÆµÂåπÈÖç
  for (const locName of candidates) {
    if (!locName) continue;
    const parts = locName.split(/[¬∑„Éª‚Äß.\s]+/).filter(p => p.length >= 2);
    for (const part of parts) {
      const normPart = normalizeStr(part);
      const match = nodes.find(n => {
        const nn = normalizeStr(n.name);
        return nn.includes(normPart) || normPart.includes(nn);
      });
      if (match) return match;
    }
  }
  return null;
}

function updatePlayerLocation() {
  const data = fetchLatestMvuData();
  const ‰∏ñÁïå‰ø°ÊÅØ = data.‰∏ñÁïå‰ø°ÊÅØ || {};
  const ‰ΩçÁΩÆ = ‰∏ñÁïå‰ø°ÊÅØ.‰ΩçÁΩÆ || {};
  const Âú∫ÊâÄ = ‰ΩçÁΩÆ.Âú∫ÊâÄ || '';
  const Âå∫Âüü = ‰ΩçÁΩÆ.Âå∫Âüü || '';
  const Â§ßÈôÜ = ‰ΩçÁΩÆ.Â§ßÈôÜ || '';

  if (!Âú∫ÊâÄ && !Âå∫Âüü && !Â§ßÈôÜ) {
    console.log('[Âú∞Âõæ] MVU ‰ΩçÁΩÆÊï∞ÊçÆ‰∏∫Á©∫Ôºådata keys:', Object.keys(data));
    if (playerMarkerEl) playerMarkerEl.style.display = 'none';
    lastMatchedNodeId = null;
    return;
  }
  console.log('[Âú∞Âõæ] MVU ‰ΩçÁΩÆ:', { Â§ßÈôÜ, Âå∫Âüü, Âú∫ÊâÄ });

  // Ê†πÊçÆÂ§ßÈôÜ/Â±ÇÁ∫ßÂà§Êñ≠ÂΩìÂâçÂ∫îËØ•Âú®Âì™‰∏ÄÂ±ÇÂú∞Âõæ
  // Ë°®Â±ÇÁïå/ÈòøÊãâÂæ∑Â§ßÈôÜ ‚Üí layer 0, ‰∏≠Â±ÇÁïå/Â§©Áïå ‚Üí layer 1, Ê∑±Â±ÇÁïå/È≠îÁïå ‚Üí layer 2
  const layerMap = {
    'Ë°®Â±ÇÁïå': 0, 'ÈòøÊãâÂæ∑Â§ßÈôÜ': 0, 'Á¨¨‰∏ÄÂ±Ç': 0,
    '‰∏≠Â±ÇÁïå': 1, 'Â§©Áïå': 1, 'Á¨¨‰∫åÂ±Ç': 1,
    'Ê∑±Â±ÇÁïå': 2, 'È≠îÁïå': 2, 'Á¨¨‰∏âÂ±Ç': 2,
    '‰∏ñÁïå‰πãÁóï': 0, 'Ëø™ÊñØÂçöÂæ∑': 0,
  };

  const matchedNode = findMatchingNode(Âú∫ÊâÄ, Âå∫Âüü, Â§ßÈôÜ);

  if (!matchedNode) {
    if (playerMarkerEl) playerMarkerEl.style.display = 'none';
    lastMatchedNodeId = null;
    return;
  }

  if (!playerMarkerEl) createPlayerMarker();

  // ÊòæÁ§∫‰ΩçÁΩÆÂêç
  const displayName = Âú∫ÊâÄ || Âå∫Âüü || matchedNode.name;
  const labelEl = playerMarkerEl.querySelector('.player-marker-label');
  if (labelEl) labelEl.textContent = `üìç ${displayName}`;

  lastMatchedNodeId = matchedNode.id;
  playerMarkerEl.style.display = '';

  // ‰ΩçÁΩÆÊõ¥Êñ∞Âú® render ‰∏≠Â§ÑÁêÜ
  updatePlayerMarkerPosition();
}

function updatePlayerMarkerPosition() {
  if (!playerMarkerEl || !lastMatchedNodeId) return;
  const node = nodeMap[lastMatchedNodeId];
  if (!node) { playerMarkerEl.style.display = 'none'; return; }
  const pos = worldToScreen(node.x, node.y);
  // ÂÅèÁßªÂà∞ËäÇÁÇπ‰∏äÊñπ
  const cfg = typeConfig[node.type] || typeConfig.poi;
  const offset = -(cfg.size * 0.5 + 10) * Math.min(1.2, Math.max(0.5, scale));
  playerMarkerEl.style.left = pos.x + 'px';
  playerMarkerEl.style.top = (pos.y + offset) + 'px';
  playerMarkerEl.style.transform = `translate(-50%, -50%) scale(${Math.min(1.3, Math.max(0.6, scale))})`;
}

// Âú® render ‰∏≠‰πüÊõ¥Êñ∞Áé©ÂÆ∂Ê†áËÆ∞‰ΩçÁΩÆ
const _origRender = render;
const renderWithPlayer = function() {
  _origRender();
  updatePlayerMarkerPosition();
};
// ÊõøÊç¢ÂÖ®Â±Ä render ÂºïÁî® ‚Äî ÈÄöËøáË¶ÜÁõñÊñπÂºè
// Áî±‰∫é render Âú®Â§öÂ§ÑË¢´Áõ¥Êé•Ë∞ÉÁî®ÔºåÊàë‰ª¨ hook updateNodePositions
const _origUpdateNodePositions = updateNodePositions;
const hookedUpdateNodePositions = function() {
  _origUpdateNodePositions();
  updatePlayerMarkerPosition();
};
// Áõ¥Êé•Ë¶ÜÁõñ
Object.defineProperty(window, '_mapUpdatePlayerPos', { value: updatePlayerMarkerPosition });

// Â∞Ü updatePlayerMarkerPosition Ê≥®ÂÖ•Âà∞ render ÊµÅÁ®ã
const origRenderEdges = renderEdges;
// Êàë‰ª¨Áî®‰∏Ä‰∏™ÁÆÄÂçïÁöÑÊñπÂºèÔºöÂú® requestAnimationFrame ‰∏≠ÊåÅÁª≠ÂêåÊ≠•‰ΩçÁΩÆ
let _playerPosRAF = null;
function syncPlayerMarkerLoop() {
  updatePlayerMarkerPosition();
  _playerPosRAF = requestAnimationFrame(syncPlayerMarkerLoop);
}

// ÂÆöÊó∂ËΩÆËØ¢ MVU Êï∞ÊçÆ
createPlayerMarker();
updatePlayerLocation();
setInterval(updatePlayerLocation, 3000);
syncPlayerMarkerLoop();

// ÁõëÂê¨ MVU Êï∞ÊçÆÊõ¥Êñ∞‰∫ã‰ª∂
try {
  const win = getCore().window;
  if (win.eventSource?.on) win.eventSource.on('mvu_data_updated', updatePlayerLocation);
} catch (e) { }

// Âú® minimap ‰∏≠‰πüÁªòÂà∂Áé©ÂÆ∂‰ΩçÁΩÆ
const _origRenderMinimap = renderMinimap;
renderMinimap = function() {
  _origRenderMinimap();
  if (!lastMatchedNodeId) return;
  const node = nodeMap[lastMatchedNodeId];
  if (!node) return;
  // Â§çÁî® minimap ÂùêÊ†áÁ≥ª
  const dpr = devicePixelRatio;
  const mw = 150 * dpr, mh = 120 * dpr;
  let minX = Infinity, maxX = -Infinity, minY = Infinity, maxY = -Infinity;
  nodes.forEach(n => {
    const wx = n.x * SPREAD, wy = n.y * SPREAD;
    if (wx < minX) minX = wx; if (wx > maxX) maxX = wx;
    if (wy < minY) minY = wy; if (wy > maxY) maxY = wy;
  });
  const pad = 100;
  minX -= pad; maxX += pad; minY -= pad; maxY += pad;
  const rangeX = maxX - minX, rangeY = maxY - minY;
  const mScale = Math.min(mw / rangeX, mh / rangeY) * 0.9;
  const offX = (mw - rangeX * mScale) / 2;
  const offY = (mh - rangeY * mScale) / 2;
  const px = offX + (node.x * SPREAD - minX) * mScale;
  const py = offY + (node.y * SPREAD - minY) * mScale;
  // ÁªòÂà∂ÁªøËâ≤Áé©ÂÆ∂ÁÇπ
  minimapCtx.fillStyle = '#00dc82';
  minimapCtx.beginPath();
  minimapCtx.arc(px, py, 4 * dpr, 0, Math.PI * 2);
  minimapCtx.fill();
  minimapCtx.strokeStyle = 'rgba(0,220,130,0.5)';
  minimapCtx.lineWidth = 1.5 * dpr;
  minimapCtx.beginPath();
  minimapCtx.arc(px, py, 6 * dpr, 0, Math.PI * 2);
  minimapCtx.stroke();
};

// ============ INIT ============
createNodeElements();
buildLegend();
resizeCanvas();
})(); // end async init
</script>
</body>
</html>
